<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Text Scanner — CopyCat</title>
<style>

  #demoPresetWrap{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    font-size:0.9em;
  }

 :root{
  /* Base palette – slightly more neutral / professional dark */
  --bg:      #0f1116;
  --panel:   #171a23;
  --panel-2: #12141b;
  --border:  #252837;
  --muted:   #a4abbf;
  --text:    #f4f4f7;
  --accent:  #4f86ff;
  --good:    #38b26a;
  --warn:    #f2c94c;
  --bad:     #ef6a6a;
  --scale:   1.50;

  /* Tooltip + live drawer */
  --tip-bg:    rgba(248, 251, 255, 0.96);
  --tip-border:rgba(126, 180, 255, 0.45);
  --tip-text:  #0f1630;
  --live-h:    40vh;
}

/* Theme variants (optional) */
:root[data-theme="dark-professional"] {
  /* same as base – you can omit this if base is your default */
}

/* --- LCARS (TNG-style) theme --- */
:root[data-theme="lcars"] {
  /* Background + panels */
  --bg: #000000;          /* space black */
  --panel: #050b18;       /* deep navy panel */
  --panel-2: #050b18;
  --border: #151b2b;

  /* Text */
  --text: #fdf7e3;        /* pale LCARS cream */
  --muted: #b0a8a0;

  /* Accents */
  --accent:   #f2a94f;    /* amber/orange */
  --accent-2: #f27b7b;    /* salmon */
  --accent-3: #5bb5ff;    /* light blue */
  --accent-4: #a88cf2;    /* LCARS lilac / purple */
  --good: #7bd87a;
  --warn: #ffdd5c;
  --bad:  #ff6d6d;
}

/* LCARS look tweaks */
:root[data-theme="lcars"] body {
  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
  letter-spacing: 0.03em;
}

/* Cards = flat panels with LCARS bar */
:root[data-theme="lcars"] .card {
  background: var(--panel);
  border-radius: 0;
  border: none;
  box-shadow: none;
  position: relative;
  overflow: visible;
}

:root[data-theme="lcars"] .card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  height: 10px;
  width: 40%;
  background: var(--accent);
  border-bottom-right-radius: 999px;
}

/* Buttons → LCARS pads */
:root[data-theme="lcars"] .btn {
  background: var(--accent);
  color: #120b05;
  border-radius: 999px;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.85em;
  border: none;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.7);
}

:root[data-theme="lcars"] .btn.secondary {
  background: var(--accent-2);
  color: #1a0505;
}

:root[data-theme="lcars"] .btn.ghost {
  background: transparent;
  color: var(--text);
  border-radius: 999px;
  border: 1px solid var(--accent-3);
}

/* Pills (mode badge etc.) */
:root[data-theme="lcars"] .pill {
  background: var(--accent-2);
  border-radius: 999px;
  border: none;
  color: #1a0505;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.8em;
}

/* Progress bar strip */
:root[data-theme="lcars"] .progress {
  background: #3a405a;
  border-radius: 0;
}
:root[data-theme="lcars"] .progress > span {
  background: var(--accent-3);
}

/* Tabs */
:root[data-theme="lcars"] .live-tabs {
  border-radius: 999px;
  border: none;
  background: #15192b;
}
:root[data-theme="lcars"] .live-tab {
  border-radius: 999px;
  text-transform: uppercase;
  font-size: 0.8em;
}
:root[data-theme="lcars"] .live-tab.active {
  background: var(--accent);
  color: #120b05;
}


/* unified html/body + layout shell */
html, body {
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  font-size:calc(16px * var(--scale));
  line-height:1.55;
}

/* main shell fills the window */
body{
  min-height:100vh;
  display:flex;
}

/* outer container */
.wrap{
  flex:1;
  width:98vw;
  max-width:var(--wrap-max);
  margin:22px auto;
  padding:16px 16px 24px;
  box-sizing:border-box;
}


#liveResizeHandle{
  height:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:ns-resize;
}
#liveResizeHandle::before{
  content:"";
  width:46px;
  height:4px;
  border-radius:999px;
  background:rgba(255,255,255,.25);
}
  
.grid{display:grid;gap:18px}
.cols{
  grid-template-columns: minmax(0,1.25fr) minmax(0,1fr);
  align-items:stretch;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
  overflow:visible;
  height:100%;          /* cards fill the column height */
}

/* Scope to the advanced block only */
#advMetricsBox {
  margin-top: 18px;
}

/* Advanced metric cards: a little more breathing room */
#advMetricsBox .card {
  padding: 10px 12px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid rgba(255, 255, 255, 0.06);
}

/* Card titles (“Stylometry”, “Nonsense guard”, etc) */
#advMetricsBox .card > .muted {
  font-size: 0.85rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  margin-bottom: 6px;
}

/* Tighter, more readable metric rows in Advanced only */
#advMetricsBox .kv {
  font-size: 0.85rem;
  row-gap: 2px;
}

/* Labels a bit softer than the values */
#advMetricsBox .kv > div:nth-child(odd) {
  opacity: 0.8;
}

/* Light separators between metric rows (skip very first row) */
#advMetricsBox .kv > div:nth-child(odd):not(:first-child) {
  border-top: 1px solid rgba(255, 255, 255, 0.05);
  padding-top: 4px;
  margin-top: 2px;
}


  @media (max-width:1100px){ .cols{grid-template-columns:1fr} }

    /* Live drawer layout polish */
  #liveDrawer .split {
    align-items: flex-start;
  }

  /* Give a bit of breathing room between left + right columns */
  #liveDrawer .split > div:first-child {
    padding-right: 8px;
  }
  #liveDrawer .split > div:last-child {
    padding-left: 8px;
  }

  /* Slightly tighter spacing under the metrics row */
  #liveResult {
    margin-top: 8px;
  }

  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap; overflow:visible}
  .right{text-align:right}
  label{color:var(--muted)}
  input[type="text"], input[type="number"], select, textarea{
    width: 100%;
    background: var(--panel-2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    min-height: 42px;
    font-size: 1em;
  }




  textarea{min-height:360px;resize:vertical}
  .btn{background:var(--accent);border:none;color:#091120;padding:11px 16px;border-radius:10px;font-weight:700;cursor:pointer;min-height:42px}

/* Make form fields fit neatly inside their containers */
input[type="text"],
input[type="number"],
select,
textarea {
  box-sizing: border-box;
}


  .btn.secondary{
    background: var(--panel-2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn.ghost{
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
  }
 
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

  .pill{
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--panel-2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .bar{
    height: 22px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel-2);
    position: relative;
  }
  
  .bar>.fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:12px}
  .fill.good{background:var(--good)} .fill.warn{background:var(--warn)} .fill.bad{background:var(--bad)}
  .kv{display:grid;grid-template-columns: 1fr auto;gap:8px 16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
  th{color:var(--muted)}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .footer{margin-top:14px;color:var(--muted);font-size:.95em}

.drawer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  background:var(--panel-2);
  border-top:1px solid var(--border);
  transform:translateY(100%);
  transition:transform .25s ease;
  z-index:50;

  /* NEW: fixed height & flex so inner content fits */
  height:var(--live-h);
  display:flex;
  align-items:stretch;
}

.drawer.open{ transform:translateY(0); }

.drawer-inner{
  max-width:var(--wrap-max);
  width:98vw;
  margin:0 auto;
  padding:10px 18px 18px;

  /* NEW: let content scroll inside drawer instead of growing it */
  max-height:100%;
  overflow:auto;
}


    /* Live drawer layout */
  .split{
    display:grid;
    grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
    gap:18px;
    align-items:flex-start;
  }
  @media (max-width:1024px){
    .split{grid-template-columns: 1fr}
  }

  .live-left textarea{
    min-height:140px;
    max-height:220px;
  }

  .live-metrics-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:6px;
  }

  .live-tabs{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    border:1px solid var(--border);
    overflow:hidden;
    font-size:.85em;
    white-space:nowrap;
  }
  .live-tab{
    background:transparent;
    border:none;
    color:var(--muted);
    padding:4px 10px;
    cursor:pointer;
  }
  .live-tab.active{
    background:#1a2346;
    color:#eaf0ff;
  }

  .progress{
    height: 10px;
    border-radius: 6px;
    background: var(--panel-2);
    overflow: hidden;
  }

  .progress>span{
    display: block;
    height: 100%;
    width: 0;
    background: var(--accent);
    transition: width .25s;
  }

/* Optional: hide the hint on very small screens */
@media (max-width: 700px) {
  #btnLive::after {
    content: '';
  }
}


 .scale-wrap{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

  input[type="range"]{accent-color:#7eb4ff}

  /* ---- HELP DOT + BALLOON ---- */
  .help-wrap{display:inline-flex; align-items:center; gap:8px; overflow:visible}
  .help-dot{
    position:relative; display:inline-flex; align-items:center; justify-content:center;
    width:1.4em; height:1.4em; min-width:1.4em; min-height:1.4em;
    border:1.5px solid var(--border); border-radius:999px; color:#cfe0ff; background:#10162a;
    font-weight:800; line-height:1; user-select:none; cursor:help; overflow:visible;
  }

  #explainWrap{
  margin-top:.5rem;
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
  background:var(--panel-2);
  color:var(--text);
}

#explainHeader{
  display:flex; justify-content:space-between; align-items:center;
  padding:.65rem .9rem;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}

#explainToggleBtn{
  all:unset;
  cursor:pointer;
  padding:.25rem .55rem;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:.9rem;
  color:var(--text);
}

  .help-dot::after{ content:"?"; font-size:.9em; transform:translateY(-1px); }

  /* balloon defaults (RIGHT side) */
  .help-dot > .tip{
    position:absolute; inset:auto auto auto 100%;
    transform:translate(10px,-50%); top:50%;
    min-width:240px; max-width:360px;
    background:var(--tip-bg); color:#eaf0ff;
    border:1px solid var(--tip-border); border-radius:12px; padding:10px 12px;
    font-size:.95em; line-height:1.4; box-shadow:0 18px 40px rgba(0,0,0,.55);
    z-index:9999; white-space:normal; word-break:normal; overflow-wrap:anywhere;
    opacity:0; visibility:hidden; pointer-events:none;
    transition:opacity .14s ease, transform .14s ease, visibility .14s;
    backface-visibility:hidden;
  }
  .help-dot::before{
    content:""; position:absolute; left:100%; top:50%; transform:translate(2px,-50%) rotate(90deg);
    border:7px solid transparent; border-top-color:var(--tip-border);
    filter:drop-shadow(0 2px 0 rgba(0,0,0,.22));
    opacity:0; visibility:hidden; transition:opacity .14s ease, transform .14s ease, visibility .14s;
    z-index:10000;
  }

  /* show states */
  .help-dot:hover > .tip,
  .help-dot:focus-visible > .tip,
  .help-dot[data-open="1"] > .tip{
    opacity:1; visibility:visible; transform:translate(10px,-50%) scale(1);
    pointer-events:auto;
  }
  .help-dot:hover::before,
  .help-dot:focus-visible::before,
  .help-dot[data-open="1"]::before{
    opacity:1; visibility:visible;
  }

  /* When a right-edge dot has class="help-dot tip-l", open bubble to the LEFT */
.tip-l.help-dot:hover > .tip,
.tip-l.help-dot:focus-visible > .tip,
.tip-l.help-dot[data-open="1"] > .tip{
  transform: translate(-10px,-50%) scale(1);  /* flip to the left */
}

/* Arrow for left-opening variant */
.tip-l.help-dot:hover::before,
.tip-l.help-dot:focus-visible::before,
.tip-l.help-dot[data-open="1"]::before{
  transform: translate(-2px,-50%) rotate(-90deg);
}


  /* top/bottom variants if you ever need them */
  .tip-t.help-dot > .tip{ inset:auto auto 100% 0; transform:translate(0,-10px); top:auto; left:0; }
  .tip-t.help-dot::before{ left:16px; top:auto; bottom:100%; transform:translateY(-2px) rotate(0deg); }
  /* ---- LEFT-SIDE TOOLTIP VARIANT ---- */
/* For help dots near the right edge: class="help-dot tip-l" */

.tip-l.help-dot > .tip{
  /* Position bubble to the LEFT of the dot */
  inset: auto 100% auto auto;   /* right:100% */
  left: auto;
  right: 100%;
  top: 50%;
  transform: translate(-10px,-50%);
}

/* Little arrow also flips to point right -> left */
.tip-l.help-dot::before{
  left: auto;
  right: 100%;
  top: 50%;
  bottom: auto;
  transform: translate(-2px,-50%) rotate(-90deg);
}

  .tip-b.help-dot > .tip{ inset:100% auto auto 0; transform:translate(0,10px); top:auto; left:0; }
  .tip-b.help-dot::before{ left:16px; top:100%; transform:translateY(2px) rotate(180deg); }

  @media (prefers-reduced-motion: reduce){
    .help-dot > .tip, .help-dot::before, .drawer, .progress>span{ transition:none !important; }
  }

  /* Accessibility */
  button,.btn,.drawer button{font-size:1.05em;padding:12px 18px;min-height:46px;border-radius:12px}
  .btn.ghost{border-width:1.5px}
  input[type="text"],input[type="number"],select{min-height:46px;font-size:1.05em;padding:12px 14px}
  table th,table td{padding:10px 12px;font-size:1.02em}
  details>summary{font-size:1.05em;padding:6px 0;cursor:pointer}
  button:focus-visible,select:focus-visible,input:focus-visible,textarea:focus-visible{outline:3px solid #7eb4ff;outline-offset:2px}

  /* --- Light tooltip override (paste at END of <style>) --- */
.help-dot > .tip{
  background: var(--tip-bg);
  color: var(--tip-text);
  border-color: var(--tip-border);
  box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.05) inset;
  backdrop-filter: saturate(120%) blur(0.5px);
}
.help-dot::before{
  border-top-color: var(--tip-bg);
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.18));
}

  /* v0.3.5 Explain UI */
  .band-badge { display:inline-flex; align-items:center; gap:.5rem; font-weight:600; font-size:.95rem; padding:.35rem .6rem; border-radius:.6rem; border:1px solid rgba(0,0,0,.2); background:#f6f6f6; }
  .band-human{ background:#e8f7ec; border-color:#7ad58f; }
  .band-mixed{ background:#fff7e0; border-color:#e2c35c; }
  .band-ai{ background:#fde8e8; border-color:#e28b8b; }
  .badge-dot{ width:.55rem; height:.55rem; border-radius:50%; display:inline-block; }
  .dot-human{ background:#26a269; } .dot-mixed{ background:#cfae2d; } .dot-ai{ background:#c23333; }
  #explainWrap{ margin-top:.5rem; border:1px solid #2d2d2d; border-radius:10px; overflow:hidden; background:#111; color:#ddd; }
  #explainHeader{ display:flex; justify-content:space-between; align-items:center; padding:.65rem .9rem; background:#181818; border-bottom:1px solid #2d2d2d; }
  #explainTitle{ font-weight:600; }
  #explainToggleBtn{ all:unset; cursor:pointer; padding:.25rem .55rem; border:1px solid #444; border-radius:6px; font-size:.9rem; color:#ddd; }
  #explainBody{ padding:.8rem .9rem; display:block; }
  #explainBody.hidden{ display:none; }
  .explain-section{ margin:.4rem 0 .6rem; }
  .explain-section b{ color:#fff; }
  .explain-list{ margin:.35rem 0 0 .9rem; }
  .explain-note{ opacity:.85; }
  


  /* Base PD badge shape */

/* PD badge – base (dark theme) styling */
#pdBadge{
  margin-left: 8px;
  padding: 0.1rem 0.6rem;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
  border: 1px solid var(--border);
  background: #163626; /* dark PD green for dark theme */
  color: #e6ffe6;
}


/* DARK THEME LOOK (default) */
#pdBadge.pd-ok {
  background: #163626;
  color: #cafad7;
}
#pdBadge.pd-none {
  background: #2f2a12;
  color: #f4e2c0;
}

/* Stronger, more readable verdict pill */
.band-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 600;
  border: 1px solid #1f5135;
}

/* HUMAN = dark green pill, light text */
.band-badge.band-human {
  background: #123524;
  color: #e8fff4;
}

/* AI = dark red pill, light text */
.band-badge.band-ai {
  background: #3b1515;
  color: #ffecec;
}

/* MIXED / inconclusive = amber */
.band-badge.band-mixed {
  background: #2f2713;
  color: #fff4d6;
}

/* dot styles */
.band-badge .badge-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
}

.band-badge .badge-dot.dot-human  { background: #4ade80; }
.band-badge .badge-dot.dot-ai     { background: #f97373; }
.band-badge .badge-dot.dot-mixed  { background: #eab308; }


  /* Live drawer right-side spacing */
.split > div:last-child {
  padding: 8px 12px 10px;
}

/* Give the tabs and sections some breathing room */
#liveTabs {
  margin-bottom: 8px;
}

#liveResult {
  margin-top: 8px;
}

#liveDriftBox {
  margin-top: 8px;
}

/* ===== Live Verification Cat + Butterfly ===== */

/* Give the drift card its own slightly lighter scene background */
/* ===== Live Verification Cat + Butterfly ===== */

/* Give the drift card its own slightly lighter scene background */
#liveDriftBox {
  background: #141b33;
  position: relative;
  overflow: hidden;
}

#liveFunZone {
  position: relative;
  width: 100%;
  height: 220px;           /* was 140px – this fixes the “half cat” */
  margin-top: 12px;
  overflow: hidden;
  pointer-events: none;
  display: none;
  opacity: 0;
  border-radius: 12px;
  background:
    radial-gradient(circle at 20% 0%, #263566 0, #141a33 40%, #0a0d1f 100%);
  box-shadow: 0 0 18px rgba(0,0,0,0.75) inset;
  transition: opacity 0.35s ease;
}


#liveFunZone.active {
  display: block;
  opacity: 1;
}

/* Base sprite positioning */
#liveFunZone .cat,
#liveFunZone .butterfly {
  position: absolute;
}

/* ---------- CAT: sprite sheet from /static/cat-sprite.png ---------- */
/* Assumes 4x4 grid of 16 frames, each 256x256.
   If that’s different, we’ll tweak the JS frame size, not this CSS. */

/* CAT: sprite sheet + horizontal prowl */
#liveFunZone .cat {
  bottom: -8px;                                /* sit on “floor” of taller zone */
  left: 2%;
  width: 256px;
  height: 256px;
  background-image: url("/static/cat-sprite.png");
  background-repeat: no-repeat;
  image-rendering: pixelated;
  transform-origin: 50% 100%;
  z-index: 1;
}

/* Only animate when Live Fun Zone is active */
#liveFunZone.active .cat {
  animation: catProwl 10s ease-in-out infinite;
}

/* Move from left → mid-right → left while it runs its frames */
@keyframes catProwl {
  0% {
    transform: translateX(0) scale(0.80);
  }
  20% {
    transform: translateX(14vw) scale(0.80);
  }
  40% {
    transform: translateX(26vw) scale(0.80);
  }
  60% {
    transform: translateX(32vw) scale(0.80);
  }
  80% {
    transform: translateX(16vw) scale(0.80);
  }
  100% {
    transform: translateX(0) scale(0.80);
  }
}


/* “Butt wiggle / grooming / panic” body motion – sprite frames are layered on top */
@keyframes catAct {
  0%   { transform: translateX(0) translateY(0)   scale(0.7) rotate(0deg); }
  10%  { transform: translateX(-4px) translateY(3px)  scale(0.7,0.74) rotate(-3deg); }
  20%  { transform: translateX(0)   translateY(0)   scale(0.7,0.7)  rotate(2deg); }
  30%  { transform: translateX(3px) translateY(4px)  scale(0.68,0.76) rotate(-4deg); }
  40%  { transform: translateX(0)   translateY(2px)  scale(0.69,0.73) rotate(4deg); }
  55%  { transform: translateX(2px) translateY(-4px) scale(0.72)      rotate(0deg); }
  70%  { transform: translateX(6px) translateY(-2px) scale(0.71)      rotate(-2deg); }
  85%  { transform: translateX(2px) translateY(0)    scale(0.7)       rotate(1deg); }
  100% { transform: translateX(0)   translateY(0)    scale(0.7)       rotate(0deg); }
}

/* ---------- Butterflies (CSS/SVG for now; sprite file later if you want) ---------- */

#liveFunZone .butterfly {
  width: 90px;
  height: 60px;
  bottom: 60px;
  transform-origin: 50% 50%;
  z-index: 2;  /* above cat */
}

/* wings: color-cycle + glow */
#liveFunZone .butterfly-body ellipse {
  fill: #2d7ff9;  /* start blue */
  stroke: #cbe1ff;
  stroke-width: 1.3;
  filter:
    drop-shadow(0 0 4px rgba(45,127,249,0.9))
    drop-shadow(0 0 8px rgba(45,127,249,0.7));
  transform-origin: 40px 30px;
  animation: wingFlap 0.4s ease-in-out infinite,
             butterflyColor 6s linear infinite;
}

/* butterfly body + antennae */
#liveFunZone .butterfly-body rect {
  fill: #101b34;
}

#liveFunZone .butterfly-body path {
  fill: none;
  stroke: #101b34;
  stroke-width: 1.4;
}

/* Position + animation assignment for each butterfly */
#liveFunZone .butterfly.b1 { left: 18vw; animation: butterflySolo 14s linear infinite; }
#liveFunZone .butterfly.b2 { left: 20vw; animation: butterflyPair 14s linear infinite; }
#liveFunZone .butterfly.b3 { left: 23vw; animation: butterflyPair 14s linear infinite; }
#liveFunZone .butterfly.b4 { left: 26vw; animation: butterflySwarm 14s linear infinite; }

/* Butterfly color: blue → pink → orange → blue */
@keyframes butterflyColor {
  0%, 100% { fill: #2d7ff9; stroke: #cbe1ff; }
  33%      { fill: #ff6fbf; stroke: #ffd1ea; }
  66%      { fill: #ffae42; stroke: #ffe0a3; }
}

/* b1: solo, then top of triangle swarm */
@keyframes butterflySolo {
  0%   { transform: translate(2vw, 0px)  scale(1)   rotate(0deg);   opacity: 1;   }
  16%  { transform: translate(12vw,-10px) scale(1.03) rotate(-10deg);             }
  32%  { transform: translate(24vw,-6px)  scale(1.07) rotate(8deg);               }
  45%  { transform: translate(40vw,-34px) scale(0.96) rotate(18deg); opacity:.85; }
  55%  { transform: translate(56vw,-78px) scale(0.85) rotate(28deg); opacity:0;   }
  78%  { transform: translate(56vw,-26px) scale(0.9)  rotate(-10deg);opacity:0;   }
  88%  { transform: translate(30vw,-24px) scale(1)   rotate(6deg);   opacity:1;   }
  96%  { transform: translate(14vw,-22px) scale(1.02) rotate(-4deg);              }
  100% { transform: translate(8vw,-20px)  scale(1)   rotate(0deg);  opacity:1;    }
}

/* b2 / b3: chased pair, then bottom corners of triangle */
@keyframes butterflyPair {
  0%,34% { transform: translate(10vw,-10px) scale(1) rotate(0deg); opacity:0;  }
  40%    { transform: translate(16vw,-10px) scale(1.04) rotate(-8deg);opacity:1;}
  55%    { transform: translate(28vw,-16px) scale(1.07) rotate(10deg);         }
  65%    { transform: translate(44vw,-42px) scale(0.96) rotate(20deg);opacity:.85;}
  78%    { transform: translate(60vw,-76px) scale(0.86) rotate(28deg);opacity:0; }
  88%    { transform: translate(26vw,-4px)  scale(1)    rotate(4deg); opacity:1;  }
  96%    { transform: translate(10vw,-4px)  scale(1.02) rotate(-4deg);           }
  100%   { transform: translate(4vw,-4px)   scale(1)    rotate(0deg); opacity:1;  }
}

/* b4: back point of triangle only */
@keyframes butterflySwarm {
  0%,71% { transform: translate(60vw,-14px) scale(1) rotate(0deg); opacity:0; }
  80%    { transform: translate(36vw,-14px) scale(1) rotate(-4deg);opacity:1; }
  94%    { transform: translate(18vw,-14px) scale(1.02) rotate(4deg);         }
  100%   { transform: translate(8vw,-14px)  scale(1) rotate(0deg);  opacity:1; }
}

/* wings flapping */
@keyframes wingFlap {
  0%   { transform: scaleY(1);    }
  50%  { transform: scaleY(0.82); }
  100% { transform: scaleY(1);    }
}

/* === Light theme polish (CopyCat) =============================== */
/* Make both data-theme="light" and "light-paper" use the same palette */

:root[data-theme="light"],
:root[data-theme="light-paper"] {
  /* Cooler, softer light palette */
  --bg:       #f4f5fb;   /* page background behind cards */
  --panel:    #ffffff;   /* main cards */
  --panel-2:  #eef1ff;   /* secondary cards / inputs */
  --text:     #111827;   /* primary text */
  --muted:    #6b7280;   /* labels / minor text */
  --accent:   #2563eb;   /* primary blue */
  --border:   #d1d5db;   /* card border */

  /* Result + badge surfaces */
  --bar-bg:   #e5edff;   /* probability bar background */
  --pill-bg:  #e0ecff;   /* generic pill / badge background */

  /* Tooltip colors on light */
  --tip-bg:     rgba(255, 255, 255, 0.98);
  --tip-border: rgba(37, 99, 235, 0.4);
  --tip-text:   #111827;
}

/* Probability bar in "Result" */
:root[data-theme="light"] .bar,
:root[data-theme="light-paper"] .bar {
  background: var(--bar-bg);
}

/* === Donut probability gauge ==================================== */
/* Row with main donut(s) under "Calibrated probability" */
.prob-donut-row{
  display:flex;
  align-items:center;
  gap:20px;
  margin-top:8px;
  margin-bottom:4px;    /* keep content pulled up */
  flex-wrap:wrap;
}

/* Center the hero donut in the Result card */
#result .prob-donut-row {
  justify-content: center;
  margin: 10px 0 6px;
}


.prob-donut{
  position:relative;
  flex:0 0 110px;
  width:110px;
  height:110px;
}

/* rotate so 0% starts at top, grows clockwise */



/* In the main Result card, use donuts only (no horizontal bar) */
/*#result .bar{
  display:none;
}*/

/* In the Result card, keep the bar for layout, but make it invisible */
#result .bar{
  height: 0;
  margin-top: 2px;
  border: none;
  background: transparent;
  overflow: hidden;
}

/* rotate so 0% starts at top, grows clockwise */
.prob-donut svg{
  width:100%;
  height:100%;
  transform:rotate(-90deg);
}

/* background ring – uses theme-ish color */
.prob-donut .donut-bg{
  fill:none;
  stroke:rgba(255,255,255,0.12);      /* dark theme */
  stroke-width:4;
}

/* value ring – gradient from green → yellow → red */
.prob-donut .donut-val{
  fill:none;
  stroke:url(#probGradient);
  stroke-width:5;
  stroke-linecap:round;
  /* JS will set real dash values; these are safe defaults */
  stroke-dasharray:100 100;
  stroke-dashoffset:100;
  transition:stroke-dashoffset .35s ease;
}

/* center label */
.prob-donut-center{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.9rem;
  font-weight:600;
}

/* Light theme tweak so the background ring is softer on cream */
:root[data-theme="light"],
:root[data-theme="light-paper"] {
  --prob-donut-bg: rgba(0,0,0,0.15);
}

:root[data-theme="light"] .prob-donut .donut-bg,
:root[data-theme="light-paper"] .prob-donut .donut-bg{
  stroke: var(--prob-donut-bg, rgba(0,0,0,0.15));
}


/* All generic pills / badges (top-left status, mode badge, etc.) */
:root[data-theme="light"] .pill,
:root[data-theme="light-paper"] .pill {
  background: var(--pill-bg);
  color: #2b2116;
  border-color: rgba(0,0,0,0.14);
}

/* PD: 4 badge next to the title */
:root[data-theme="light"] #pdBadge,
:root[data-theme="light-paper"] #pdBadge {
  background: var(--pill-bg);
  color: #2b2116;
  font-weight: 600;
}

/* Verdict pill keeps its dynamic background; just force readable text */
:root[data-theme="light"] #verdictPill,
:root[data-theme="light-paper"] #verdictPill {
  color: #ffffff;
}

/* Primary buttons – professional blue on cream */
:root[data-theme="light"] .btn,
:root[data-theme="light-paper"] .btn {
  background: var(--accent);
  color: #fdfbf5;
}

/* Secondary / ghost buttons – softer in light mode */
:root[data-theme="light"] .btn.secondary,
:root[data-theme="light-paper"] .btn.secondary,
:root[data-theme="light"] .btn.ghost,
:root[data-theme="light-paper"] .btn.ghost {
  background: #f0e0c4;
  color: #2b2116;
  border-color: var(--border);
}

/* Tiny top-row indicators */
:root[data-theme="light"] #version,
:root[data-theme="light-paper"] #version,
:root[data-theme="light"] #activeModeBadge,
:root[data-theme="light-paper"] #activeModeBadge {
  color: var(--text);
}

/* Consistency Check / drift panel – no more navy slab in light mode */
:root[data-theme="light"] #liveDriftBox,
:root[data-theme="light-paper"] #liveDriftBox {
  background: var(--panel-2);
  color: var(--text);
}

/* Style Match / Consistency Check toggle pills */
:root[data-theme="light"] .live-tabs,
:root[data-theme="light-paper"] .live-tabs {
  background: #f0e0c4;
  border-color: var(--border);
}

:root[data-theme="light"] .live-tab,
:root[data-theme="light-paper"] .live-tab {
  color: var(--muted);
}

:root[data-theme="light"] .live-tab.active,
:root[data-theme="light-paper"] .live-tab.active {
  background: var(--accent);
  color: #ffffff;
}

/* Tooltip bubble text on cream */
:root[data-theme="light"] .help-dot > .tip,
:root[data-theme="light-paper"] .help-dot > .tip {
  color: #2b2116;
}

/* =========================================================
   LCARS POLISH — SAFE VERSION
   (Only styling; no layout changes)
   ========================================================= */

/* Top bar → LCARS header strip look */
:root[data-theme="lcars"] .topbar {
  padding: 4px 10px 10px;
  border-radius: 999px;
  background: #050b18;
  border: 1px solid #252c42;
  box-shadow: 0 8px 20px rgba(0,0,0,0.7);
}

:root[data-theme="lcars"] .topbar strong {
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 0.78em;
}

:root[data-theme="lcars"] #version {
  font-size: 0.72em;
  opacity: 0.85;
}

/* LCARS color pills in topbar (PD + mode badge) */
:root[data-theme="lcars"] #pdBadge {
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.75);
  background: #163626;
  color: #f1ffe8;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

:root[data-theme="lcars"] #activeModeBadge {
  border-radius: 999px;
  border: none;
  background: #f27b7b;
  color: #180707;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Theme select + scale slider → console pads */
:root[data-theme="lcars"] #themeSelect,
:root[data-theme="lcars"] #uiScale {
  border-radius: 999px;
  border: 1px solid #252c42;
  background: #15192b;
  color: #fdf7e3;
}

/* Main cards keep their layout, just get LCARS trims */
:root[data-theme="lcars"] .card {
  box-shadow: 0 10px 26px rgba(0,0,0,0.65);
}

/* Header strips on nested result cards */
:root[data-theme="lcars"] #result .card::before {
  height: 7px;
  width: 42%;
  background: #5bb5ff;
}

/* Live drawer → LCARS console styling without size changes */
:root[data-theme="lcars"] #liveDrawer {
  background: #050814;
  border-top: 2px solid #f2a94f;
  box-shadow: 0 -10px 24px rgba(0,0,0,0.9);
}

:root[data-theme="lcars"] #liveResizeHandle::before {
  background: #f2a94f;
  opacity: 0.85;
}

:root[data-theme="lcars"] #liveDrawer .card::before {
  height: 6px;
  width: 60%;
  background: linear-gradient(to right, #f2a94f, #5bb5ff);
}

/* Live metrics row: LCARS label vibe */
:root[data-theme="lcars"] .live-metrics-header .row > div {
  font-size: 0.8em;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

/* Help dots → console touchpoints */
:root[data-theme="lcars"] .help-dot {
  background: #050b18;
  border-color: #f2a94f;
  color: #f2a94f;
  font-weight: 900;
  letter-spacing: 0.08em;
}

/* Tooltip bubble tuned for LCARS */
:root[data-theme="lcars"] .help-dot > .tip {
  background: rgba(10,15,32,0.98);
  color: #fdf7e3;
  border-color: rgba(242,169,79,0.55);
}

/* Table headers + footer as LCARS UI text */
:root[data-theme="lcars"] table th {
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-size: 0.78em;
}

:root[data-theme="lcars"] .footer {
  font-size: 0.75em;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  opacity: 0.85;
}

/* Optional: subtle scrollbar styling (no layout impact) */
:root[data-theme="lcars"] *::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
:root[data-theme="lcars"] *::-webkit-scrollbar-track {
  background: #050814;
}
:root[data-theme="lcars"] *::-webkit-scrollbar-thumb {
  background: #f2a94f;
  border-radius: 999px;
}

/* =========================================================
   LCARS DECOR v2 – rails, chips, console slabs
   (Pure decoration – no layout changes)
   ========================================================= */

:root[data-theme="lcars"] .wrap {
  position: relative;
  z-index: 1;
  /* keep main UI inside the rails */
  padding-left: 110px;
  padding-right: 110px;
}

/* --------- LEFT / RIGHT RAILS (SNAKING BARS) ---------- */

:root[data-theme="lcars"] .wrap::before,
:root[data-theme="lcars"] .wrap::after {
  content: "";
  position: fixed;
  top: 18px;
  bottom: 24px;
  width: 90px;
  pointer-events: none;
  z-index: 0;
}

/* LEFT rail: stacked colors + notch like your ref */
:root[data-theme="lcars"] .wrap::before {
  left: 0;
  border-radius: 0 40px 40px 0;
  background:
    /* notch cut-out */
    linear-gradient(to bottom,
      transparent 0,
      transparent 17%,
      #000 17%,
      #000 25%,
      transparent 25%,
      transparent 100%
    ),
    /* LCARS color stack */
    linear-gradient(to bottom,
      #f2a94f 0,
      #f2a94f 30%,
      #f27b7b 30%,
      #f27b7b 63%,
      #a88cf2 63%,
      #a88cf2 100%
    );
  box-shadow:
    0 0 0 2px #000 inset,
    0 0 22px rgba(0,0,0,0.9);
}

/* RIGHT rail: mirrored stack */
:root[data-theme="lcars"] .wrap::after {
  right: 0;
  border-radius: 40px 0 0 40px;
  background:
    linear-gradient(to bottom,
      transparent 0,
      transparent 12%,
      #000 12%,
      #000 20%,
      transparent 20%,
      transparent 100%
    ),
    linear-gradient(to bottom,
      #a88cf2 0,
      #a88cf2 28%,
      #f2a94f 28%,
      #f2a94f 60%,
      #f27b7b 60%,
      #f27b7b 100%
    );
  box-shadow:
    0 0 0 2px #000 inset,
    0 0 22px rgba(0,0,0,0.9);
}

/* --------- TOP CONSOLE SLAB (behind header) ---------- */

:root[data-theme="lcars"] body::before {
  content: "";
  position: fixed;
  left: 110px;
  right: 110px;
  top: 22px;
  height: 64px;
  border-radius: 36px 36px 18px 18px;
  background:
    linear-gradient(to right,
      #f2a94f 0,
      #f2a94f 26%,
      #f27b7b 26%,
      #f27b7b 55%,
      #a88cf2 55%,
      #a88cf2 100%
    );
  box-shadow:
    0 0 0 2px #000 inset,
    0 14px 30px rgba(0,0,0,0.85);
  pointer-events: none;
  z-index: 0;
}

/* --------- BOTTOM STATUS BAND ---------- */

:root[data-theme="lcars"] body::after {
  content: "";
  position: fixed;
  left: 90px;
  right: 90px;
  bottom: 12px;
  height: 24px;
  border-radius: 18px 18px 8px 8px;
  background: linear-gradient(to right,
    #f2a94f 0,
    #f2a94f 50%,
    #f27b7b 50%,
    #f27b7b 75%,
    #5bb5ff 75%,
    #5bb5ff 100%
  );
  box-shadow:
    0 0 0 2px #000 inset,
    0 -8px 18px rgba(0,0,0,0.8);
  pointer-events: none;
  z-index: 0;
}

/* --------- SIDE “CHIP” STACK (like vertical buttons) ---------- */

:root[data-theme="lcars"] .lcars-chips,
:root[data-theme="lcars"] .lcars-chips::before,
:root[data-theme="lcars"] .lcars-chips::after {
  pointer-events: none;
}

/* We fake the chip column with a fixed, invisible element */
:root[data-theme="lcars"] .wrap::marker { /* noop to keep CSS valid in some editors */ }

/* actual chips – attach to .wrap via another pseudo */
:root[data-theme="lcars"] .wrap > *:first-child::before {
  content: "";
  position: fixed;
  left: 78px;
  top: 45%;
  width: 18px;
  height: 180px;
  transform: translateY(-50%);
  background:
    linear-gradient(to bottom,
      #f27b7b 0,
      #f27b7b 18%,
      transparent 18%,
      transparent 26%,
      #a88cf2 26%,
      #a88cf2 44%,
      transparent 44%,
      transparent 52%,
      #f2a94f 52%,
      #f2a94f 70%,
      transparent 70%,
      transparent 78%,
      #5bb5ff 78%,
      #5bb5ff 100%
    );
  border-radius: 999px;
  box-shadow:
    0 0 0 2px #000 inset,
    0 0 10px rgba(0,0,0,0.8);
  z-index: 0;
}

/* --------- TOPBAR STATUS LINE TWEAK ---------- */

:root[data-theme="lcars"] .topbar {
  position: relative;
}

/* Subtle LCARS space-dock backdrop */
:root[data-theme="lcars"] body {
  background:
    radial-gradient(circle at 15% 0%,  #1a2340 0, transparent 45%),
    radial-gradient(circle at 85% 100%, #2b3256 0, transparent 45%),
    linear-gradient(to bottom, #02030a 0, #02030a 40%, #050814 100%);
}

/* Little “status bar” line under the topbar (no layout change) */
:root[data-theme="lcars"] .topbar::after {
  content: "";
  position: absolute;
  left: 90px;
  right: 90px;
  bottom: -6px;
  height: 3px;
  border-radius: 999px;
  background: linear-gradient(to right, #f27b7b, #f2a94f, #5bb5ff);
  opacity: 0.85;
  pointer-events: none;
}

/* --- RESULT CARD: hide old horizontal bar completely --- */
#result .bar,
#result .bar > .fill {
  display: none !important;
}

/* === HERO DONUT – bigger, clean, actually circular === */
#result .prob-donut {
  flex: 0 0 220px;
  width: 220px;
  height: 220px;
}

#result .prob-donut svg {
  shape-rendering: geometricPrecision; /* smoother circle edges */
}

#result .prob-donut-center {
  font-size: 1.1rem;
  font-weight: 700;
}

/* Same thickness for track + arc, but thin enough to fit in 40x40 viewBox */
#result .prob-donut .donut-bg,
#result .prob-donut .donut-val {
  stroke-width: 8px;
}

/* Round ends now that we’re not clipping against the box */
#result .prob-donut .donut-val {
  stroke-linecap: butt;
}

/* small-screen safety */
@media (max-width: 900px) {
  #result .prob-donut {
    flex: 0 0 180px;
    width: 180px;
    height: 180px;
  }
}

/* Result donut: solid LCARS color instead of gradient */
#result .prob-donut .donut-val {
  stroke: var(--accent, var(--accent));
}

/* Frame the donut between explanation (left) and metrics (right) */
#resultSummaryRow {
  display: grid;
  grid-template-columns: minmax(0, 1.3fr) auto minmax(0, 1.3fr);
  align-items: center;
  gap: 32px;
  margin-top: 12px;
  margin-bottom: 26px;
}

/* center column: donut stays centered, same size */
#resultSummaryRow .result-summary-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* make sure donut row centers inside this layout */
#resultSummaryRow .prob-donut-row {
  justify-content: center;
}

/* left text hugs donut */
#resultSummaryRow .result-summary-left {
  font-size: 0.95em;
  line-height: 1.4;
}
#resultSummaryRow .result-summary-left .muted {
  max-width: 34rem;
  text-align: right;
}

/* right column uses your existing kv grid but a bit tighter */
.kv-compact {
  row-gap: 4px;
  font-size: 0.9em;
}

/* responsive: stack on small screens, donut first */
@media (max-width: 1100px) {
  #resultSummaryRow {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  #resultSummaryRow .result-summary-left .muted {
    text-align: left;
  }
  #resultSummaryRow .result-summary-center {
    order: -1; /* donut on top on narrow screens */
  }
}

/* === LCARS right-panel tabs (under Runtime Settings) ================ */

.lcars-panel {
  margin-top: 18px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  /* keep it inside the card, full width of the card content */
}

.lcars-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
}

.lcars-tab {
  border: none;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  cursor: pointer;

  background: var(--panel-2);
  color: var(--text);
  border: 1px solid var(--border);
}

.lcars-tab-active {
  background: var(--accent);
  color: #120b05;
}

.lcars-tab-content {
  /* just normal flow inside the card */
}

.tab-section {
  display: none;
  font-size: 0.9rem;
  line-height: 1.5;
}

.tab-section-active {
  display: block;
}

/* ===== LCARS panel: tab layout + animated transitions ===== */

.lcars-panel {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 0.9em;
}

/* Tab strip */
.lcars-tabs {
  display: inline-flex;
  flex-wrap: wrap;
  gap: 4px;
}

.lcars-tab {
  border: none;
  padding: 4px 10px;
  border-radius: 999px;
  background: #15192b;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 0.7rem;
  cursor: pointer;
}

.lcars-tab-active {
  background: var(--accent);
  color: #120b05;
}

/* Content area with animated sections */
.lcars-tab-content {
  position: relative;
  margin-top: 10px;
  min-height: 54px;        /* keeps the panel from collapsing on quick switches */
}

/* Base state: hidden, slightly shifted down */
.tab-section {
  position: absolute;
  inset: 0 auto auto 0;
  opacity: 0;
  transform: translateY(4px);
  pointer-events: none;
  transition:
    opacity 0.18s ease-out,
    transform 0.18s ease-out;
}

/* Active section: visible + in place */
.tab-section-active {
  position: relative;
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

/* === LCARS INTERACTION EFFECTS (buttons + tabs) === */
:root[data-theme="lcars"] .btn,
:root[data-theme="lcars"] .lcars-tab,
:root[data-theme="lcars"] .live-tab {
  position: relative;
  transition:
    transform 0.12s ease-out,
    box-shadow 0.12s ease-out,
    background-color 0.15s ease-out,
    filter 0.15s ease-out;
}

/* HOVER: lift + brighten */
:root[data-theme="lcars"] .btn:not(:disabled):hover,
:root[data-theme="lcars"] .lcars-tab:not(:disabled):hover,
:root[data-theme="lcars"] .live-tab:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow:
    0 0 0 1px rgba(0,0,0,0.9),
    0 8px 18px rgba(0,0,0,0.65);
  filter: brightness(1.08);
}

/* ACTIVE: pressed down */
:root[data-theme="lcars"] .btn:not(:disabled):active,
:root[data-theme="lcars"] .lcars-tab:not(:disabled):active,
:root[data-theme="lcars"] .live-tab:not(:disabled):active {
  transform: translateY(2px) scale(0.97);
  box-shadow:
    0 0 0 1px rgba(0,0,0,0.9),
    0 3px 8px rgba(0,0,0,0.8);
  filter: brightness(0.96);
}

/* FOCUS RING */
:root[data-theme="lcars"] .btn:focus-visible,
:root[data-theme="lcars"] .lcars-tab:focus-visible,
:root[data-theme="lcars"] .live-tab:focus-visible {
  outline: 2px solid #5bb5ff;
  outline-offset: 2px;
}

/* DISABLED: dead flat */
:root[data-theme="lcars"] .btn:disabled,
:root[data-theme="lcars"] .lcars-tab:disabled,
:root[data-theme="lcars"] .live-tab:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
  filter: none;
}

/* === LCARS SUPER-GLOW INTERACTIONS === */
:root[data-theme="lcars"] .btn,
:root[data-theme="lcars"] .lcars-tab,
:root[data-theme="lcars"] .live-tab {
  position: relative;
  transition:
    transform 0.12s ease-out,
    box-shadow 0.15s ease-out,
    filter 0.15s ease-out,
    background-color 0.15s ease-out;
}

/* HOVER: strong LCARS glow + raised plate */
:root[data-theme="lcars"] .btn:not(:disabled):hover,
:root[data-theme="lcars"] .lcars-tab:not(:disabled):hover,
:root[data-theme="lcars"] .live-tab:not(:disabled):hover {
  transform: translateY(-3px);
  box-shadow:
    0 0 6px rgba(255, 204, 112, 0.9),    /* LCARS amber outer glow */
    0 0 20px rgba(255, 155, 50, 0.75),   /* second glow layer */
    0 10px 20px rgba(0, 0, 0, 0.65);     /* shadow behind */
  filter: brightness(1.20) saturate(1.2);
}

/* ACTIVE: pressed with inner glow */
:root[data-theme="lcars"] .btn:not(:disabled):active,
:root[data-theme="lcars"] .lcars-tab:not(:disabled):active,
:root[data-theme="lcars"] .live-tab:not(:disabled):active {
  transform: translateY(2px) scale(0.96);
  box-shadow:
    0 0 4px rgba(255, 204, 112, 0.8),
    0 0 10px rgba(255, 155, 50, 0.6),
    inset 0 0 12px rgba(255, 175, 75, 0.75); /* LCARS inner glow */
  filter: brightness(0.95);
}

/* Focused (keyboard nav): distinct blue LCARS ring */
:root[data-theme="lcars"] .btn:focus-visible,
:root[data-theme="lcars"] .lcars-tab:focus-visible,
:root[data-theme="lcars"] .live-tab:focus-visible {
  outline: 2px solid #5bb5ff;
  outline-offset: 3px;
}

/* Extra vertical spacing between upper-right panel and Runtime Settings */
/*@media (min-width: 900px) {
  section[aria-label="Runtime Settings"] {
    margin-top: 40px;  /* ~“about an inch” visually, tweak as needed */
  }
}*/

/* =========================================================
   LCARS side panel – layout, spacing, micro-animations
   ========================================================= */

.lcars-panel {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 0.92em;
}

.lcars-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  margin-bottom: 8px;
}

.lcars-tab {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 11px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(7, 10, 22, 0.9);
  color: var(--muted);
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.09em;
  font-size: 0.7rem;
  white-space: nowrap;
  transition:
    background 0.18s ease,
    color 0.18s ease,
    box-shadow 0.18s ease,
    transform 0.08s ease,
    opacity 0.18s ease;
}

.lcars-tab-icon {
  font-size: 0.85em;
  opacity: 0.8;
}

.lcars-tab-label {
  position: relative;
  top: 0.5px;
}

.lcars-tab-active {
  background: var(--accent);
  color: #120b05;
  box-shadow:
    0 0 0 1px rgba(0, 0, 0, 0.7),
    0 0 18px rgba(242, 169, 79, 0.55);
}

.lcars-tab:hover {
  transform: translateY(-1px);
  box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.65);
  opacity: 0.98;
}

.lcars-tab:focus-visible {
  outline: 2px solid var(--accent-3, #5bb5ff);
  outline-offset: 2px;
}

.lcars-tab-content {
  border-radius: 10px;
  background: var(--panel-2);
  padding: 10px 12px;
  box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.65) inset;
}

/* Sections fade in instead of snapping */
.tab-section {
  display: none;
  animation: lcarsTabFade 0.18s ease-out;
}

.tab-section-active {
  display: block;
}

.lcars-section-title {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.68rem;
  color: var(--muted);
  margin: 0 0 6px;
}

.lcars-kv {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
  gap: 4px 10px;
}

.lcars-kv > div:first-child {
  opacity: 0.85;
}

.lcars-kv .mono {
  text-align: right;
}

.lcars-subtext {
  margin-top: 6px;
  font-size: 0.85em;
  opacity: 0.85;
}

.lcars-pill-inline {
  display: inline-flex;
  align-items: center;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.55);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.lcars-pill-inline.good {
  background: #163626;
  color: #cafad7;
}

.lcars-pill-inline.warn {
  background: #2f2a12;
  color: #f4e2c0;
}

.lcars-pill-inline.bad {
  background: #3a1b1b;
  color: #ffd4d4;
}

.lcars-empty {
  font-style: italic;
  opacity: 0.8;
}

.lcars-history-list {
  margin: 4px 0 0;
  padding-left: 1.1rem;
  max-height: 160px;
  overflow-y: auto;
}

.lcars-history-list li {
  margin-bottom: 2px;
  font-size: 0.85em;
}

/* Tiny scrollbars inside LCARS panel only */
.lcars-history-list::-webkit-scrollbar {
  width: 6px;
}
.lcars-history-list::-webkit-scrollbar-thumb {
  border-radius: 999px;
  background: var(--accent-4, #a88cf2);
}

@keyframes lcarsTabFade {
  from {
    opacity: 0;
    transform: translateY(2px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Verdict pill text: always white for readability */
#verdictPill {
  color: #ffffff !important;
  font-weight: 700;
}


/* Advanced metrics toggle bar */

.adv-metrics {
  margin-top: 16px;
}

.adv-summary {
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 14px;
  background: rgba(242, 169, 79, 0.14);
  border-radius: 999px;
  border: 1px solid rgba(242, 169, 79, 0.75);
  cursor: pointer;
  user-select: none;
  box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.4);
}

.adv-summary::-webkit-details-marker {
  display: none;
}

.adv-summary-left {
  display: flex;
  flex-direction: column;
}

.adv-summary-label {
  font-weight: 600;
  font-size: 0.98rem;
}

.adv-summary-sub {
  font-size: 0.8rem;
  opacity: 0.85;
}

/* Chevron */
.adv-summary-chevron {
  font-size: 1.15rem;
  transform: rotate(0deg);
  transition: transform 0.15s ease-out;
}

/* Closed state: stronger glow so it pulls the eye */
.adv-metrics:not([open]) .adv-summary {
  background: rgba(242, 169, 79, 0.08);
  box-shadow:
    0 0 0 1px rgba(242, 169, 79, 0.9),
    0 0 18px rgba(242, 169, 79, 0.45);
}

/* Open state: chevron flipped up */
.adv-metrics[open] .adv-summary-chevron {
  transform: rotate(180deg);
}

.adv-body {
  margin-top: 12px;
}

/* Make summary behave like a centered button container */
.adv-btn-summary {
  list-style: none;
  display: flex;
  justify-content: center;
  margin: 20px 0;
  cursor: pointer;
}

.adv-btn-summary::-webkit-details-marker {
  display: none;
}

/* CopyCat button style (same as Scan / Open Live Verification) */
.copycat-btn {
  background: #f2a94f;
  color: #000;
  padding: 10px 22px;
  border-radius: 50px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease,
    background 0.15s ease;
}

/* Hover raise */
.copycat-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(242, 169, 79, 0.4);
}

/* Active press */
.copycat-btn:active {
  transform: translateY(1px);
  box-shadow: 0 2px 6px rgba(242, 169, 79, 0.2);
}

/* Slide-out "What this means" panel */
.explain-panel {
  position: fixed;
  inset-block: 0;
  right: 0;
  width: 100%;
  max-width: 420px;
  background: var(--bg, #050816);
  box-shadow: -0.5rem 0 1.5rem rgba(0, 0, 0, 0.7);
  transform: translateX(100%);
  opacity: 0;
  transition: transform 220ms ease-out, opacity 220ms ease-out;
  z-index: 500;
  display: flex;
}

.explain-panel.open {
  transform: translateX(0);
  opacity: 1;
}

.explain-panel-inner {
  padding: 16px;
  width: 100%;
  overflow-y: auto;
}

/* Dimmed click-to-close background */
.explain-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(2px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease-out;
  z-index: 490;
}

.explain-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

/* Keep explain sections readable inside the panel */
#explainBody .explain-section {
  margin-bottom: 10px;
}

/* Keep content column narrower and easier on the eyes */
.explain-panel-inner {
  max-width: 640px;
  margin: 0 auto;
  font-size: 0.95rem;
  line-height: 1.5;
}

/* Section spacing */
#explainBody .explain-section {
  margin-bottom: 14px;
}

/* Section titles inside the panel */
#explainBody .explain-section b {
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
}

/* Lists: give them a bit of air */
#explainBody .explain-list {
  padding-left: 1.2em;
  margin: 4px 0 0;
}

#explainBody .explain-list li {
  margin-bottom: 4px;
}

/* Notes: make them slightly softer so they read as extra context */
#explainBody .explain-note {
  font-size: 0.9rem;
  opacity: 0.9;
}

/* Raw JSON inside Advanced: compact and scrollable */
#rawJsonBox {
  margin-top: 10px;
}

#rawJsonBox > summary {
  font-size: 0.85rem;
  cursor: pointer;
}

#rawDump {
  max-height: 220px;
  overflow: auto;
  margin-top: 6px;
  padding: 8px 10px;
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(255, 255, 255, 0.06);
  font-size: 11px;
  line-height: 1.35;
}

/* Raw JSON: readable + respects global scale */
#rawDump {
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: 0.90em;      /* scales with --scale because html/body use em */
  line-height: 1.45;
}

/* ===== CopyCat LIGHT THEME – button readability fix ===== */

/* Primary action buttons (Scan, Save, Live Verification, etc.) */
:root[data-ui-theme="light"] .btn,
html[data-ui-theme="light"] .btn,
:root[data-theme="light"] .btn,
html[data-theme="light"] .btn {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #f9fafb;
  border: none;
  border-radius: 999px;
  font-weight: 600;
  box-shadow: 0 8px 20px rgba(37, 99, 235, 0.30);
}

/* Secondary buttons – softer pill, dark text, clear border */
:root[data-ui-theme="light"] .btn.secondary,
html[data-ui-theme="light"] .btn.secondary,
:root[data-theme="light"] .btn.secondary,
html[data-theme="light"] .btn.secondary {
  background: #e5e7f5;
  color: #111827;
  border: 1px solid #cbd2f0;
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
}

/* Ghost / subtle buttons – transparent with clear outline */
:root[data-ui-theme="light"] .btn.ghost,
html[data-ui-theme="light"] .btn.ghost,
:root[data-theme="light"] .btn.ghost,
html[data-theme="light"] .btn.ghost {
  background: transparent;
  color: #1f2937;
  border: 1px solid #cbd5f5;
  box-shadow: none;
}

/* Disabled state: dimmed but still readable */
:root[data-ui-theme="light"] .btn:disabled,
html[data-ui-theme="light"] .btn:disabled,
:root[data-theme="light"] .btn:disabled,
html[data-theme="light"] .btn:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  box-shadow: none;
}

/* ===== LIGHT THEME: make pills / tabs readable ===== */

:root[data-ui-theme="light"] .chip,
html[data-ui-theme="light"] .chip,
:root[data-theme="light"] .chip,
html[data-theme="light"] .chip,
:root[data-ui-theme="light"] .tab-pill,
html[data-ui-theme="light"] .tab-pill,
:root[data-theme="light"] .tab-pill,
html[data-theme="light"] .tab-pill,
:root[data-ui-theme="light"] .pill,
html[data-ui-theme="light"] .pill,
:root[data-theme="light"] .pill,
html[data-theme="light"] .pill {
  color: #f9fafb !important;    /* bright white text */
  font-weight: 600;             /* thicker, matches buttons */
  letter-spacing: 0.02em;       /* tiny bit more presence */
}

/* ===== LIGHT THEME: make PD tabs readable ===== */
:root[data-ui-theme="light"] .card button:not(#btnScan):not(#btnSaveConfig):not(.live-tab),
html[data-ui-theme="light"] .card button:not(#btnScan):not(#btnSaveConfig):not(.live-tab),
:root[data-theme="light"] .card button:not(#btnScan):not(#btnSaveConfig):not(.live-tab),
html[data-theme="light"] .card button:not(#btnScan):not(#btnSaveConfig):not(.live-tab) {
  background: #111827 !important;            /* dark navy chip */
  color: #f9fafb !important;                 /* bright white text */
  border-radius: 999px !important;           /* pill shape */
  font-weight: 600 !important;               /* thicker text */
  padding: 4px 12px !important;
  font-size: 0.78rem !important;             /* a bit bigger/readable */
  border: 1px solid #0f172a !important;
}

/* ===== LIGHT THEME: make LCARS tabs readable ===== */
:root[data-theme="light"] .lcars-tab,
:root[data-theme="light-paper"] .lcars-tab,
html[data-theme="light"] .lcars-tab,
html[data-theme="light-paper"] .lcars-tab,
:root[data-ui-theme="light"] .lcars-tab,
html[data-ui-theme="light"] .lcars-tab {
  background: #020617 !important;      /* dark slate pill */
  color: #e5e7eb !important;           /* light gray text */
  border-color: #0f172a !important;
  font-weight: 600 !important;         /* thicker */
  padding: 4px 12px !important;
  border-radius: 999px !important;
}

/* Active state: bright blue pill, white text */
:root[data-theme="light"] .lcars-tab.lcars-tab-active,
:root[data-theme="light-paper"] .lcars-tab.lcars-tab-active,
html[data-theme="light"] .lcars-tab.lcars-tab-active,
html[data-theme="light-paper"] .lcars-tab.lcars-tab-active,
:root[data-ui-theme="light"] .lcars-tab.lcars-tab-active,
html[data-ui-theme="light"] .lcars-tab.lcars-tab-active {
  background: #2563eb !important;      /* same gradient family as main buttons */
  color: #f9fafb !important;           /* white text */
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 6px 16px rgba(37, 99, 235, 0.35) !important;
}

/* ==== Live Verification drawer: clearer sections + textarea ==== */

/* Give the two columns inside the live drawer a card frame */
#liveDrawer .split > div {
  background: var(--panel);
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 10px 12px;
}

/* Make the live textarea stand out a bit more in all themes */
#liveDrawer .live-left textarea {
  background: var(--panel-2);
  border: 1px solid var(--border);
}

/* Light themes: bright, obvious input area */
html[data-theme="light"] #liveDrawer .live-left textarea,
html[data-theme="light-paper"] #liveDrawer .live-left textarea {
  background: #e6efff;          /* light blue panel */
  border-color: #c3d3ff;
}

/* Dark “pro” theme: drawer is dark, textarea slightly lifted */
html:not([data-theme="light"])
    :not([data-theme="light-paper"])
    :not([data-theme="lcars"]) #liveDrawer .live-left textarea {
  background: #050816;          /* darker well */
  border-color: #1e293b;        /* subtle outline */
}

/* Keep LCARS exactly as-is */
html[data-theme="lcars"] #liveDrawer .split > div,
html[data-theme="lcars"] #liveDrawer .live-left textarea {
  background: inherit;
  border: none;
  padding: 0;
}

/* LCARS: give the live-typing panel a proper console background */
:root[data-theme="lcars"] #liveDrawer .live-left {
  background: #050b18;            /* same family as the drift panel */
  border-radius: 14px;
  padding: 12px 14px 16px;        /* a little breathing room around the textarea */
  box-shadow: 0 0 0 1px #151b2b inset;
}

/* LCARS: make the textarea itself clearly “inside” that console */
:root[data-theme="lcars"] #liveDrawer .live-left textarea {
  background: #02030f;
  border-color: #151b2b;
  color: #fdf7e3;
}

/* LCARS: Live Verification input panel */
:root[data-theme="lcars"] #liveDrawer .split > div:first-child,
html[data-theme="lcars"] #liveDrawer .split > div:first-child {
  background: #050b18;              /* same family as right-side metrics panel */
  border-radius: 14px;
  border: 1px solid #151b2b;
  padding: 12px 14px 14px;
}

/* LCARS: textarea slab inside that panel */
:root[data-theme="lcars"] #liveDrawer #liveInput,
html[data-theme="lcars"] #liveDrawer #liveInput {
  background: #070d1e;
  border: 1px solid #252c42;
  box-sizing: border-box;
  width: 100%;
}
/* === LCARS live drawer: make input black, surround with LCARS blue card === */

:root[data-theme="lcars"] #liveDrawer .live-left {
  background: #050b18;              /* same kind of blue as the right panel */
  border-radius: 16px;
  padding: 10px 12px 14px;
  box-shadow:
    0 0 0 2px #000 inset,
    0 10px 24px rgba(0, 0, 0, 0.9);
}

/* Textarea itself: black slab, high contrast text */
:root[data-theme="lcars"] #liveInput {
  background: #000000;
  color: #fdf7e3;
  border-radius: 10px;
  border: 1px solid #12192e;
}

/* Make sure it fills the card cleanly */
:root[data-theme="lcars"] #liveInput {
  width: 100%;
  box-sizing: border-box;
}

/* Placeholder text readable on black */
:root[data-theme="lcars"] #liveInput::placeholder {
  color: rgba(253, 247, 227, 0.55);
}

/* === LCARS live drawer: clear, card-style input area ==================== */

/* Left column “card” behind the textarea */
:root[data-theme="lcars"] #liveDrawer .live-left {
  background: var(--panel) !important;   /* same dark blue as right panel */
  border-radius: 14px !important;
  padding: 10px 12px 14px !important;
  box-shadow:
    0 0 0 2px #000 inset,
    0 10px 22px rgba(0, 0, 0, 0.85) !important;
}

/* Text box itself: true black slab, high-contrast text */
:root[data-theme="lcars"] #liveDrawer #liveInput {
  background: #000000 !important;
  color: #fdf7e3 !important;
  border-radius: 10px !important;
  border: 1px solid #12192e !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

/* Placeholder text on black */
:root[data-theme="lcars"] #liveDrawer #liveInput::placeholder {
  color: rgba(253, 247, 227, 0.55) !important;
}

/* === LCARS live drawer: lighter panel + black textarea ================ */

/* Surrounding panel behind the live input (left side of drawer) */
:root[data-theme="lcars"] #liveDrawer .live-left {
  background: linear-gradient(
    135deg,
    #222e5a,
    #283567
  ) !important;                 /* softer, lighter navy */
  border-radius: 14px !important;
  padding: 12px 14px 16px !important;
  box-shadow:
    0 0 0 1px rgba(0,0,0,0.9) inset,
    0 10px 24px rgba(0,0,0,0.65) !important;
}

/* Textarea itself: true black slab with bright text */
:root[data-theme="lcars"] #liveDrawer #liveInput {
  background: #000000 !important;
  color: #fdf7e3 !important;
  border-radius: 10px !important;
  border: 1px solid #5bb5ff !important;   /* brighter edge so it pops */
  width: 100% !important;
  box-sizing: border-box !important;
}

/* Placeholder on black textarea */
:root[data-theme="lcars"] #liveDrawer #liveInput::placeholder {
  color: rgba(253, 247, 227, 0.6) !important;
}

/* LCARS: drift panel matches live-input panel + light blue outline */
:root[data-theme="lcars"] #liveDriftBox {
  background: linear-gradient(135deg, #222e5a, #283567) !important;
  border-radius: 14px !important;

  /* thin light-blue accent outline + soft drop shadow */
  box-shadow:
    0 0 0 1px #7ea6ff,                     /* light blue outline */
    0 10px 24px rgba(0, 0, 0, 0.65);       /* depth shadow */
}

/* LCARS: drift panel padding + outline + background */
:root[data-theme="lcars"] #liveDriftBox {
  /* existing look */
  background: linear-gradient(135deg, #222e5a, #283567) !important;
  border-radius: 14px !important;
  box-shadow:
    0 0 0 1px #7ea6ff,                     /* light blue outline */
    0 10px 24px rgba(0, 0, 0, 0.65);

  /* NEW: breathing room so text isn’t hugging the edge */
  padding: 14px 22px 18px;
  box-sizing: border-box;
}

/* LCARS – Live verification LEFT panel wrapper around the textarea */
:root[data-theme="lcars"] #liveDrawer .live-left {
  background: linear-gradient(135deg, #222e5a, #283567);
  border-radius: 14px;
  padding: 14px 22px 18px;   /* same breathing room as drift box */
  box-sizing: border-box;

  /* same thin blue outline + soft glow */
  box-shadow:
    0 0 0 1px #7ea6ff,
    0 10px 24px rgba(0, 0, 0, 0.65);
}

/* LCARS – actual textarea inside that panel */
:root[data-theme="lcars"] #liveText {
  background: #020308;          /* solid black text field */
  color: #fdfdfd;
  border-radius: 10px;
  border: 1px solid #89b4ff;    /* inner accent line */

  padding: 10px 12px;           /* text not hugging edge */
  box-sizing: border-box;
  resize: vertical;

  /* matching glow around the textbox itself */
  box-shadow:
    0 0 0 1px #7ea6ff,
    0 0 18px rgba(126, 166, 255, 0.45);
}

/* LCARS – live verification left pane wrapper */
[data-theme="lcars"] #liveDrawer .live-left,
[data-theme="lcars"] #liveDrawer #liveLeft {
  box-sizing: border-box;
  background: #273363;              /* same blue as the drift block */
  border-radius: 10px;
  padding: 16px 20px 18px;          /* same padding feel as drift stats */
  box-shadow: 0 0 0 1px #7db7ff;    /* thin light blue outline */
}

/* Keep the textarea inset nicely inside that wrapper */
[data-theme="lcars"] #liveDrawer .live-left textarea,
[data-theme="lcars"] #liveDrawer #liveLeft textarea {
  width: 100%;
  box-sizing: border-box;
  border-radius: 6px;
  border: 1px solid #7db7ff;        /* inner blue line (what you already like) */
  padding: 10px 14px;               /* same idea as right-side padding */
}


</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <strong>CopyCat — AI Text Scanner</strong>
      <span id="version" class="muted"></span>
      <span id="pdBadge" class="pill" aria-live="polite" title="Public-domain fingerprint centroids">PD: —</span>
    </div>
    <div class="scale-wrap">
      <label class="muted" for="uiScale">UI scale</label>
      <input id="uiScale" type="range" min="120" max="220" value="150" />
      
      <select id="themeSelect" style="margin-left:8px;">
        <option value="dark-professional">Dark</option>
        <option value="light-paper">Light</option>
        <option value="lcars">LCARS</option>
      </select>
    </div>
  </div>

  <div class="grid cols">
    <!-- Left -->
    <section class="card" aria-label="AI Text Scanner">
      <div class="row" style="justify-content:space-between">
        <h1 style="margin:0">CopyCat: AI Content Auditor</h1>
        <span class="muted" id="ensemBadge"></span>
      </div>

      <div class="row">
        <!-- Demo button + preset dropdown -->
        <div class="help-wrap">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:nowrap;">
            <button id="btnDemo" class="btn secondary">Load Demo</button>
            <select id="demoPreset" class="mono" style="min-width:190px; max-width:230px;">
              <!-- options will be filled by JS -->
            </select>
          </div>
          <span class="help-dot" tabindex="0">
            <span class="tip">
              Load a curated example passage. Choose a type (news, story, essay, code) or pick “random”.
            </span>
          </span>
        </div>

        <div class="help-wrap">
          <button id="btnClear" class="btn ghost">Clear</button>
          <span class="help-dot" tabindex="0"><span class="tip">Clear the input and results. Also disables Live/Finalize until the next Scan.</span></span>
        </div>

        <div class="help-wrap">
          <button id="btnLive" class="btn ghost" aria-controls="liveDrawer">Open Live Verification</button>
          <span class="help-dot" tabindex="0"><span class="tip">Open the Live Verification drawer to type a short sample for comparison.</span></span>
        </div>
      </div>

      <!-- Demo Mode Toggle + Presets -->
      <div class="row" style="align-items:flex-start; margin-bottom:10px; gap:12px;">
        <label class="mono" style="font-size:0.9em; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="demoToggle">
          Demo mode (use preset curated samples)
        </label>

      <div id="demoPresetWrap" class="muted">
         <span style="font-size:0.85em;">Preset:</span>
          <select id="demoPresetSecondary">
            <option value="random">(random curated sample)</option>
            <option value="news">News / op-ed</option>
            <option value="story">Story / narrative</option>
            <option value="essay">Student-style essay</option>
            <option value="code">Short code snippet</option>
          </select>
        </div>
      </div>



      <label for="text">Text to scan</label>
      <textarea id="text" placeholder="Paste or type text to analyze…"></textarea>

      <div class="grid" style="grid-template-columns: 1fr 1fr auto; gap:12px; margin-top:12px">
        <div>
          <div class="row" style="justify-content:space-between">
            <label for="mode">Mode</label>
            <span class="help-dot" tabindex="0"><span class="tip">Override the runtime mode for this one scan (Balanced / Strict / Academic).</span></span>
          </div>
          <select id="mode">
            <option>Balanced</option><option>Strict</option><option>Academic</option>
          </select>
          <div class="muted" style="font-size:.95em">Overrides current runtime mode for this scan only.</div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <label for="tag">Optional tag</label>
            <span class="help-dot" tabindex="0"><span class="tip">Free-form flag (e.g., “classic”, “pre-1920”) saved into the scan log.</span></span>
          </div>
          <input id="tag" type="text" placeholder="e.g., classic, pre-1920, …" />
        </div>

        <div style="display:flex;align-items:flex-end;gap:10px">
          <div class="help-wrap">
            <button id="btnScan" class="btn">Scan</button>
            <span class="help-dot" tabindex="0"><span class="tip">Send the text to the server and compute detection metrics.</span></span>
          </div>
          <span id="scanStatus" class="muted" aria-live="polite" role="status"></span>
        </div>
      </div>

      <!-- Explain + Result -->
      <div id="bandBadge" class="band-badge" aria-live="polite" style="display:none;">
        <span class="badge-dot"></span>
        <span id="bandText">Band</span>
        <span id="bandPct" style="opacity:.75;"></span>
      </div>

     <!-- Slide-out panel for "What this means" -->
      <div id="explainBackdrop" class="explain-backdrop" hidden></div>

      <div id="explainPanel" class="explain-panel" aria-hidden="true">
        <div class="explain-panel-inner">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0;">What this means</h3>
            <button id="btnExplainClose" class="btn ghost" type="button">Close</button>
          </div>

          <!-- original explain content lives inside the panel -->
          <div id="explainWrap" aria-live="polite">
            <div id="explainHeader" style="display:none;">
              <!-- header text now handled by panel title -->
              <div id="explainTitle"></div>
              <button id="explainToggleBtn" aria-expanded="true" aria-controls="explainBody" style="display:none;">
                Hide
              </button>
            </div>

            <div id="explainBody">
              <div id="explainHeadline" class="explain-section"></div>
              <div id="explainWhy" class="explain-section"></div>
              <div id="explainFix" class="explain-section"></div>
              <div id="explainNotes" class="explain-section explain-note"></div>
              <div id="teacherRow" class="explain-section" style="opacity:.9;">
                <small id="teacherMini"></small>
              </div>
            </div>
          </div>
        </div>
      </div>


     <div id="result" style="margin-top:16px; display:none">
      <div class="row" style="justify-content:space-between; align-items:center;">
      <h3 style="margin:0">Result</h3>
      <div class="row" style="gap:8px; align-items:center;">
        <span id="verdictPill" class="pill">—</span>
        <button id="btnExplainPanel" class="btn ghost" type="button" disabled>
          What this means
        </button>
      </div>
    </div>


  <!-- Summary row (unchanged) -->
  <div id="resultSummaryRow">
    <!-- LEFT: label + short explanation -->
    <div class="result-summary-col result-summary-left">
      <div class="muted">Calibrated probability (AI likelihood)</div>
      <div id="explainShort" class="muted" style="margin-top:6px">
        —
      </div>
    </div>

    <!-- CENTER: donut gauge -->
    <div class="result-summary-col result-summary-center">
      <div class="prob-donut-row">
        <div class="prob-donut" aria-hidden="true">
          <svg viewBox="0 0 40 40">
            <defs>
              <linearGradient id="probGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%"   stop-color="#f2a94f" />
                <stop offset="100%" stop-color="#f2a94f" />
              </linearGradient>
            </defs>

            <!-- background ring -->
            <circle class="donut-bg"  cx="20" cy="20" r="16"></circle>
            <!-- value ring -->
            <circle class="donut-val" cx="20" cy="20" r="16"></circle>
          </svg>

          <!-- center label -->
          <div class="prob-donut-center" id="probPctCenter">—</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: numeric metrics -->
    <div class="result-summary-col result-summary-right">
      <div class="kv kv-compact">
        <div>Top-10 tokens</div><div id="top10" class="right mono">—</div>
        <div>Top-100 tokens</div><div id="top100" class="right mono">—</div>
        <div>Perplexity</div><div id="ppl" class="right mono">—</div>
        <div>Burstiness</div><div id="burst" class="right mono">—</div>
        <div>Category</div><div id="category" class="right mono">—</div>
        <div>Model</div><div id="modelName" class="right mono">—</div>
        <div>LLM fingerprint</div><div id="fpLabel" class="right mono">—</div>
        <div>Fingerprint band</div><div id="fpBand" class="right mono">—</div>
        <div>Mode</div><div id="modeEcho" class="right mono">—</div>
        <div>PD overlap J</div><div id="pdj" class="right mono">—</div>
        <div>Tag</div><div id="tagEcho" class="right mono">—</div>
      </div>
    </div>
  </div>

  <!-- BIG toggle bar for advanced metrics -->
  <details id="advMetricsBox" class="adv-metrics">
   <summary class="adv-btn-summary">
  <button type="button" id="advToggleBtn" class="btn copycat-btn">
    Show advanced metrics
  </button>
</summary>


    <div class="adv-body">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:18px; margin-top:12px">
        <div class="card" style="padding:12px">
          <div class="muted">Stylometry</div>
          <div class="kv">
            <div>Function word ratio</div><div id="sty_func" class="right mono">—</div>
            <div>Hapax ratio</div><div id="sty_hapax" class="right mono">—</div>
            <div>Sent. mean</div><div id="sty_smean" class="right mono">—</div>
            <div>Sent. var</div><div id="sty_svar" class="right mono">—</div>
            <div>Δlogp mean</div><div id="sty_mlps" class="right mono">—</div>
            <div>Δlogp var</div><div id="sty_mlpsv" class="right mono">—</div>
            <div>Punct entropy</div><div id="sty_pent" class="right mono">—</div>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div class="muted">Nonsense guard</div>
          <div class="kv">
            <div>Rhyme density</div><div id="ns_rhyme" class="right mono">—</div>
            <div>Meter CV</div><div id="ns_meter" class="right mono">—</div>
            <div>Invented word ratio</div><div id="ns_inv" class="right mono">—</div>
            <div>Lex hits</div><div id="ns_lex" class="right mono">—</div>
            <div>Semantic discontinuity</div><div id="ns_sem" class="right mono">—</div>
          </div>
        </div>

        <div id="fpBox" class="card" style="padding:12px; display:none">
          <div class="muted">LLM fingerprint (experimental)</div>
          <div class="kv">
            <div>Top style</div><div id="fpTop" class="right mono">—</div>
            <div>Band</div><div id="fpBandCard" class="right mono">—</div>
            <div>Drift / PD</div><div id="fpSpread" class="right mono">—</div>
            <div>Notes</div><div id="fpNotes" class="right muted">—</div>
          </div>
        </div>

        <!-- Drift Diagnostics -->
        <div id="driftBox" class="card" style="margin-top:12px; padding:12px; display:none">
          <div class="muted">Drift diagnostics</div>
          <div id="driftContent" class="kv" style="margin-top:8px"></div>
        </div>

        <!-- LLM Fingerprint canvas -->
        <div id="llmBox" class="card" style="margin-top:12px; padding:12px; display:none">
          <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
            <div>
              <div class="muted">LLM fingerprint (experimental)</div>
              <div class="mono" style="margin-top:4px;">
                Nearest: <span id="llmFamily">—</span>
                • Conf: <span id="llmConf">—</span>
                • Human score: <span id="llmHuman">—</span>
              </div>
            </div>
            <span class="pill" id="llmBand">—</span>
          </div>

          <div style="margin-top:10px;">
            <canvas id="llmCanvas" height="120" style="width:100%; max-width:480px; display:block;"></canvas>
          </div>

          <div id="llmLegend" class="mono muted" style="margin-top:6px; font-size:.9em;">
            <!-- filled by JS -->
          </div>
        </div>

        <!-- Raw JSON stays advanced as well -->
        <details id="rawJsonBox" style="margin-top:8px">
          <summary>Raw /scan JSON</summary>
          <pre id="rawDump" style="white-space:pre-wrap;"></pre>
        </details>
      </div>

      <div class="footer">CSV log and a PDF report are generated server-side per scan.</div>
    </div>
  </details>
</div>


      <div id="err" class="footer" style="color:#ff9f9f;display:none"></div>

      <!-- NEW: LCARS side panel sitting at the bottom of the right card -->



 

    </section>

    <!-- Right -->
   <section class="card" aria-label="Runtime Settings">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Runtime Settings</h2>
        <span class="pill" id="activeModeBadge">Mode: —</span>
      </div>

      <div class="grid" style="gap:16px">
        <div class="row">
          <input id="use_ensemble" type="checkbox" />
          <label for="use_ensemble">Use ensemble (if secondary model loaded)</label>
          <span class="help-dot" tabindex="0"><span class="tip">If a secondary model is available, combine its judgment with the primary model for a steadier verdict. Slightly slower, often more stable.</span></span>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_mode">Default mode</label>
              <span class="help-dot" tabindex="0"><span class="tip">Balanced = general. Strict = more conservative on “human”. Academic = tuned to longer formal prose.</span></span>
            </div>
            <select id="cfg_mode"><option>Balanced</option><option>Strict</option><option>Academic</option></select>
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_min_tokens">Min tokens strong</label>
              <span class="help-dot" tabindex="0"><span class="tip">Minimum token count before we allow a strong decision. Below this size, detector stays cautious.</span></span>
            </div>
            <input id="cfg_min_tokens" type="number" min="1" step="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div class="row">
            <input id="cfg_short_cap" type="checkbox" />
            <label for="cfg_short_cap">Cap short excerpts</label>
            <span class="help-dot" tabindex="0"><span class="tip">Short inputs can look over-confident. This applies a ceiling when the text is tiny.</span></span>
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_max_conf_short">Max conf (short)</label>
              <span class="help-dot" tabindex="0"><span class="tip">Confidence ceiling (0–1) when text length is below the short-excerpt threshold.</span></span>
            </div>
            <input id="cfg_max_conf_short" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_non_en_cap">Non-EN cap</label>
              <span class="help-dot" tabindex="0"><span class="tip">If the passage doesn’t look English, cap confidence to avoid language-mismatch errors.</span></span>
            </div>
            <input id="cfg_non_en_cap" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_en_thresh">EN threshold</label>
              <span class="help-dot" tabindex="0"><span class="tip">Threshold (0–1) to consider text English. Below this, Non-EN safeguards can apply.</span></span>
            </div>
            <input id="cfg_en_thresh" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_max_unstable">Max conf (unstable)</label>
              <span class="help-dot" tabindex="0"><span class="tip">Ceiling when internal instability is detected (volatile token probabilities).</span></span>
            </div>
            <input id="cfg_max_unstable" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_abstain_low">Abstain low</label>
              <span class="help-dot" tabindex="0"><span class="tip">Lower bound of the “Inconclusive” band. If probability is in this band, we abstain.</span></span>
            </div>
            <input id="cfg_abstain_low" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_abstain_high">Abstain high</label>
              <span class="help-dot" tabindex="0"><span class="tip">Upper bound of the “Inconclusive” band. Keeps borderline cases from over-confidence.</span></span>
            </div>
            <input id="cfg_abstain_high" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;gap:12px">
          <div class="help-wrap">
            <button id="btnReset" class="btn ghost">Reset (reload)</button>
            <span class="help-dot" tabindex="0"><span class="tip">Reload the page and revert UI state.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnSave" class="btn">Save Settings</button>
            <span class="help-dot" tabindex="0"><span class="tip">Persist these settings server-side for future scans.</span></span>
          </div>
        </div>
        <div id="saveStatus" class="muted"></div>
      </div>

      <div class="footer">PD fingerprints: place JSONs in <span class="mono">./pd_fingerprints/</span> on the server.</div>
      <div id="lcarsPanel" class="lcars-panel">
  <div class="lcars-tabs">
    <button
      type="button"
      class="lcars-tab lcars-tab-active"
      data-tab="transparency"
    >
      Transparency
    </button>
    <button type="button" class="lcars-tab" data-tab="tutor">Writing Tutor</button>
    <button type="button" class="lcars-tab" data-tab="style">Style Match</button>
    <button type="button" class="lcars-tab" data-tab="tips">Tips</button>
    <button type="button" class="lcars-tab" data-tab="history">History</button>
    <button type="button" class="lcars-tab" data-tab="safety">Safety</button>
    <button type="button" class="lcars-tab" data-tab="mission">Mission Log</button>
  </div>

  <div class="lcars-tab-content">
    <div id="tab-transparency"
         class="tab-section tab-section-active">
      <p class="muted">
        Breakdown of signals will show here.
        Example: “Burstiness high, function-word ratio human-like,
        model fingerprint: other 5%+.”
      </p>
    </div>

    <div id="tab-tutor" class="tab-section">
      <p class="muted">
        Human Writing Tutor suggestions for clarity, flow, and variation.
      </p>
    </div>

    <div id="tab-style" class="tab-section">
      <p class="muted">
        Style similarity to models / human baselines.
      </p>
    </div>

    <div id="tab-tips" class="tab-section">
      <p class="muted">
        Tips: how to sound more authentic, less “MTL-95”-bot-like.
      </p>
    </div>

    <div id="tab-history" class="tab-section">
      <h4 class="lcars-section-title">History</h4>

      <p class="lcars-subtext">
        History is a running log of recent scans so you can see how your style
        behaves across drafts. It’s useful for students tracking revision effort,
        teachers reviewing genuine improvement, and writers monitoring their own
        voice over time. Each entry captures the verdict, key style signals, and
        drift behavior at the moment you scanned, turning your revisions into a
        visible trail instead of a black box.
      </p>

      <ul id="lcarsHistoryList" class="lcars-history-list">
        <!-- JS will populate this -->
      </ul>
    </div>

    <div id="tab-safety" class="tab-section">
      <p class="muted">
        Safety: toxicity / sentiment / bias diagnostics (future hook).
      </p>
    </div>

    <div id="tab-mission" class="tab-section">
      <p class="muted">
        LCARS Mission Log: stardate, detector status, warp signature,
        style fingerprint, etc.
      </p>
    </div>
  </div>
</div>


    </section>
  </div>
</div>

<!-- Live Verification Drawer -->
<div id="liveDrawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Live Verification drawer">
  <div class="drawer-inner">
    <!-- NEW: resize handle -->
  <div id="liveResizeHandle" aria-hidden="true"></div>
  <!-- …rest of drawer… -->
    <div class="row" style="justify-content:space-between;align-items:center;padding:0 6px 8px">
      <h3 style="margin:0">Live Verification (CopyCat)</h3>
      <button id="btnCloseLive" class="btn ghost">Close</button>
    </div>

    <div id="liveHint" class="muted" style="padding:0 6px 10px">
      Paste text above and run a scan first. Then start a live sample to compare your typing style.
    </div>

        <div class="split" style="padding:0 6px 14px">
      <!-- LEFT column -->
      <div class="live-left">
        <textarea id="liveInput" placeholder="Type here for 60–120 words…" rows="7"
                  style="width:100%; resize:vertical; font-family:system-ui, sans-serif;" disabled
                  aria-label="Live typing area"></textarea>
        <div class="row" style="margin-top:10px; flex-wrap:wrap; gap:10px">
          <div class="help-wrap">
            <button id="btnStartLive" class="btn" disabled>Start Live Sample (90s)</button>
            <span class="help-dot" tabindex="0"><span class="tip">Starts a 90-second typing window and shows live token count and progress.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnFinalize" class="btn ghost" aria-live="polite">Finalize</button>
            <span class="help-dot" tabindex="0"><span class="tip">Compute the quick style-match between your typed sample and the scanned text.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnExport" class="btn ghost" disabled>Copy Summary</button>
            <span class="help-dot" tabindex="0"><span class="tip">Copy a plain-text summary of the scan + live sample (verdict, key metrics, quick match).</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnDownload" class="btn ghost" disabled>Download .txt</button>
            <span class="help-dot" tabindex="0"><span class="tip">Download the same summary as a .txt file (works even when clipboard is blocked).</span></span>
          </div>
          <span id="exportStatus" class="muted" style="margin-left:8px;" aria-live="polite"></span>
        </div>
      </div>

      <!-- RIGHT column -->
      <div class="live-right">
        <div class="card" style="padding:10px;">
          <div class="live-metrics-header">
            <div class="row" style="gap:18px; margin-bottom:4px;">
              <div>Time: <span id="liveTimer">—</span></div>
              <div>Tokens: <span id="liveTokens">0</span> <small class="muted">(words)</small></div>
              <div>Len: <span id="liveLen">0%</span> <small class="muted">(of 120 target)</small></div>
              <div>Match: <span id="liveRough">—</span> <small class="muted">(quick)</small></div>
            </div>

            <div class="live-tabs" role="tablist" aria-label="Live view">
              <button type="button" class="live-tab active" data-tab="summary" role="tab" aria-selected="true">
                Style Match
              </button>
              <button type="button" class="live-tab" data-tab="drift" role="tab" aria-selected="false">
                Consistency Check
              </button>
            </div>
          </div>

      <div class="progress"><span id="liveProgress" style="width:0%"></span></div>

      <div id="liveResult" style="margin-top:10px;" aria-live="polite"></div>

<!-- Drift compare lives inside the same card now -->
<div id="liveDriftBox" style="margin-top:10px; display:none">
  <div class="muted">Drift compare (scan vs live sample)</div>
  <div id="liveDriftContent" class="kv" style="margin-top:6px"></div>

  <!-- CAT + BUTTERFLY SCENE -->
  <div id="liveFunZone">
    <!-- CAT: sprite-based mascot -->
  <!--   <div
      class="cat"
      role="img"
      aria-label="CopyCat mascot"
    ></div> -->

    <!-- BUTTERFLY #1 (solo → then top of triangle) -->
   <!--  <svg class="butterfly b1" viewBox="0 0 80 60" aria-hidden="true">
      <g class="butterfly-body">
        <ellipse cx="30" cy="22" rx="11" ry="14" />
        <ellipse cx="50" cy="22" rx="11" ry="14" />
        <ellipse cx="28" cy="38" rx="9" ry="12" />
        <ellipse cx="52" cy="38" rx="9" ry="12" />
        <rect x="38" y="22" width="4" height="20" rx="2" />
        <path d="M40 22 C35 14 33 12 30 10" />
        <path d="M40 22 C45 14 47 12 50 10" />
      </g>
    </svg> -->

    <!-- BUTTERFLY #2 -->
   <!--  <svg class="butterfly b2" viewBox="0 0 80 60" aria-hidden="true">
      <g class="butterfly-body">
        <ellipse cx="30" cy="22" rx="11" ry="14" />
        <ellipse cx="50" cy="22" rx="11" ry="14" />
        <ellipse cx="28" cy="38" rx="9" ry="12" />
        <ellipse cx="52" cy="38" rx="9" ry="12" />
        <rect x="38" y="22" width="4" height="20" rx="2" />
        <path d="M40 22 C35 14 33 12 30 10" />
        <path d="M40 22 C45 14 47 12 50 10" />
      </g>
    </svg> -->

    <!-- BUTTERFLY #3 -->
   <!--  <svg class="butterfly b3" viewBox="0 0 80 60" aria-hidden="true">
      <g class="butterfly-body">
        <ellipse cx="30" cy="22" rx="11" ry="14" />
        <ellipse cx="50" cy="22" rx="11" ry="14" />
        <ellipse cx="28" cy="38" rx="9" ry="12" />
        <ellipse cx="52" cy="38" rx="9" ry="12" />
        <rect x="38" y="22" width="4" height="20" rx="2" />
        <path d="M40 22 C35 14 33 12 30 10" />
        <path d="M40 22 C45 14 47 12 50 10" />
      </g>
    </svg> -->

    <!-- BUTTERFLY #4 (swarm-only) -->
   <!--  <svg class="butterfly b4" viewBox="0 0 80 60" aria-hidden="true">
      <g class="butterfly-body">
        <ellipse cx="30" cy="22" rx="11" ry="14" />
        <ellipse cx="50" cy="22" rx="11" ry="14" />
        <ellipse cx="28" cy="38" rx="9" ry="12" />
        <ellipse cx="52" cy="38" rx="9" ry="12" />
        <rect x="38" y="22" width="4" height="20" rx="2" />
        <path d="M40 22 C35 14 33 12 30 10" />
        <path d="M40 22 C45 14 47 12 50 10" />
      </g>
    </svg> -->
  <div class="muted" id="liveProgressLabel" style="margin-bottom:4px;">
     Live sample progress
  </div>
   <div class="progress">
      <span id="liveProgressWide" style="width:0%"></span>
  </div>
</div>


<script>

// --- Demo Mode Sample Texts ---
const DEMO_SAMPLES = {
  "news": `Breaking: A new AI-driven policing system has sparked debate...`,
  "story": `Once the lantern flickered out, Mara realized she wasn't alone...`,
  "essay": `The socioeconomic impact of automation continues to reshape...`,
  "code": `def analyze_text(t):\n    return {"len": len(t)}`,
};

// --- Demo presets ---
const DEMO_PRESET_LABELS = {
  random: "(random curated sample)",
  news:   "News / op-ed",
  story:  "Story / narrative",
  essay:  "Student-style essay",
  code:   "Short code snippet",
};

let currentDemoPreset = "random";

function initDemoPresetSelect() {
  const sel = document.getElementById("demoPreset");
  if (!sel) return;

  // Build options from the label map
  sel.innerHTML = Object.entries(DEMO_PRESET_LABELS)
    .map(([value, label]) => `<option value="${value}">${label}</option>`)
    .join("");

  sel.value = currentDemoPreset;

  sel.addEventListener("change", (e) => {
    const v = String(e.target.value || "").trim();
    currentDemoPreset = DEMO_PRESET_LABELS[v] ? v : "random";
  });
}


/* -------- v0.3.5 -------- */
window.__pdCentroids = 0;
/* ---------- helpers ---------- */
const LCARS_HISTORY_KEY = "copycat_scan_history_v1";

const $ = s => document.querySelector(s);
const api = (p,opts={}) => fetch(p,opts).then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); });
const setMsg = (id,txt)=>{ const el=$( '#'+id ); if(el) el.textContent = txt; };
function setFinalizeEnabled(on){ $("#btnFinalize").disabled = !on; }
function setExportEnabled(on){
  const c=$("#btnExport"), d=$("#btnDownload");
  if(c) c.disabled = !on;
  if(d) d.disabled = !on;
}

/* Drift Diagnostics */
async function driftAnalyze(text){
  const r = await fetch("/drift/analyze", {
    method:"POST", headers:{ "content-type":"application/json" },
    body: JSON.stringify({ text })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* Drift Diagnostics */
async function driftAnalyze(text) {
  const r = await fetch("/drift/analyze", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ text })
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

/* Drift compare: scan vs live sample */
async function driftCompare(scanText, liveText) {
  const resp = await fetch("/drift/compare", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      scan_text: scanText,   // <-- must match the Python model field names
      live_text: liveText
    })
  });

  if (!resp.ok) {
    throw new Error(await resp.text());
  }
  return resp.json();
}

// Example render (stick this where you show scan extras)
async function showDriftForCurrent(){
  const text = document.querySelector("#text")?.value || "";
  if(!text.trim()){ alert("Paste text first."); return; }
  const j = await driftAnalyze(text);
  const el = document.getElementById("liveResult") || document.body;
  el.innerHTML =
    `<div class="kv" style="margin-top:8px">
       <div>Paragraphs</div><div class="mono">${j.paragraphs}</div>
       <div>Avg adj. sim</div><div class="mono">${j.avg_adjacent_sim}</div>
       <div>Std adj. sim</div><div class="mono">${j.std_adjacent_sim}</div>
       <div>Risk</div><div class="mono">${j.risk}</div>
       <div>Score (human-like)</div><div class="mono">${j.score}</div>
     </div>`;
}


/* Toggle help on click (outside click / Esc closes) */
document.addEventListener("click", (e)=>{
  const dot = e.target.closest(".help-dot");
  document.querySelectorAll(".help-dot[data-open='1']").forEach(el=>{ if(el!==dot) el.removeAttribute("data-open"); });
  if (dot){ dot.setAttribute("data-open", dot.getAttribute("data-open")==="1" ? "0" : "1"); }
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){ document.querySelectorAll(".help-dot[data-open='1']").forEach(el=>el.removeAttribute("data-open")); closeLive(); }
  if((e.metaKey||e.ctrlKey) && e.key==="Enter"){ finalizeCompute(); }
});

/* UI scale */
$("#uiScale").addEventListener("input", (e)=>{
  const v = Math.max(120, Math.min(220, parseInt(e.target.value||"150",10)));
  document.documentElement.style.setProperty("--scale", (v/100).toString());
});

/* Drawer */
const drawer = $("#liveDrawer");
const openLive = ()=>{ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); };
const closeLive = ()=>{ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); };
$("#btnLive").addEventListener("click", openLive);
$("#btnCloseLive").addEventListener("click", closeLive);

/* ---- Live drawer resize ---- */
(function initLiveResize(){
  const handle = $("#liveResizeHandle");
  if (!handle) return;

  let dragging = false;

  // clamp + apply height (in px)
  function setLiveHeight(px){
    const min = 160;
    const max = Math.max(260, window.innerHeight * 0.85);
    const clamped = Math.min(max, Math.max(min, px));
    document.documentElement.style.setProperty("--live-h", clamped + "px");
  }

  function onMove(e){
    if (!dragging) return;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    const h = window.innerHeight - clientY;   // distance from cursor to bottom
    setLiveHeight(h);
  }

  function stopDrag(){
    if (!dragging) return;
    dragging = false;
    document.removeEventListener("mousemove", onMove);
    document.removeEventListener("mouseup", stopDrag);
    document.removeEventListener("touchmove", onMove);
    document.removeEventListener("touchend", stopDrag);
    document.removeEventListener("touchcancel", stopDrag);
  }

  function startDrag(e){
    dragging = true;
    e.preventDefault();
    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", stopDrag);
    document.addEventListener("touchmove", onMove, { passive:false });
    document.addEventListener("touchend", stopDrag);
    document.addEventListener("touchcancel", stopDrag);
  }

  handle.addEventListener("mousedown", startDrag);
  handle.addEventListener("touchstart", startDrag, { passive:false });

  // keep height sensible when the window resizes
  window.addEventListener("resize", ()=>{
    const h = parseFloat(getComputedStyle(document.documentElement)
      .getPropertyValue("--live-h")) || (window.innerHeight * 0.4);
    setLiveHeight(h);
  });
})();


/* UI writers */
function setProbFill(p){
  const pct   = Math.round((p || 0) * 100);
  const label = pct + "%";

  // Text in the Result row
  const pctEl = $("#probPct");
  if (pctEl) pctEl.textContent = label;

  // Text in the center of the donut
  const centerEl = $("#probPctCenter");
  if (centerEl) centerEl.textContent = label;

  // Donut stroke
  const donut = document.querySelector(".prob-donut .donut-val");
  if (donut){
    const clamped = Math.max(0, Math.min(1, p || 0));
    const radius = 16;                           // matches SVG r
    const circumference = 2 * Math.PI * radius;  // ~100.53

    donut.style.strokeDasharray  = `${circumference} ${circumference}`;
    donut.style.strokeDashoffset = `${circumference * (1 - clamped)}`;
  }



  // Fallback: if bar still exists anywhere, keep it in sync
  const f = $("#probFill");
  if (f){
    f.style.width = pct + "%";
    f.classList.remove("good","warn","bad");
    f.classList.add(
      p >= 0.65 ? "bad" :
      p >= 0.35 ? "warn" :
                  "good"
    );
  }
}

function setVerdict(v){
  const pill = $("#verdictPill");
  pill.textContent = v || "—";
  const L = (v||"").toLowerCase();
  const c = L.includes("human") ? "#163626" :
            L.includes("inconclusive") ? "#2f2a12" : "#3a1b1b";
  pill.style.background = c; pill.style.borderColor = "var(--border)";
}
function setModeBadge(m){ $("#activeModeBadge").textContent = "Mode: " + (m||"—"); }
function shortExplain(r){
  if (r?.explanation) return r.explanation;
  const top10 = r?.bins ? Math.round((r.bins[10]/Math.max(1,r.total))*100) : 0;
  return `${r?.verdict||""} — PPL≈${(r?.ppl||0).toFixed(1)}, Top10≈${top10}%`.trim();
}

/* numeric helpers */
const pickNum = (...c)=>{ for(const v of c){ const n=Number(v); if(Number.isFinite(n)) return n; } return null; };
const setTxt = (sel,val,d=3)=>{ const el=$(sel); if(!el) return; if(val==null){ el.textContent="—"; return; } const n=Number(val); el.textContent=Number.isFinite(n)?n.toFixed(d):String(val); };

/* Token table */
function cleanTok(t){
  if (t === "Ċ") return "↵";
  if (t === "Ġ") return "␠";
  return t.replace(/^Ġ/," ")
          .replace(/âĢĿ/g,"“").replace(/âĢĺ/g,"”")
          .replace(/âĢĶ/g,"‘").replace(/âĢĺ/g,"’");
}

function safeSetHTML(el, html){ if(el) el.innerHTML = html; }
function safeSetText(el, txt){ if(el) el.textContent = txt; }

function fillTokenTable(tokens){
  const tbWrap = document.querySelector("#tokTable tbody");
  if (!tbWrap) return;                 // v0.3.4 fallback (no table or id changed)
  tbWrap.innerHTML = "";
  (tokens||[]).forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td class="mono">${i+1}</td>`+
      `<td class="mono">${cleanTok(t.t)}</td>`+
      `<td class="mono">${t.rank}</td>`+
      `<td class="mono">${(t.p||0).toFixed(6)}</td>`;
    tbWrap.appendChild(tr);
  });
}

function setBandBadge(band, pctText){
  const badge = document.getElementById('bandBadge');
  if (!badge) return;
  const dot  = badge.querySelector('.badge-dot');
  const text = document.getElementById('bandText');
  const pct  = document.getElementById('bandPct');

  badge.classList.remove('band-human','band-mixed','band-ai');

  let cls='band-mixed', dotCls='dot-mixed', label = band || 'Inconclusive';
  const b = (band||'').toLowerCase();
  if (b.includes('human')) { cls='band-human'; dotCls='dot-human'; }
  else if (b.includes('ai')) { cls='band-ai'; dotCls='dot-ai'; }

  badge.classList.add(cls);
  if (dot)  dot.className = 'badge-dot ' + dotCls;
  if (text) text.textContent = label;
  if (pct)  pct.textContent  = pctText ? `• ${pctText}` : '';
  badge.style.display = 'inline-flex';
}


function renderExplain(explain, fullJson) {
  const wrap     = document.getElementById('explainWrap');
  const head     = document.getElementById('explainHeadline');
  const why      = document.getElementById('explainWhy');
  const fix      = document.getElementById('explainFix');
  const notes    = document.getElementById('explainNotes');
  const mini     = document.getElementById('teacherMini');
  const title    = document.getElementById('explainTitle');
  const panel    = document.getElementById('explainPanel');
  const openBtn  = document.getElementById('btnExplainPanel');

  if (!wrap) return;

  // No explanation payload → disable button, keep panel closed
  if (!explain) {
    if (openBtn) {
      openBtn.disabled = true;
      openBtn.classList.add('disabled');
    }
    if (panel) {
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
    }
    return;
  }

  // Enable “What this means” button once we have data
  if (openBtn) {
    openBtn.disabled = false;
    openBtn.classList.remove('disabled');
  }

  // Badge (if present)
  if (document.getElementById('bandBadge')) {
    setBandBadge(explain.band, explain.ai_likelihood_pct);
  }

  // Header + sections
  if (title) {
    // keep text in case you ever surface it somewhere else
    title.textContent = 'What this means';
  }

  safeSetHTML(head, `<b>${explain.headline || ''}</b>`);

  const asList = a => Array.isArray(a) ? a.filter(Boolean) : [];

  const whyList = asList(explain.why).map(s => `<li>${s}</li>`).join('');
  safeSetHTML(
  why,
  whyList
    ? `<b>Why CopyCat thinks this</b><ul class="explain-list">${whyList}</ul>`
    : ''
);

  const fixList = asList(explain.what_to_fix).map(s => `<li>${s}</li>`).join('');
  safeSetHTML(
  fix,
  fixList
    ? `<b>How to strengthen your draft</b><ul class="explain-list">${fixList}</ul>`
    : ''
);

  const notesText = asList(explain.notes).join(' ');
  safeSetHTML(
  notes,
  notesText ? `<b>Extra context</b> ${notesText}` : ''
);

  // Compact teacher row
  if (mini) {
    const t = explain.teacher_report || {};
    const parts = [];
    if (t.nearest_style) parts.push(`Closest style: ${t.nearest_style}`);
    if (t.drift_score != null) parts.push(`Drift score: ${Number(t.drift_score).toFixed(3)}`);
    if (t.pd_overlap_j != null) parts.push(`PD overlap J: ${t.pd_overlap_j}`);
    mini.textContent = parts.join(' • ');
  }

  // PD note
  if (notes) {
    if (!Number(window.__pdCentroids || 0)) {
      const msg = "Public-domain fingerprinting is off on this server (no centroids loaded). PD overlap shows ‘—’. Add JSON centroids to ./pd_fingerprints/ and restart.";
      const prefix = notes.innerHTML ? "<br/>" : "";
      notes.innerHTML += prefix + `<b>PD note:</b> ${msg}`;
    }
  }

  // No internal hide/show toggle anymore—panel handles visibility.
}


function renderFingerprint(result) {
  const box      = document.getElementById("fpBox");
  const labelEl  = document.getElementById("fpLabel");
  const bandEl   = document.getElementById("fpBand");
  const topEl    = document.getElementById("fpTop");
  const bandCard = document.getElementById("fpBandCard");
  const spreadEl = document.getElementById("fpSpread");
  const notesEl  = document.getElementById("fpNotes");

  if (!box) return;

  // Try a few common shapes for the payload
  const fp = result?.llm_fingerprint
          || result?.fingerprint
          || result?.fp
          || null;

  // Nothing to show → hide the card and clear fields
  if (!fp) {
    box.style.display = "none";
    if (labelEl)  labelEl.textContent  = "—";
    if (bandEl)   bandEl.textContent   = "—";
    if (topEl)    topEl.textContent    = "—";
    if (bandCard) bandCard.textContent = "—";
    if (spreadEl) spreadEl.textContent = "—";
    if (notesEl)  notesEl.textContent  = "—";
    return;
  }

  // Expanded fallbacks so we handle both old/new backend shapes
  const top = fp.nearest
           ?? fp.top_style
           ?? fp.top
           ?? fp.family
           ?? fp.label
           ?? "—";

  const band = fp.band
            ?? fp.band_label
            ?? fp.bucket
            ?? "—";

  const spread = fp.spread
              ?? fp.drift
              ?? fp.pd_spread
              ?? fp.pd
              ?? null;

  const notes = fp.notes
             || fp.note
             || fp.comment
             || fp.explain
             || "";

  // Summary row pills
  if (labelEl)  labelEl.textContent  = top;
  if (bandEl)   bandEl.textContent   = band;

  // Card contents
  if (topEl)    topEl.textContent    = top;
  if (bandCard) bandCard.textContent = band;
  if (spreadEl) spreadEl.textContent = spread == null ? "—" : String(spread);
  if (notesEl)  notesEl.textContent  = notes || "—";

  box.style.display = "block";
}

function renderDrift(raw) {
  const box = document.getElementById("driftBox");
  const content = document.getElementById("driftContent");
  if (!box || !content) return;

  const safeNum = (v, d = 3) => {
  if (typeof v !== "number" || !Number.isFinite(v)) return "—";
  return v.toFixed(d);
  };


  // No payload → hide card
  if (!raw) {
    box.style.display = "none";
    content.innerHTML = "";
    return;
  }

  // New: backend nests the drift info under `semantic_drift`
  const j = raw.semantic_drift || raw;

  // Handle the “not available” case if backend ever sends it
  if (j.available === false) {
    box.style.display = "block";
    content.innerHTML = `
      <div>Paragraphs</div><div class="mono">${j.paragraphs ?? "—"}</div>
      <div>Status</div><div class="mono">
        ${j.reason === "single_paragraph"
          ? "Need at least two paragraphs to measure semantic drift."
          : (j.reason || "Drift diagnostics not available.")}
      </div>
    `;
    return;
  }

  // Normal case: we have real stats
  box.style.display = "block";
  content.innerHTML = `
    <div>Paragraphs</div><div class="mono">${j.paragraphs ?? raw.paragraphs ?? "—"}</div>
    <div>Avg adjacent similarity</div><div class="mono">${safeNum(j.avg_adjacent_sim)}</div>
    <div>Std adjacent similarity</div><div class="mono">${safeNum(j.std_adjacent_sim)}</div>
    <div>Risk</div><div class="mono">${safeNum(j.risk)}</div>
    <div>Score (human-like)</div><div class="mono">${safeNum(j.score)}</div>
  `;
}

function renderLiveDrift(raw) {
  const box = document.getElementById("liveDriftBox");
  const content = document.getElementById("liveDriftContent");
  if (!box || !content) return;

  const safeNum = (v, d = 3) =>
    (typeof v === "number" && Number.isFinite(v)) ? v.toFixed(d) : "—";

  // No payload at all → generic message
  if (!raw) {
    box.style.display = "block";
    content.innerHTML =
      `<div class="mono">Drift compare not available for this sample.</div>`;
    return;
  }

  // Many backends will wrap the actual compare result
  const cmp = raw.compare || raw.c || raw;

  // Only trust explicit fields from the backend
  const sim = (typeof cmp.similarity === "number")
    ? cmp.similarity
    : (typeof cmp.sim === "number" ? cmp.sim : null);

  const score = (typeof cmp.score === "number") ? cmp.score : null;
  const risk  = (typeof cmp.risk  === "number") ? cmp.risk  : null;

  const overlap = (typeof cmp.overlap === "number")
    ? cmp.overlap
    : (typeof cmp.jaccard === "number" ? cmp.jaccard : null);

  const haveAny = [sim, score, risk, overlap].some(
    v => typeof v === "number" && Number.isFinite(v)
  );

  // If the backend doesn’t provide actual compare metrics yet,
  // don’t fabricate numbers – just explain that it’s not wired.
    if (!haveAny) {
    box.style.display = "block";
    content.innerHTML = `
      <div class="mono">
        Drift compare is not fully wired on this build:
        the backend isn’t sending numeric similarity / risk metrics yet.
        <br><br>
        TODO (next release): implement /drift/compare in the backend
        and return similarity / overlap / risk fields so this panel
        can show real numbers.
      </div>
    `;
    return;
  }


  // Normal case: show what the backend really sent
  box.style.display = "block";
  content.innerHTML = `
    <div>Similarity</div><div class="mono">${safeNum(sim)}</div>
    <div>Score (human-like)</div><div class="mono">${safeNum(score)}</div>
    <div>Risk</div><div class="mono">${safeNum(risk)}</div>
    <div>Overlap</div><div class="mono">${safeNum(overlap)}</div>
  `;
}



function initLiveTabs(){
  const tabs = document.querySelectorAll(".live-tab");
  if (!tabs.length) return;

  const liveResult = document.getElementById("liveResult");
  const driftBox   = document.getElementById("liveDriftBox");

  function activate(name){
    tabs.forEach(t => {
      const isActive = (t.dataset.tab === name);
      t.classList.toggle("active", isActive);
      t.setAttribute("aria-selected", isActive ? "true" : "false");
    });

    if (liveResult) liveResult.style.display = (name === "summary") ? "block" : "none";
    if (driftBox)   driftBox.style.display   = (name === "drift")    ? "block" : "none";
  }

  tabs.forEach(t => {
    t.addEventListener("click", () => {
      const tabName = t.dataset.tab || "summary";
      activate(tabName);
    });
  });

  // default view
  activate("summary");
}

function renderLlmFingerprint(result) {
  const box      = document.getElementById("llmBox");
  const bandPill = document.getElementById("llmBand");
  const famEl    = document.getElementById("llmFamily");
  const confEl   = document.getElementById("llmConf");
  const humanEl  = document.getElementById("llmHuman");
  const legendEl = document.getElementById("llmLegend");
  const canvas   = document.getElementById("llmCanvas");

  if (!box) return;

  const fp =
    result?.llm_fingerprint ||
    result?.fingerprint ||
    result?.fp ||
    null;

  if (!fp || fp.available === false) {
    box.style.display = "none";
    if (bandPill) bandPill.textContent = "—";
    if (famEl)    famEl.textContent    = "—";
    if (confEl)   confEl.textContent   = "—";
    if (humanEl)  humanEl.textContent  = "—";
    if (legendEl) legendEl.textContent = "";
    if (canvas && canvas.getContext) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    return;
  }

  box.style.display = "block";

  const family =
    fp.nearest_family ||
    fp.family ||
    fp.nearest ||
    fp.top_style ||
    fp.top ||
    fp.label ||
    "Unknown";

  const dist = fp.distribution || fp.similarity || {};
  const labels = Object.keys(dist);
  const values = labels.map(k => Number(dist[k]) || 0);

  const conf = typeof fp.confidence === "number" ? fp.confidence : null;
  const humanScore =
    typeof fp.human_score === "number"
      ? fp.human_score
      : (typeof fp.human === "number" ? fp.human : null);

  // Band pill based on humanScore
  let band = "—";
  if (typeof humanScore === "number") {
    if (humanScore >= 0.8) band = "Human-like";
    else if (humanScore <= 0.2) band = "Model-like";
    else band = "Mixed";
  }

  if (famEl)    famEl.textContent    = family;
  if (bandPill) bandPill.textContent = band;
  if (confEl)   confEl.textContent   = conf == null ? "—" : `${(conf * 100).toFixed(1)}%`;
  if (humanEl)  humanEl.textContent  = humanScore == null ? "—" : humanScore.toFixed(3);

  // Legend line
  if (legendEl) {
    const bits = [];
    if (labels.length) {
      bits.push(
        "Distribution: " +
        labels.map(k => `${k} ${(dist[k] * 100).toFixed(1)}%`).join(" · ")
      );
    }
    legendEl.textContent = bits.join("  |  ");
  }

  // Simple bar visualization for human_score, if we have it
  if (canvas && canvas.getContext && typeof humanScore === "number") {
    const ctx = canvas.getContext("2d");
    const w   = canvas.width;
    const h   = canvas.height;

    ctx.clearRect(0, 0, w, h);

    ctx.fillStyle = "rgba(255,255,255,0.08)";
    ctx.fillRect(0, h / 2 - 2, w, 4);

    const barW = Math.max(4, Math.min(w, w * Math.max(0, Math.min(1, humanScore))));
    ctx.fillStyle = "rgba(79,134,255,0.9)";
    ctx.fillRect(0, h / 2 - 6, barW, 12);
  }
}



/* ---------- Live verification ---------- */
let lastScanMetrics = null;
let lastScanResult  = null;
let lastExportText  = "";
let didScan = false;
let lastScanText = "";

function tokenizeWords(text){ return (text.toLowerCase().match(/[a-z’']+|\d+|[^\s\w]/g) || []); }
const FN_WORDS = new Set(("a,an,the,of,to,in,for,with,on,at,by,from,as,that,this,which,who,whom,whose,and,or,but,if,then,so,because,while,where,about,into,over,after,before,between,through,during,without,within,against,under,above,across,around,per,via,is,am,are,was,were,be,been,being").split(","));
function punctEntropy(text){
  const punct = text.match(/[.,;:!?()-]/g) || []; if(!punct.length) return 0;
  const counts={}; punct.forEach(p=>counts[p]=(counts[p]||0)+1);
  const N=punct.length; let H=0; for(const k in counts){ const p=counts[k]/N; H-=p*Math.log2(p); } return H;
}
function simpleMetrics(text){
  const tokens = tokenizeWords(text);
  const words = tokens.filter(t=>/^[a-z’']+$/.test(t));
  const n = words.length || 1;
  const uniq = new Set(words).size;
  const fnCount = words.reduce((a,w)=>a+(FN_WORDS.has(w)?1:0),0);
  const func_ratio = fnCount/n;
  const hapax_ratio = uniq/n;
  const sentences = text.split(/(?<=[.!?])\s+/).filter(s=>s.trim().length>0);
  const lens = sentences.map(s => (s.match(/\b\w+\b/g)||[]).length);
  const sent_mean = lens.length ? lens.reduce((a,b)=>a+b,0)/lens.length : 0;
  const sent_var  = lens.length ? lens.reduce((a,b)=>a+(b-sent_mean)**2,0)/lens.length : 0;
  const pent = punctEntropy(text);
  return { func_ratio, hapax_ratio, sent_mean, sent_var, punct_entropy: pent };
}
function cosineSimilarity(a,b){
  const keys=["func_ratio","hapax_ratio","sent_mean","sent_var","punct_entropy"];
  let dot=0,na=0,nb=0; for(const k of keys){ const x=Number(a[k])||0, y=Number(b[k])||0; dot+=x*y; na+=x*x; nb+=y*y; }
  return (na&&nb)?(dot/(Math.sqrt(na)*Math.sqrt(nb))):0;
}
function renderLiveCompare(userM, refM){
  const sim = Math.max(0,Math.min(1,cosineSimilarity(userM,refM)));
  const pct = Math.round(sim*100);
  const fields=[["Function word ratio","func_ratio",3],["Hapax ratio","hapax_ratio",3],["Sent. mean","sent_mean",2],["Sent. var","sent_var",2],["Punct entropy","punct_entropy",3]];
  let html = `<div class="row" style="gap:12px"><strong>Match (quick):</strong> <span class="pill">${pct}%</span></div>`;
  html += `<div class="kv" style="margin-top:8px">`;
  for(const [label,key,d] of fields){
    const u=Number(userM[key])||0, r=Number(refM[key])||0, diff=u-r;
    html += `<div>${label}</div><div class="mono">you ${u.toFixed(d)} • ref ${r.toFixed(d)} • Δ ${(diff>=0?"+":"")}${diff.toFixed(d)}</div>`;
  }
  html += `</div>`;
  return { html, pct };
}

function initAdvToggleButton() {
  const details = document.getElementById("advMetricsBox");
  const btn     = document.getElementById("advToggleBtn");
  if (!details || !btn) return;

  function sync() {
    btn.textContent = details.open
      ? "Hide advanced metrics"
      : "Show advanced metrics";
  }

  details.addEventListener("toggle", sync);
  btn.addEventListener("click", () => {
    details.open = !details.open;
    sync();
  });

  sync();
}


/* ============================
 * LCARS SIDE PANEL: fill tabs after a scan
 * ============================ */

function updateLcarsPanel(result, driftRaw) {
  if (!result) return;

  const prob = Number(result.calibrated_prob ?? result.prob ?? 0);
  const probPct = Math.round(prob * 100);
  const verdict = result.verdict || "—";
  const mode    = result.mode || "Balanced";
  const category = result.category || "—";
  const model   = result.model_name || "—";
  const tag     = (result.tag || result.input_tag || "").trim() || "—";
  const pdJ     = (typeof result.pd_overlap_j === "number")
    ? result.pd_overlap_j.toFixed(3)
    : "—";

  // Normalize drift payload shape
  const drift = driftRaw && (driftRaw.semantic_drift || driftRaw);
  const driftParas = drift ? (drift.paragraphs ?? "—") : "—";
  const driftRisk  = drift && typeof drift.risk === "number"
    ? drift.risk.toFixed(3)
    : "—";
  const driftScore = drift && typeof drift.score === "number"
    ? drift.score.toFixed(3)
    : "—";

  /* ----------------- Transparency tab ------------------- */
  const tabTransparency = document.getElementById("tab-transparency");
  if (tabTransparency) {
    tabTransparency.innerHTML = `
      <h3 class="lcars-section-title">Overall verdict</h3>
      <div class="lcars-kv">
        <div>Verdict</div>
        <div class="mono">
          <span class="lcars-pill-inline ${
            verdict.toLowerCase().includes("human") ? "good" :
            verdict.toLowerCase().includes("inconclusive") ? "warn" : "bad"
          }">
            ${verdict}
          </span>
        </div>

        <div>Calibrated probability</div>
        <div class="mono">${probPct}%</div>

        <div>Category</div>
        <div class="mono">${category}</div>

        <div>Mode</div>
        <div class="mono">${mode}</div>

        <div>Tag</div>
        <div class="mono">${tag}</div>

        <div>Model</div>
        <div class="mono">${model}</div>

        <div>PD overlap J</div>
        <div class="mono">${pdJ}</div>
      </div>
      <p class="lcars-subtext">
        CopyCat exposes the same signals our engine uses internally &mdash; the subtle
        fingerprints that shape a text&rsquo;s behavior more than its meaning. We surface
        pacing rhythm, token variety, repetition curves, and model-style drift so you
        can see what a quick skim or gradebook can&rsquo;t. None of these signals alone
        decide anything; they only form a behavioral profile. Think of this tab as
        the forensic readout: the raw style telemetry that informs the overall
        assessment &mdash; openly, honestly, and without any hidden scoring.
      </p>
    `;
  }

  /* ----------------- Writing Tutor tab ------------------- */
  const tabTutor = document.getElementById("tab-tutor");
  if (tabTutor) {
    const explain = result.explain || {};
    const whyList  = Array.isArray(explain.why) ? explain.why.filter(Boolean) : [];
    const fixList  = Array.isArray(explain.what_to_fix) ? explain.what_to_fix.filter(Boolean) : [];
    const notes    = Array.isArray(explain.notes) ? explain.notes.join(" ") : (explain.notes || "");

    const whyHtml = whyList.length
      ? `<b>Why we think this:</b><ul class="explain-list">${whyList.map(s => `<li>${s}</li>`).join("")}</ul>`
      : `<span class="lcars-empty">No detailed rationale available for this scan.</span>`;

    const fixHtml = fixList.length
      ? `<b>How to strengthen human signal:</b><ul class="explain-list">${fixList.map(s => `<li>${s}</li>`).join("")}</ul>`
      : `<span class="lcars-empty">No specific suggestions returned for this scan.</span>`;

    const notesHtml = notes
      ? `<b>Notes:</b> ${notes}`
      : `<span class="lcars-empty">No additional notes.</span>`;

    tabTutor.innerHTML = `
      <h3 class="lcars-section-title">Human writing tutor</h3>
      <div class="explain-section">${whyHtml}</div>
      <div class="explain-section">${fixHtml}</div>
      <div class="explain-section explain-note">${notesHtml}</div>
      <p class="lcars-subtext">
        This panel offers gentle, real-world polish rooted in <em>your</em> sample&rsquo;s
        style. These suggestions never try to &ldquo;beat detectors&rdquo; or disguise your work;
        they strengthen clarity, pacing, sentence variation, and your personal voice.
        CopyCat treats you like an author, not a suspect &mdash; we highlight ways to
        reinforce your authentic style, reduce accidental monotony, and sharpen
        narrative flow, especially when you&rsquo;re writing fast under a deadline.
      </p>
        <ul class="lcars-history-list">
  <li>Stabilize your tone from intro to conclusion.</li>
  <li>Blend short and long sentences so the rhythm feels lived-in.</li>
  <li>Use concrete nouns and verbs that sound like you, not a template.</li>
</ul>

    `;
  }

  /* ----------------- Style Match tab --------------------- */
  const tabStyle = document.getElementById("tab-style");
  if (tabStyle) {
    const S = result.stylometry
      || result.style
      || result.metrics?.stylometry
      || result.stats?.stylometry
      || {};

    const safe = (v, d = 3) =>
      (typeof v === "number" && Number.isFinite(v)) ? v.toFixed(d) : "—";

    const funcRatio  = safe(S.func_ratio ?? S.function_word_ratio);
    const hapaxRatio = safe(S.hapax_ratio ?? S.hapax);
    const sentMean   = safe(S.sent_mean ?? S.sentence_mean, 2);
    const sentVar    = safe(S.sent_var ?? S.sentence_var, 2);
    const pent       = safe(S.punct_entropy ?? S.punctuation_entropy);

    tabStyle.innerHTML = `
      <h3 class="lcars-section-title">Style match (scan)</h3>
      <div class="lcars-kv">
        <div>Function-word ratio</div><div class="mono">${funcRatio}</div>
        <div>Hapax ratio</div><div class="mono">${hapaxRatio}</div>
        <div>Sentence mean length</div><div class="mono">${sentMean}</div>
        <div>Sentence variance</div><div class="mono">${sentVar}</div>
        <div>Punctuation entropy</div><div class="mono">${pent}</div>
      </div>
      <p class="lcars-subtext">
        Style Match shows how your stylistic fingerprint compares with common
        human-writing baselines and with known model families. A high match score
        doesn&rsquo;t automatically mean &ldquo;AI-written,&rdquo; and a low score doesn&rsquo;t grant
        a free pass. It simply reflects shared characteristics: rhythm, token
        preferences, repetition patterns, and structural habits. Use this tab to
        understand which parts of your style stand out as uniquely yours, and which
        resemble well-known stylistic families on both the human and model side.
      </p>

    `;
  }

  /* ----------------- Tips tab ---------------------------- */
  const tabTips = document.getElementById("tab-tips");
  if (tabTips) {
    const explain = result.explain || {};
    const fixList  = Array.isArray(explain.what_to_fix) ? explain.what_to_fix.filter(Boolean) : [];

    const bullets = fixList.length
      ? fixList
      : [
          "Add a few personal details or concrete examples to strengthen human signal.",
          "Vary sentence length and rhythm to avoid overly uniform structure.",
          "Rephrase any obviously template-like phrases into your natural voice."
        ];

    tabTips.innerHTML = `
      <h3 class="lcars-section-title">Tips to sound more like you</h3>
      <ul class="explain-list">
        ${bullets.map(s => `<li>${s}</li>`).join("")}
      </ul>
      <p class="lcars-subtext">
        Tips are small, low-friction adjustments that keep your writing anchored to
        a strong personal signature, especially in longer assignments or multi-part
        projects. CopyCat focuses on writer empowerment, not trickery: we nudge you
        toward clearer pacing, varied sentence openings, and a steady narrative tone
        so your work reads more like <em>you</em>, not like a generic template or a
        flattened model voice. Treat this tab as practical coaching, not a
        checklist to &ldquo;pass&rdquo; a detector.
      </p>

    `;
  }

  /* ----------------- Safety tab -------------------------- */
  const tabSafety = document.getElementById("tab-safety");
  if (tabSafety) {
    tabSafety.innerHTML = `
      <h3 class="lcars-section-title">Safety diagnostics (advisory)</h3>
      <div class="lcars-kv">
        <div>Toxicity</div><div class="mono">— (not yet implemented)</div>
        <div>Sentiment</div><div class="mono">— (not yet implemented)</div>
        <div>Bias flags</div><div class="mono">— (not yet implemented)</div>
        <div>Drift risk</div><div class="mono">${driftRisk}</div>
        <div>Drift score (human-like)</div><div class="mono">${driftScore}</div>
        <div>Paragraphs analyzed</div><div class="mono">${driftParas}</div>
      </div>
      <p class="lcars-subtext muted">
        Safety diagnostics highlight potential issues but do not replace
        human review or institutional policy.
      </p>
      <ul class="lcars-history-list">
        <li>Keep your thesis and closing paragraph in the same emotional register.</li>
        <li>Vary how you start sentences to avoid mechanical repetition.</li>
        <li>Reserve complex wording for ideas that actually need it.</li>
      </ul>

    `;
  }

  /* ----------------- Mission Log + History --------------- */
  const now = new Date();
  const tsShort = now.toLocaleString(undefined, {
    year: "numeric", month: "short", day: "2-digit",
    hour: "2-digit", minute: "2-digit"
  });

  // Persist history in localStorage
  let history = [];
  try {
    history = JSON.parse(localStorage.getItem(LCARS_HISTORY_KEY) || "[]");
    if (!Array.isArray(history)) history = [];
  } catch {
    history = [];
  }

  history.unshift({
    ts: tsShort,
    verdict,
    probPct,
    mode,
    tag
  });

  history = history.slice(0, 20);
  try {
    localStorage.setItem(LCARS_HISTORY_KEY, JSON.stringify(history));
  } catch (e) {
    console.warn("Failed to store LCARS history:", e);
  }

  const tabHistory = document.getElementById("tab-history");
  if (tabHistory) {
    if (!history.length) {
      tabHistory.innerHTML = `
        <h3 class="lcars-section-title">Recent scans</h3>
        <p class="lcars-empty muted">No previous scans recorded.</p>
      `;
    } else {
      tabHistory.innerHTML = `
        <h3 class="lcars-section-title">Recent scans</h3>
        <ul class="lcars-history-list">
          ${history.map(h => `
            <li>
              <span class="mono">${h.ts}</span> —
              <strong>${h.verdict}</strong>
              (<span class="mono">${h.probPct}%</span>)
              • Mode: <span class="mono">${h.mode}</span>
              • Tag: <span class="mono">${h.tag}</span>
            </li>
          `).join("")}
        </ul>
      `;
    }
  }

  const tabMission = document.getElementById("tab-mission");
  if (tabMission) {
    tabMission.innerHTML = `
      <h3 class="lcars-section-title">Mission log entry</h3>
      <div class="lcars-kv">
        <div>Stardate</div><div class="mono">${tsShort}</div>
        <div>Verdict</div><div class="mono">${verdict}</div>
        <div>Calibrated prob.</div><div class="mono">${probPct}%</div>
        <div>Runtime mode</div><div class="mono">${mode}</div>
      <p class="lcars-subtext">
        Mission Log is your stardate-style record of this scan. It captures detector
        status, runtime mode, stylistic fingerprint IDs, and any notable anomalies
        in one compact entry. In LCARS terms, this is your console report: a trace
        of how CopyCat saw the text at scan time, so you can correlate verdicts,
        tuning changes, and revisions without guesswork or hidden state.
      </p>

    `;
  }
}



/* ---------- Scan ---------- */
async function runScan(){
  const demoOn = $("#demoToggle").checked;

  // Whatever is in the textarea right now
  let text = $("#text").value.trim();
  const hadUserText = text.length > 0;

  // If demo is on AND user hasn’t typed anything,
  // pull from the selected preset instead of random.
  if (demoOn && !hadUserText) {
    const presetSel  = $("#demoPreset");
    const presetKey  = presetSel ? presetSel.value : "random";

    if (presetKey === "random") {
      // Old behavior: random curated sample
      const keys = Object.keys(DEMO_SAMPLES);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    } else if (DEMO_SAMPLES[presetKey]) {
      // Use the requested preset
      text = DEMO_SAMPLES[presetKey];
    } else {
      // Safety fallback: still pick something valid
      const keys = Object.keys(DEMO_SAMPLES);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    }

    // Reflect the chosen text in the textarea so it’s obvious
    $("#text").value = text;
  }

  // If *still* no text, bail with error message
  if (!text) {
    $("#err").style.display = "block";
    $("#err").textContent   = "Please enter some text.";
    return;
  }

  lastScanText = text;
  $("#err").style.display = "none";
  $("#btnScan").disabled  = true;

  // Status text: distinguish demo vs normal
  $("#scanStatus").textContent =
    (demoOn && !hadUserText) ? "Scanning demo sample…" : "Scanning…";

  try {
    const body = {
      text,
      tag:  $("#tag").value.trim() || null,
      mode: $("#mode").value || null,
      demo_mode: demoOn || false   // nice to have for backend / logs
    };

    const r = await api("/scan", {
  method: "POST",
  headers: { "content-type": "application/json" },
  body: JSON.stringify(body)
});

didScan        = true;
lastScanResult = r;


renderExplain(r.explain, r);
renderFingerprint(r);

// Drift diagnostics
let driftForPanel = null;
try {
  const drift = await driftAnalyze(text);
  driftForPanel = drift;        // <— this is the one we pass to LCARS
  renderDrift(drift);
} catch (e) {
  console.warn("Drift diagnostics failed:", e);
  renderDrift(null);
}

// LLM fingerprint card
try {
  renderLlmFingerprint(r);
} catch (e) {
  console.warn("LLM fingerprint render failed:", e);
  renderLlmFingerprint(null);
}

// NEW: feed data into LCARS side panel tabs
try {
  updateLcarsPanel(r, driftForPanel);
} catch (e) {
  console.warn("LCARS panel update failed:", e);
}


    const rawBox = document.getElementById("rawDump");
    if (rawBox) rawBox.textContent = JSON.stringify(r, null, 2);
    document.getElementById("rawJsonBox")?.removeAttribute("open");

    $("#result").style.display = "block";

    // Keep your existing bar logic (even though the bar is visually hidden)
    setProbFill(r.calibrated_prob || 0);
    setVerdict(r.verdict || "—");

    // NEW: drive the donut + center label from calibrated_prob
    const prob = (typeof r.calibrated_prob === "number") ? r.calibrated_prob : null;

    const pctCenter = $("#probPctCenter");
    if (pctCenter) {
      pctCenter.textContent = (prob !== null)
        ? `${Math.round(prob * 100)}% AI`
        : "—";
    }

    updateProbDonut(prob);

    const NS = r.nonsense_signals || {};
    const top10Pct  = Number.isFinite(NS.top10)
      ? Math.round(NS.top10*100)
      : (r.bins ? Math.round((r.bins[10]  / Math.max(1,r.total))*100) : null);
    const top100Pct = Number.isFinite(NS.top100)
      ? Math.round(NS.top100*100)
      : (r.bins ? Math.round((r.bins[100] / Math.max(1,r.total))*100) : null);

    $("#top10").textContent   = top10Pct  ?? "—";
    $("#top100").textContent  = top100Pct ?? "—";
    $("#ppl").textContent     = (NS.ppl ?? r.ppl ?? 0).toFixed(2);
    $("#burst").textContent   = (NS.burst ?? r.burstiness ?? 0).toFixed(3);
    $("#category").textContent = r.category
      ? `${r.category} (${Math.round((r.category_conf||0)*100)}%)`
      : "—";
    $("#modelName").textContent = r.model_name || "—";
    $("#modeEcho").textContent  = r.mode || "—";
    $("#pdj").textContent       = (r.pd_overlap_j ?? 0).toFixed(3);
    $("#tagEcho").textContent   = body.tag || "—";
    $("#explainShort").textContent = shortExplain(r);


    fillTokenTable(r.per_token || []);

    const S = r.stylometry || r.style || r.metrics?.stylometry || r.stats?.stylometry || {};
    const N2 = r.nonsense_signals || r.nonsense || r.metrics?.nonsense || r.stats?.nonsense || {};

    setTxt("#sty_func",  pickNum(S.func_ratio, S.function_word_ratio, S.funcWordsRatio), 3);
    setTxt("#sty_hapax", pickNum(S.hapax_ratio, S.hapax, S.hapaxRatio), 3);
    setTxt("#sty_smean", pickNum(S.sent_mean, S.sentence_mean, S.sentMean), 2);
    setTxt("#sty_svar",  pickNum(S.sent_var, S.sentence_var, S.sentVar), 2);
    setTxt("#sty_mlps",  pickNum(S.mlps, S.delta_logp_mean, S.dlogp_mean, S.deltaLogpMean), 4);
    setTxt("#sty_mlpsv", pickNum(S.mlps_var, S.delta_logp_var, S.dlogp_var, S.deltaLogpVar), 4);
    setTxt("#sty_pent",  pickNum(S.punct_entropy, S.punctuation_entropy, S.punctEntropy), 3);

    setTxt("#ns_rhyme", pickNum(N2.rhyme_density, N2.rhyme, N2.rhymeDensity), 3);
    setTxt("#ns_meter", pickNum(N2.meter_cv, N2.meter, N2.meterCV), 3);
    setTxt("#ns_inv",   pickNum(N2.invented_ratio, N2.invented, N2.inventedRatio), 3);
    setTxt("#ns_lex",   pickNum(N2.lex_hits, N2.lexHits), 0);
    setTxt("#ns_sem",   pickNum(N2.semantic_disc, N2.semantic_discontinuity, N2.semanticDisc), 3);

    lastScanMetrics = {
      func_ratio:    Number(S.func_ratio ?? S.function_word_ratio ?? 0),
      hapax_ratio:   Number(S.hapax_ratio ?? S.hapax ?? 0),
      sent_mean:     Number(S.sent_mean ?? S.sentence_mean ?? 0),
      sent_var:      Number(S.sent_var  ?? S.sentence_var  ?? 0),
      punct_entropy: Number(S.punct_entropy ?? S.punctuation_entropy ?? 0),
    };

    $("#btnStartLive").disabled = false;
    $("#liveInput").disabled    = false;
    setFinalizeEnabled(true);
    setExportEnabled(false);
    setMsg("exportStatus","");
  } catch (e) {
    $("#err").style.display = "block";
    $("#err").textContent   = "Scan failed: " + e.message;
  } finally {
    $("#btnScan").disabled = false;
    $("#scanStatus").textContent = "";
  }
}

function updateProbDonut(prob) {
  const donut = document.querySelector("#result .donut-val");
  if (!donut || typeof prob !== "number") {
    return; // safely no-op if missing or no probability
  }

  // Must match r="16" from your SVG <circle> in the donut
  const radius = 16;
  const circumference = 2 * Math.PI * radius;

  donut.style.strokeDasharray  = `${circumference} ${circumference}`;
  donut.style.strokeDashoffset = String(circumference * (1 - prob));
}


/* Demos */
async function loadDemos(){
  $("#btnDemo").disabled = true;
  try {
    const preset = currentDemoPreset;
    let text = "";

    if (preset === "random") {
      const keys = Object.keys(DEMO_SAMPLES);
      if (!keys.length) {
        $("#text").value = "No demo samples configured.";
        return;
      }
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    } else {
      text = DEMO_SAMPLES[preset] || "";
      if (!text) {
        $("#text").value = `Demo preset "${preset}" not available.`;
        return;
      }
    }

    $("#text").value = text;
  } catch (e) {
    $("#text").value = "Failed to load demo sample: " + e.message;
  } finally {
    $("#btnDemo").disabled = false;
  }
}


/* Live typing */
let liveStartTs = null, liveTimerId = null, liveComputingTimer = null;

async function finalizeCompute(){
  const typed = $("#liveInput").value.trim();

  if (!didScan){
    setMsg("liveResult","Run a scan first to have a reference.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  if (!typed) {
    setMsg("liveResult","No sample typed.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  const wordCount = tokenizeWords(typed).filter(t=>/^[a-z’']+$/i.test(t)).length;
  if (wordCount < 60) {
    setMsg("liveResult","Type at least ~60 words for a stable compare.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  const userM = simpleMetrics(typed);
  const { html, pct } = renderLiveCompare(userM, lastScanMetrics);
  $("#liveResult").innerHTML = html;

  lastExportText = buildExportText(lastScanResult, userM, lastScanMetrics, pct);
  setExportEnabled(true);
  setMsg("exportStatus","Summary ready.");

  // NEW: call /drift/compare for scan vs live sample
  try {
    if (lastScanText) {
      const drift = await driftCompare(lastScanText, typed);
      renderLiveDrift(drift);
    } else {
      renderLiveDrift(null);
    }
  } catch (e) {
    console.warn("Live drift compare failed:", e);
    renderLiveDrift({ note: "Drift compare unavailable: " + e.message });
  }
}

function tickTimer(){
  if(!liveStartTs) return;
  const s = Math.max(0, Math.floor((Date.now()-liveStartTs)/1000));
  $("#liveTimer").textContent = s + "s";
  if (s >= 90) { $("#liveRough").textContent = "Computing…"; stopLive(true); }
}

function updateLiveHUD() {
  const liveInputEl = $("#liveInput");
  if (!liveInputEl) return;

  const typed  = liveInputEl.value;
  const tokens = tokenizeWords(typed);
  const words  = tokens.filter(t => /^[a-z’']+$/i.test(t));
  const count  = words.length;

  const tokensEl = $("#liveTokens");
  if (tokensEl) {
    tokensEl.textContent = String(count);
  }

  const pct = Math.min(100, Math.round((count / 120) * 100));

  // Narrow progress bar (inside the header strip)
  const bar = $("#liveProgress");
  if (bar) {
    bar.style.width = pct + "%";
  }

  // LEN: xx% label
  const lenEl = $("#liveLen");
  if (lenEl) {
    lenEl.textContent = pct + "%";
  }

  // Wide progress bar under the compare section, if present
  const wide = document.getElementById("liveProgressWide");
  if (wide) {
    wide.style.width = pct + "%";
  }

  if (lastScanMetrics && count >= 20) {
    const sim = Math.round(
      100 *
        Math.max(
          0,
          Math.min(1, cosineSimilarity(simpleMetrics(typed), lastScanMetrics))
        )
    );
    const roughEl = $("#liveRough");
    if (roughEl) {
      roughEl.textContent = `~${sim}%`;
    }
  } else {
    const roughEl = $("#liveRough");
    if (roughEl) {
      roughEl.textContent = "—";
    }
  }
}

function startLive() {
  $("#liveResult").textContent = "";
  $("#btnStartLive").disabled = true;
  setFinalizeEnabled(true);

  // Safely reset the progress bar
  const bar = $("#liveProgress");
  if (bar) {
    bar.style.width = "0%";
  }

  // Safely reset the “LEN: 0%” label
  const lenEl = $("#liveLen");
  if (lenEl) {
    lenEl.textContent = "0%";
  }

  $("#liveRough").textContent = "—";

  liveStartTs = Date.now();

  // Kick the HUD every 500ms (timer + word count + quick match)
  liveTimerId = setInterval(() => {
    tickTimer();
    updateLiveHUD();
  }, 500);
}


function stopLive(autoFinalize=false){
  clearInterval(liveTimerId); liveTimerId = null; liveStartTs = null;
  $("#btnStartLive").disabled = false;
  setFinalizeEnabled(true);

  // NEW: always turn off fun zone when live stops
  if (window.setFunZoneActive) window.setFunZoneActive(false);

  if (autoFinalize){
    clearTimeout(liveComputingTimer);
    liveComputingTimer = setTimeout(() => finalizeCompute(), 600);
  }
}


/* ----- Export (plain text summary) ----- */
function buildExportText(scan, userM, refM, simPct){
  const ts = new Date().toISOString();
  const sampleWords = tokenizeWords($("#liveInput").value).filter(t=>/^[a-z’']+$/i.test(t)).length;
  const runtime = $("#activeModeBadge")?.textContent.replace("Mode: ","") || (scan?.mode ?? "—");
  const ensemOn = (($("#ensemBadge")?.textContent)||"").toLowerCase().includes("on") ? "on" : "off";
  const pdn = Number(window.__pdCentroids || 0);

  const lines = [];
  if (scan){
    const prob = Number(scan.calibrated_prob ?? 0);
    const probPct = Math.round(prob*100);
    lines.push("CopyCat — Scan Summary");
    lines.push(`Timestamp: ${ts}`);
    lines.push(`Verdict: ${scan.verdict ?? "—"} (${probPct}%)`);
    if (scan.category) lines.push(`Category: ${scan.category} (${Math.round((scan.category_conf||0)*100)}%)`);
    lines.push(`Model: ${scan.model_name ?? "—"} | Runtime: ${runtime} | Ensemble: ${ensemOn}`);
    if (typeof scan.pd_overlap_j === "number") lines.push(`PD overlap J: ${scan.pd_overlap_j.toFixed(3)}`);
    lines.push(`PD fingerprints loaded: ${pdn > 0 ? pdn : "none"}`);
    lines.push("");
    lines.push("Quick style match (Live Verification):");
    lines.push(`Match: ${simPct}%`);
    lines.push(`Live words: ${sampleWords}`);
  }
  const fields = [
    ["Function word ratio","func_ratio",3],
    ["Hapax ratio","hapax_ratio",3],
    ["Sent. mean","sent_mean",2],
    ["Sent. var","sent_var",2],
    ["Punct entropy","punct_entropy",3],
  ];
  lines.push("");
  for(const [label,key,d] of fields){
    const u = Number(userM?.[key] ?? 0);
    const r = Number(refM?.[key] ?? 0);
    const diff = u - r;
    lines.push(`${label}: you ${u.toFixed(d)} | ref ${r.toFixed(d)} | Δ ${(diff>=0?"+":"")}${diff.toFixed(d)}`);
  }
  return lines.join("\n");
}

async function copyExport(){
  if (!lastExportText){ setMsg("exportStatus","Nothing to copy yet."); return; }
  try{
    await navigator.clipboard.writeText(lastExportText);
    setMsg("exportStatus","Copied to clipboard.");
  }catch{
    // Fallback for Safari/iOS/permission blocks
    const ta = document.createElement("textarea");
    ta.value = lastExportText;
    ta.style.position="fixed"; ta.style.opacity="0";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand("copy"); setMsg("exportStatus","Copied (fallback)."); }
    catch(e){ setMsg("exportStatus","Copy failed: " + e.message); }
    finally{ document.body.removeChild(ta); }
  }
}
function downloadExportTxt(){
  if (!lastExportText){ setMsg("exportStatus","Nothing to download yet."); return; }
  const blob = new Blob([lastExportText], {type: "text/plain"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = `copycat_summary_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  setMsg("exportStatus","Downloaded .txt.");
}

/* ----- Config I/O (unchanged API surface, but shows version bump) ----- */
async function loadVersion(){
  try{
    const v = await api("/version");
    $("#version").textContent = `v${v.version || "0.3.8"} • ${v.model} • ${v.device} ${v.dtype} • ensemble=${v.ensemble?"on":"off"}`;
    $("#ensemBadge").textContent = v.ensemble ? "Ensemble: on" : "Ensemble: off";
   const pdn = Number(v.fingerprint_centroids ?? 0);
   const pd  = $("#pdBadge");
    if (pd) {
      const has = pdn > 0;

      // Text
      pd.textContent = has ? `PD: ${pdn}` : "PD: none";

      // Remove any old inline styles so CSS can take over
      pd.removeAttribute("style");

      // Toggle dark-theme state classes
      pd.classList.remove("pd-ok", "pd-none");
      pd.classList.add(has ? "pd-ok" : "pd-none");

      // Accessibility label
      pd.setAttribute(
        "aria-label",
        has
          ? `${pdn} PD fingerprint centroids loaded`
          : "No PD fingerprint centroids loaded"
      );

      window.__pdCentroids = pdn;
    }


  }catch{
    $("#version").textContent = "v0.3.5";
  }
}
async function loadConfig(){
  try{
    const j = await api("/config"); const s = j.settings || {};
    $("#cfg_mode").value = s.mode || "Balanced";
    $("#use_ensemble").checked = !!s.use_ensemble;
    $("#cfg_min_tokens").value = s.min_tokens_strong ?? 180;
    $("#cfg_short_cap").checked = !!s.short_cap;
    $("#cfg_max_conf_short").value = (s.max_conf_short ?? 0.35);
    $("#cfg_non_en_cap").value = (s.non_en_cap ?? 0.15);
    $("#cfg_en_thresh").value = (s.en_thresh ?? 0.70);
    $("#cfg_max_unstable").value = (s.max_conf_unstable ?? 0.35);
    $("#cfg_abstain_low").value = (s.abstain_low ?? 0.35);
    $("#cfg_abstain_high").value = (s.abstain_high ?? 0.65);
    setModeBadge(s.mode || "Balanced");
    $("#mode").value = s.mode || "Balanced";
  }catch(e){ $("#saveStatus").textContent = "Failed to load settings: "+e.message; }
}
async function saveConfig(){
  const body = {
    mode: $("#cfg_mode").value,
    short_cap: $("#cfg_short_cap").checked,
    min_tokens_strong: parseInt($("#cfg_min_tokens").value || "180",10),
    use_ensemble: $("#use_ensemble").checked,
    non_en_cap: parseFloat($("#cfg_non_en_cap").value || "0.15"),
    en_thresh: parseFloat($("#cfg_en_thresh").value || "0.70"),
    max_conf_unstable: parseFloat($("#cfg_max_unstable").value || "0.35"),
    max_conf_short: parseFloat($("#cfg_max_conf_short").value || "0.35"),
    abstain_low: parseFloat($("#cfg_abstain_low")?.value || "0.35"),
    abstain_high: parseFloat($("#cfg_abstain_high")?.value || "0.65"),
  };
  try{
    $("#btnSave").disabled = true; $("#saveStatus").textContent = "Saving…";
    const j = await api("/config",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    $("#saveStatus").textContent = "Saved.";
    setModeBadge(j.settings.mode);
    $("#mode").value = j.settings.mode;
    await loadVersion();
  }catch(e){ $("#saveStatus").textContent = "Save failed: "+e.message; }
  finally{ $("#btnSave").disabled = false; }
}

/* Wire */
$("#btnScan").addEventListener("click", runScan);
$("#btnDemo").addEventListener("click", loadDemos);
$("#btnClear").addEventListener("click", ()=>{
  $("#text").value="";
  $("#result").style.display="none";
  $("#err").style.display="none";
  $("#btnStartLive").disabled = true;
  $("#liveInput").disabled = true;
  didScan = false;
  setFinalizeEnabled(false);
  setExportEnabled(false);
  lastExportText = "";
  setMsg("exportStatus","");


  // v0.3.7 — reset drift UI
  const driftBox = document.getElementById("driftBox");
  const driftContent = document.getElementById("driftContent");
  if (driftBox) driftBox.style.display = "none";
  if (driftContent) driftContent.innerHTML = "";
    const liveDriftContent = document.getElementById("liveDriftContent");
  if (liveDriftContent) liveDriftContent.innerHTML = "";

  // reset tabs back to Summary
  initLiveTabs();


});

$("#btnSave").addEventListener("click", saveConfig);
$("#btnReset").addEventListener("click", ()=>location.reload());
$("#btnStartLive").addEventListener("click", startLive);
$("#btnFinalize").addEventListener("click", finalizeCompute);
$("#btnExport").addEventListener("click", copyExport);
$("#btnDownload").addEventListener("click", downloadExportTxt);

// Keep HUD updated as you type in Live Verification
const liveInputEl = document.getElementById("liveInput");
if (liveInputEl) {
  liveInputEl.addEventListener("input", updateLiveHUD);
}


(async function init(){
  await loadVersion();
  await loadConfig();
  initDemoPresetSelect();
  initLiveTabs();
  setFinalizeEnabled(false);
  setExportEnabled(false);
  initSmartTooltips();
  initAdvToggleButton();

})();

(function () {
  const CAT_FRAME_W = 256;
  const CAT_FRAME_H = 256;
  const CAT_COLS    = 4;
  const CAT_TOTAL   = 16;

  let catFrame = 0;
  let catTimer = null;

  function setCatFrame(el, frameIndex) {
    const col = frameIndex % CAT_COLS;
    const row = Math.floor(frameIndex / CAT_COLS);
    const x = -col * CAT_FRAME_W;
    const y = -row * CAT_FRAME_H;
    el.style.backgroundPosition = `${x}px ${y}px`;
  }

  function startCatSprite() {
    const cat = document.querySelector('#liveFunZone .cat');
    if (!cat) return;
    if (catTimer) return;

    catFrame = 0;
    setCatFrame(cat, catFrame);

    catTimer = window.setInterval(() => {
      catFrame = (catFrame + 1) % CAT_TOTAL;
      setCatFrame(cat, catFrame);
    }, 1000 / 12);
  }

  function stopCatSprite() {
    if (catTimer) {
      window.clearInterval(catTimer);
      catTimer = null;
    }
  }

  function setFunZoneActive(on) {
    const zone = document.getElementById('liveFunZone');
    if (!zone) return;

    if (on) {
      zone.classList.add('active');
      startCatSprite();
    } else {
      zone.classList.remove('active');
      stopCatSprite();
    }
  }

  // Expose to the rest of the app (startLive / stopLive use this)
  window.setFunZoneActive = setFunZoneActive;
})();

  

function initSmartTooltips() {
  const dots = document.querySelectorAll(".help-dot");

  function adjustPlacement(dot) {
    if (!dot) return;

    // Reset any previous override
    dot.classList.remove("tip-l");

    const tip = dot.querySelector(".tip");
    if (!tip) return;

    const rect = dot.getBoundingClientRect();
    const vw = window.innerWidth || document.documentElement.clientWidth;

    const tipWidth = tip.offsetWidth || 260;  // fallback

    const rightSpace = vw - rect.right;

    // If not enough room on the right, flip this one to the left
    if (rightSpace < tipWidth + 16) {
      dot.classList.add("tip-l");
    }
  }

  dots.forEach(dot => {
    dot.addEventListener("mouseenter", () => adjustPlacement(dot));
    dot.addEventListener("focus",      () => adjustPlacement(dot));
  });

  window.addEventListener("resize", () => {
    dots.forEach(adjustPlacement);
  });
}


(function initTheme() {
  const sel = document.getElementById("themeSelect");
  if (!sel) return;

  const THEME_KEY = "copycat_theme";
  const allowed = new Set(["dark-professional", "light-paper", "lcars"]);

  // Read saved theme or default to dark-professional
  const stored = localStorage.getItem(THEME_KEY);
  const initial = allowed.has(stored) ? stored : "dark-professional";

  document.documentElement.dataset.theme = initial;
  sel.value = initial;

  sel.addEventListener("change", () => {
    const v = allowed.has(sel.value) ? sel.value : "dark-professional";
    document.documentElement.dataset.theme = v;
    localStorage.setItem(THEME_KEY, v);
  });
})();

document.addEventListener('DOMContentLoaded', () => {
  const panel = document.getElementById('lcarsPanel');
  if (!panel) return;

  const tabs = panel.querySelectorAll('.lcars-tab');
  const sections = panel.querySelectorAll('.tab-section');

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.tab;
      const targetId = `tab-${target}`;

      // activate this tab
      tabs.forEach(b => b.classList.toggle('lcars-tab-active', b === btn));

      // show matching section
      sections.forEach(sec =>
        sec.classList.toggle('tab-section-active', sec.id === targetId)
      );
    });
  });
});

(function initExplainPanel() {
  const panel    = document.getElementById('explainPanel');
  const backdrop = document.getElementById('explainBackdrop');
  const openBtn  = document.getElementById('btnExplainPanel');
  const closeBtn = document.getElementById('btnExplainClose');

  if (!panel || !openBtn) return;

  function openPanel() {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    if (backdrop) {
      backdrop.hidden = false;
      backdrop.classList.add('show');
    }
  }

  function closePanel() {
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden', 'true');
    if (backdrop) {
      backdrop.classList.remove('show');
      // delay hiding so fade-out can run
      window.setTimeout(() => { backdrop.hidden = true; }, 180);
    }
  }

  openBtn.addEventListener('click', openPanel);
  if (closeBtn) closeBtn.addEventListener('click', closePanel);
  if (backdrop) backdrop.addEventListener('click', closePanel);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePanel();
  });
})();


</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Text Scanner — CopyCat</title>
<style>

  #demoPresetWrap{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    font-size:0.9em;
  }

  :root{
  --bg:#0f1220; --panel:#181c2f; --muted:#c4cbe3; --text:#f1f4ff; --accent:#7eb4ff;
  --good:#45c176; --warn:#f2c94c; --bad:#ef6a6a; --border:#2a3250; --panel-2:#13182b;
  --scale:1.50;
  --tip-bg: rgba(11,16,34,.92);
  --tip-border: rgba(126,180,255,.25);
}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  font-size:calc(16px * var(--scale));
  line-height:1.55;
}

#liveResizeHandle{
  height:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:ns-resize;
}
#liveResizeHandle::before{
  content:"";
  width:46px;
  height:4px;
  border-radius:999px;
  background:rgba(255,255,255,.25);
}


/* main shell now fills entire browser window */
body{
  min-height:100vh;
  display:flex;
}

.wrap{
  flex:1;
  width:100%;
  max-width:none;
  margin:0;
  padding:16px 16px 24px;
  box-sizing:border-box;
}

  html,body{ margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    font-size:calc(16px * var(--scale)); line-height:1.55; }
  .wrap{max-width:var(--wrap-max); width:98vw; margin:22px auto;}
  .grid{display:grid;gap:18px}
.cols{
  grid-template-columns: minmax(0,1.25fr) minmax(0,1fr);
  align-items:stretch;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
  overflow:visible;
  height:100%;          /* cards fill the column height */
}

  @media (max-width:1100px){ .cols{grid-template-columns:1fr} }

    /* Live drawer layout polish */
  #liveDrawer .split {
    align-items: flex-start;
  }

  /* Give a bit of breathing room between left + right columns */
  #liveDrawer .split > div:first-child {
    padding-right: 8px;
  }
  #liveDrawer .split > div:last-child {
    padding-left: 8px;
  }

  /* Slightly tighter spacing under the metrics row */
  #liveResult {
    margin-top: 8px;
  }

  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap; overflow:visible}
  .right{text-align:right}
  label{color:var(--muted)}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;background:#101426;color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px 14px;min-height:42px;font-size:1em;
  }
  textarea{min-height:360px;resize:vertical}
  .btn{background:var(--accent);border:none;color:#091120;padding:11px 16px;border-radius:10px;font-weight:700;cursor:pointer;min-height:42px}
  .btn.secondary{background:#253055;color:var(--text)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .pill{padding:4px 10px;border-radius:999px;background:#1a2346;color:#cfe0ff;border:1px solid var(--border)}
  .bar{height:22px;border:1px solid var(--border);border-radius:12px;background:#0c1122;position:relative}
  .bar>.fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:12px}
  .fill.good{background:var(--good)} .fill.warn{background:var(--warn)} .fill.bad{background:var(--bad)}
  .kv{display:grid;grid-template-columns: 1fr auto;gap:8px 16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
  th{color:var(--muted)}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .footer{margin-top:14px;color:var(--muted);font-size:.95em}

.drawer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  background:var(--panel-2);
  border-top:1px solid var(--border);
  transform:translateY(100%);
  transition:transform .25s ease;
  z-index:50;

  /* NEW: fixed height & flex so inner content fits */
  height:var(--live-h);
  display:flex;
  align-items:stretch;
}

.drawer.open{ transform:translateY(0); }

.drawer-inner{
  max-width:var(--wrap-max);
  width:98vw;
  margin:0 auto;
  padding:8px 0 14px;

  /* NEW: let content scroll inside drawer instead of growing it */
  max-height:100%;
  overflow:auto;
}


    /* Live drawer layout */
  .split{
    display:grid;
    grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
    gap:18px;
    align-items:flex-start;
  }
  @media (max-width:1024px){
    .split{grid-template-columns: 1fr}
  }

  .live-left textarea{
    min-height:140px;
    max-height:220px;
  }

  .live-metrics-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:6px;
  }

  .live-tabs{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    border:1px solid var(--border);
    overflow:hidden;
    font-size:.85em;
    white-space:nowrap;
  }
  .live-tab{
    background:transparent;
    border:none;
    color:var(--muted);
    padding:4px 10px;
    cursor:pointer;
  }
  .live-tab.active{
    background:#1a2346;
    color:#eaf0ff;
  }


  .progress{height:10px;border-radius:6px;background:#2a3240;overflow:hidden}
  .progress>span{display:block;height:100%;width:0;background:#3b82f6;transition:width .25s}

/* Optional: hide the hint on very small screens */
@media (max-width: 700px) {
  #btnLive::after {
    content: '';
  }
}


  .scale-wrap{display:flex;align-items:center;gap:10px}
  input[type="range"]{accent-color:#7eb4ff}

  /* ---- HELP DOT + BALLOON ---- */
  .help-wrap{display:inline-flex; align-items:center; gap:8px; overflow:visible}
  .help-dot{
    position:relative; display:inline-flex; align-items:center; justify-content:center;
    width:1.4em; height:1.4em; min-width:1.4em; min-height:1.4em;
    border:1.5px solid var(--border); border-radius:999px; color:#cfe0ff; background:#10162a;
    font-weight:800; line-height:1; user-select:none; cursor:help; overflow:visible;
  }
  .help-dot::after{ content:"?"; font-size:.9em; transform:translateY(-1px); }

  /* balloon defaults (RIGHT side) */
  .help-dot > .tip{
    position:absolute; inset:auto auto auto 100%;
    transform:translate(10px,-50%); top:50%;
    min-width:240px; max-width:360px;
    background:var(--tip-bg); color:#eaf0ff;
    border:1px solid var(--tip-border); border-radius:12px; padding:10px 12px;
    font-size:.95em; line-height:1.4; box-shadow:0 18px 40px rgba(0,0,0,.55);
    z-index:9999; white-space:normal; word-break:normal; overflow-wrap:anywhere;
    opacity:0; visibility:hidden; pointer-events:none;
    transition:opacity .14s ease, transform .14s ease, visibility .14s;
    backface-visibility:hidden;
  }
  .help-dot::before{
    content:""; position:absolute; left:100%; top:50%; transform:translate(2px,-50%) rotate(90deg);
    border:7px solid transparent; border-top-color:var(--tip-border);
    filter:drop-shadow(0 2px 0 rgba(0,0,0,.22));
    opacity:0; visibility:hidden; transition:opacity .14s ease, transform .14s ease, visibility .14s;
    z-index:10000;
  }

  /* show states */
  .help-dot:hover > .tip,
  .help-dot:focus-visible > .tip,
  .help-dot[data-open="1"] > .tip{
    opacity:1; visibility:visible; transform:translate(10px,-50%) scale(1);
    pointer-events:auto;
  }
  .help-dot:hover::before,
  .help-dot:focus-visible::before,
  .help-dot[data-open="1"]::before{
    opacity:1; visibility:visible;
  }

  /* top/bottom variants if you ever need them */
  .tip-t.help-dot > .tip{ inset:auto auto 100% 0; transform:translate(0,-10px); top:auto; left:0; }
  .tip-t.help-dot::before{ left:16px; top:auto; bottom:100%; transform:translateY(-2px) rotate(0deg); }
  .tip-b.help-dot > .tip{ inset:100% auto auto 0; transform:translate(0,10px); top:auto; left:0; }
  .tip-b.help-dot::before{ left:16px; top:100%; transform:translateY(2px) rotate(180deg); }

  @media (prefers-reduced-motion: reduce){
    .help-dot > .tip, .help-dot::before, .drawer, .progress>span{ transition:none !important; }
  }

  /* Accessibility */
  button,.btn,.drawer button{font-size:1.05em;padding:12px 18px;min-height:46px;border-radius:12px}
  .btn.ghost{border-width:1.5px}
  input[type="text"],input[type="number"],select{min-height:46px;font-size:1.05em;padding:12px 14px}
  table th,table td{padding:10px 12px;font-size:1.02em}
  details>summary{font-size:1.05em;padding:6px 0;cursor:pointer}
  button:focus-visible,select:focus-visible,input:focus-visible,textarea:focus-visible{outline:3px solid #7eb4ff;outline-offset:2px}

  /* --- Light tooltip override (paste at END of <style>) --- */
:root{
  --tip-bg: rgba(248, 251, 255, 0.96);
  --tip-border: rgba(126, 180, 255, 0.45);
  --tip-text: #0f1630;
  --live-h: 40vh;      /* default Live Verification height */
}
.help-dot > .tip{
  background: var(--tip-bg);
  color: var(--tip-text);
  border-color: var(--tip-border);
  box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.05) inset;
  backdrop-filter: saturate(120%) blur(0.5px);
}
.help-dot::before{
  border-top-color: var(--tip-bg);
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.18));
}

  /* v0.3.5 Explain UI */
  .band-badge { display:inline-flex; align-items:center; gap:.5rem; font-weight:600; font-size:.95rem; padding:.35rem .6rem; border-radius:.6rem; border:1px solid rgba(0,0,0,.2); background:#f6f6f6; }
  .band-human{ background:#e8f7ec; border-color:#7ad58f; }
  .band-mixed{ background:#fff7e0; border-color:#e2c35c; }
  .band-ai{ background:#fde8e8; border-color:#e28b8b; }
  .badge-dot{ width:.55rem; height:.55rem; border-radius:50%; display:inline-block; }
  .dot-human{ background:#26a269; } .dot-mixed{ background:#cfae2d; } .dot-ai{ background:#c23333; }
  #explainWrap{ margin-top:.5rem; border:1px solid #2d2d2d; border-radius:10px; overflow:hidden; background:#111; color:#ddd; }
  #explainHeader{ display:flex; justify-content:space-between; align-items:center; padding:.65rem .9rem; background:#181818; border-bottom:1px solid #2d2d2d; }
  #explainTitle{ font-weight:600; }
  #explainToggleBtn{ all:unset; cursor:pointer; padding:.25rem .55rem; border:1px solid #444; border-radius:6px; font-size:.9rem; color:#ddd; }
  #explainBody{ padding:.8rem .9rem; display:block; }
  #explainBody.hidden{ display:none; }
  .explain-section{ margin:.4rem 0 .6rem; }
  .explain-section b{ color:#fff; }
  .explain-list{ margin:.35rem 0 0 .9rem; }
  .explain-note{ opacity:.85; }
  #pdBadge{ margin-left: 8px; }

  /* Live drawer right-side spacing */
.split > div:last-child {
  padding: 8px 12px 10px;
}

/* Give the tabs and sections some breathing room */
#liveTabs {
  margin-bottom: 8px;
}

#liveResult {
  margin-top: 8px;
}

#liveDriftBox {
  margin-top: 8px;
}


</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <strong>CopyCat — AI Text Scanner</strong>
      <span id="version" class="muted"></span>
      <span id="pdBadge" class="pill" aria-live="polite" title="Public-domain fingerprint centroids">PD: —</span>
    </div>
    <div class="scale-wrap">
      <label class="muted" for="uiScale">UI scale</label>
      <input id="uiScale" type="range" min="120" max="220" value="150" />
    </div>
  </div>

  <div class="grid cols">
    <!-- Left -->
    <section class="card" aria-label="AI Text Scanner">
      <div class="row" style="justify-content:space-between">
        <h1 style="margin:0">CopyCat: AI Content Auditor</h1>
        <span class="muted" id="ensemBadge"></span>
      </div>

      <div class="row">
        <!-- Demo button + preset dropdown -->
        <div class="help-wrap">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:nowrap;">
            <button id="btnDemo" class="btn secondary">Load Demo</button>
            <select id="demoPreset" class="mono" style="min-width:190px; max-width:230px;">
              <!-- options will be filled by JS -->
            </select>
          </div>
          <span class="help-dot" tabindex="0">
            <span class="tip">
              Load a curated example passage. Choose a type (news, story, essay, code) or pick “random”.
            </span>
          </span>
        </div>

        <div class="help-wrap">
          <button id="btnClear" class="btn ghost">Clear</button>
          <span class="help-dot" tabindex="0"><span class="tip">Clear the input and results. Also disables Live/Finalize until the next Scan.</span></span>
        </div>

        <div class="help-wrap">
          <button id="btnLive" class="btn ghost" aria-controls="liveDrawer">Open Live Verification</button>
          <span class="help-dot" tabindex="0"><span class="tip">Open the Live Verification drawer to type a short sample for comparison.</span></span>
        </div>
      </div>

      <!-- Demo Mode Toggle + Presets -->
      <div class="row" style="align-items:flex-start; margin-bottom:10px; gap:12px;">
        <label class="mono" style="font-size:0.9em; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="demoToggle">
          Demo mode (use preset curated samples)
        </label>

        <div id="demoPresetWrap" class="muted">
          <span style="font-size:0.85em;">Preset:</span>
          <select id="demoPreset">
            <option value="random">(random curated sample)</option>
            <option value="news">News / op-ed</option>
            <option value="story">Story / narrative</option>
            <option value="essay">Student-style essay</option>
            <option value="code">Short code snippet</option>
          </select>
        </div>
      </div>



      <label for="text">Text to scan</label>
      <textarea id="text" placeholder="Paste or type text to analyze…"></textarea>

      <div class="grid" style="grid-template-columns: 1fr 1fr auto; gap:12px; margin-top:12px">
        <div>
          <div class="row" style="justify-content:space-between">
            <label for="mode">Mode</label>
            <span class="help-dot" tabindex="0"><span class="tip">Override the runtime mode for this one scan (Balanced / Strict / Academic).</span></span>
          </div>
          <select id="mode">
            <option>Balanced</option><option>Strict</option><option>Academic</option>
          </select>
          <div class="muted" style="font-size:.95em">Overrides current runtime mode for this scan only.</div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <label for="tag">Optional tag</label>
            <span class="help-dot" tabindex="0"><span class="tip">Free-form flag (e.g., “classic”, “pre-1920”) saved into the scan log.</span></span>
          </div>
          <input id="tag" type="text" placeholder="e.g., classic, pre-1920, …" />
        </div>

        <div style="display:flex;align-items:flex-end;gap:10px">
          <div class="help-wrap">
            <button id="btnScan" class="btn">Scan</button>
            <span class="help-dot" tabindex="0"><span class="tip">Send the text to the server and compute detection metrics.</span></span>
          </div>
          <span id="scanStatus" class="muted" aria-live="polite" role="status"></span>
        </div>
      </div>

      <!-- Explain + Result -->
      <div id="bandBadge" class="band-badge" aria-live="polite" style="display:none;">
        <span class="badge-dot"></span>
        <span id="bandText">Band</span>
        <span id="bandPct" style="opacity:.75;"></span>
      </div>

      <div id="explainWrap" style="display:none;" aria-live="polite">
        <div id="explainHeader">
          <div id="explainTitle">What this means</div>
          <button id="explainToggleBtn" aria-expanded="true" aria-controls="explainBody">Hide</button>
        </div>
        <div id="explainBody">
          <div id="explainHeadline" class="explain-section"></div>
          <div id="explainWhy" class="explain-section"></div>
          <div id="explainFix" class="explain-section"></div>
          <div id="explainNotes" class="explain-section explain-note"></div>
          <div id="teacherRow" class="explain-section" style="opacity:.9;">
            <small id="teacherMini"></small>
          </div>
        </div>
      </div>

      <div id="result" style="margin-top:16px; display:none">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Result</h3>
          <span id="verdictPill" class="pill">—</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <div>Calibrated probability (AI likelihood)</div><div id="probPct" class="right mono">—</div>
          <div style="grid-column:1 / -1"><div class="bar"><div class="fill" id="probFill"></div></div></div>

          <div>Explanation</div><div id="explainShort" class="right muted">—</div>
          <div>Top-10 tokens</div><div id="top10" class="right mono">—</div>
          <div>Top-100 tokens</div><div id="top100" class="right mono">—</div>
          <div>Perplexity</div><div id="ppl" class="right mono">—</div>
          <div>Burstiness</div><div id="burst" class="right mono">—</div>
          <div>Category</div><div id="category" class="right mono">—</div>
          <div>Model</div><div id="modelName" class="right mono">—</div>
          <div>LLM fingerprint</div><div id="fpLabel" class="right mono">—</div>
          <div>Fingerprint band</div><div id="fpBand" class="right mono">—</div>
          <div>Mode</div><div id="modeEcho" class="right mono">—</div>
          <div>PD overlap J</div><div id="pdj" class="right mono">—</div>
          <div>Tag</div><div id="tagEcho" class="right mono">—</div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:18px; margin-top:14px">
          <div class="card" style="padding:12px">
            <div class="muted">Stylometry</div>
            <div class="kv">
              <div>Function word ratio</div><div id="sty_func" class="right mono">—</div>
              <div>Hapax ratio</div><div id="sty_hapax" class="right mono">—</div>
              <div>Sent. mean</div><div id="sty_smean" class="right mono">—</div>
              <div>Sent. var</div><div id="sty_svar" class="right mono">—</div>
              <div>Δlogp mean</div><div id="sty_mlps" class="right mono">—</div>
              <div>Δlogp var</div><div id="sty_mlpsv" class="right mono">—</div>
              <div>Punct entropy</div><div id="sty_pent" class="right mono">—</div>
            </div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">Nonsense guard</div>
            <div class="kv">
              <div>Rhyme density</div><div id="ns_rhyme" class="right mono">—</div>
              <div>Meter CV</div><div id="ns_meter" class="right mono">—</div>
              <div>Invented word ratio</div><div id="ns_inv" class="right mono">—</div>
              <div>Lex hits</div><div id="ns_lex" class="right mono">—</div>
              <div>Semantic discontinuity</div><div id="ns_sem" class="right mono">—</div>
            </div>
          </div>

          <div id="fpBox" class="card" style="padding:12px; display:none">
            <div class="muted">LLM fingerprint (experimental)</div>
            <div class="kv">
              <div>Top style</div><div id="fpTop" class="right mono">—</div>
              <div>Band</div><div id="fpBandCard" class="right mono">—</div>
              <div>Drift / PD</div><div id="fpSpread" class="right mono">—</div>
              <div>Notes</div><div id="fpNotes" class="right muted">—</div>
            </div>
          </div>

          <!-- Drift Diagnostics goes HERE, between these and Raw JSON -->
          <div id="driftBox" class="card" style="margin-top:12px; padding:12px; display:none">
            <div class="muted">Drift diagnostics</div>
            <div id="driftContent" class="kv" style="margin-top:8px"></div>
          </div>

         <!-- LLM Fingerprint -->
<div id="llmBox" class="card" style="margin-top:12px; padding:12px; display:none">
  <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
    <div>
      <div class="muted">LLM fingerprint (experimental)</div>
      <div class="mono" style="margin-top:4px;">
        Nearest: <span id="llmFamily">—</span>
        • Conf: <span id="llmConf">—</span>
        • Human score: <span id="llmHuman">—</span>
      </div>
    </div>
    <span class="pill" id="llmBand">—</span>
  </div>

  <div style="margin-top:10px;">
    <canvas id="llmCanvas" height="120" style="width:100%; max-width:480px; display:block;"></canvas>
  </div>

  <div id="llmLegend" class="mono muted" style="margin-top:6px; font-size:.9em;">
    <!-- filled by JS -->
  </div>
</div>


          <details id="rawJsonBox" style="margin-top:8px">
            <summary>Raw /scan JSON</summary>
            <pre id="rawDump" style="white-space:pre-wrap; font-size:12px"></pre>
          </details>
        </div>

        <div class="footer">CSV log and a PDF report are generated server-side per scan.</div>
      </div>

      <div id="err" class="footer" style="color:#ff9f9f;display:none"></div>
    </section>

    <!-- Right -->
    <section class="card" aria-label="Runtime Settings">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Runtime Settings</h2>
        <span class="pill" id="activeModeBadge">Mode: —</span>
      </div>

      <div class="grid" style="gap:16px">
        <div class="row">
          <input id="use_ensemble" type="checkbox" />
          <label for="use_ensemble">Use ensemble (if secondary model loaded)</label>
          <span class="help-dot" tabindex="0"><span class="tip">If a secondary model is available, combine its judgment with the primary model for a steadier verdict. Slightly slower, often more stable.</span></span>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_mode">Default mode</label>
              <span class="help-dot" tabindex="0"><span class="tip">Balanced = general. Strict = more conservative on “human”. Academic = tuned to longer formal prose.</span></span>
            </div>
            <select id="cfg_mode"><option>Balanced</option><option>Strict</option><option>Academic</option></select>
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_min_tokens">Min tokens strong</label>
              <span class="help-dot" tabindex="0"><span class="tip">Minimum token count before we allow a strong decision. Below this size, detector stays cautious.</span></span>
            </div>
            <input id="cfg_min_tokens" type="number" min="1" step="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div class="row">
            <input id="cfg_short_cap" type="checkbox" />
            <label for="cfg_short_cap">Cap short excerpts</label>
            <span class="help-dot" tabindex="0"><span class="tip">Short inputs can look over-confident. This applies a ceiling when the text is tiny.</span></span>
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_max_conf_short">Max conf (short)</label>
              <span class="help-dot" tabindex="0"><span class="tip">Confidence ceiling (0–1) when text length is below the short-excerpt threshold.</span></span>
            </div>
            <input id="cfg_max_conf_short" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_non_en_cap">Non-EN cap</label>
              <span class="help-dot" tabindex="0"><span class="tip">If the passage doesn’t look English, cap confidence to avoid language-mismatch errors.</span></span>
            </div>
            <input id="cfg_non_en_cap" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_en_thresh">EN threshold</label>
              <span class="help-dot" tabindex="0"><span class="tip">Threshold (0–1) to consider text English. Below this, Non-EN safeguards can apply.</span></span>
            </div>
            <input id="cfg_en_thresh" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:14px">
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_max_unstable">Max conf (unstable)</label>
              <span class="help-dot" tabindex="0"><span class="tip">Ceiling when internal instability is detected (volatile token probabilities).</span></span>
            </div>
            <input id="cfg_max_unstable" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_abstain_low">Abstain low</label>
              <span class="help-dot" tabindex="0"><span class="tip">Lower bound of the “Inconclusive” band. If probability is in this band, we abstain.</span></span>
            </div>
            <input id="cfg_abstain_low" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <div class="row" style="justify-content:space-between">
              <label for="cfg_abstain_high">Abstain high</label>
              <span class="help-dot" tabindex="0"><span class="tip">Upper bound of the “Inconclusive” band. Keeps borderline cases from over-confidence.</span></span>
            </div>
            <input id="cfg_abstain_high" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;gap:12px">
          <div class="help-wrap">
            <button id="btnReset" class="btn ghost">Reset (reload)</button>
            <span class="help-dot" tabindex="0"><span class="tip">Reload the page and revert UI state.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnSave" class="btn">Save Settings</button>
            <span class="help-dot" tabindex="0"><span class="tip">Persist these settings server-side for future scans.</span></span>
          </div>
        </div>
        <div id="saveStatus" class="muted"></div>
      </div>

      <div class="footer">PD fingerprints: place JSONs in <span class="mono">./pd_fingerprints/</span> on the server.</div>
    </section>
  </div>
</div>

<!-- Live Verification Drawer -->
<div id="liveDrawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Live Verification drawer">
  <div class="drawer-inner">
    <!-- NEW: resize handle -->
  <div id="liveResizeHandle" aria-hidden="true"></div>
  <!-- …rest of drawer… -->
    <div class="row" style="justify-content:space-between;align-items:center;padding:0 6px 8px">
      <h3 style="margin:0">Live Verification (CopyCat)</h3>
      <button id="btnCloseLive" class="btn ghost">Close</button>
    </div>

    <div id="liveHint" class="muted" style="padding:0 6px 10px">
      Paste text above and run a scan first. Then start a live sample to compare your typing style.
    </div>

        <div class="split" style="padding:0 6px 14px">
      <!-- LEFT column -->
      <div class="live-left">
        <textarea id="liveInput" placeholder="Type here for 60–120 words…" rows="7"
                  style="width:100%; resize:vertical; font-family:system-ui, sans-serif;" disabled
                  aria-label="Live typing area"></textarea>
        <div class="row" style="margin-top:10px; flex-wrap:wrap; gap:10px">
          <div class="help-wrap">
            <button id="btnStartLive" class="btn" disabled>Start Live Sample (90s)</button>
            <span class="help-dot" tabindex="0"><span class="tip">Starts a 90-second typing window and shows live token count and progress.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnFinalize" class="btn ghost" aria-live="polite">Finalize</button>
            <span class="help-dot" tabindex="0"><span class="tip">Compute the quick style-match between your typed sample and the scanned text.</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnExport" class="btn ghost" disabled>Copy Summary</button>
            <span class="help-dot" tabindex="0"><span class="tip">Copy a plain-text summary of the scan + live sample (verdict, key metrics, quick match).</span></span>
          </div>
          <div class="help-wrap">
            <button id="btnDownload" class="btn ghost" disabled>Download .txt</button>
            <span class="help-dot" tabindex="0"><span class="tip">Download the same summary as a .txt file (works even when clipboard is blocked).</span></span>
          </div>
          <span id="exportStatus" class="muted" style="margin-left:8px;" aria-live="polite"></span>
        </div>
      </div>

      <!-- RIGHT column -->
      <div class="live-right">
        <div class="card" style="padding:10px;">
          <div class="live-metrics-header">
            <div class="row" style="gap:18px; margin-bottom:4px;">
              <div>Time: <span id="liveTimer">—</span></div>
              <div>Tokens: <span id="liveTokens">0</span> <small class="muted">(words)</small></div>
              <div>Len: <span id="liveLen">0%</span> <small class="muted">(of 120 target)</small></div>
              <div>Match: <span id="liveRough">—</span> <small class="muted">(quick)</small></div>
            </div>

            <div class="live-tabs" role="tablist" aria-label="Live view">
              <button type="button" class="live-tab active" data-tab="summary" role="tab" aria-selected="true">
                Style Match
              </button>
              <button type="button" class="live-tab" data-tab="drift" role="tab" aria-selected="false">
                Consistency Check
              </button>
            </div>
          </div>

          <div class="progress"><span id="liveProgress" style="width:0%"></span></div>

          <div id="liveResult" style="margin-top:10px;" aria-live="polite"></div>

          <!-- Drift compare lives inside the same card now -->
          <div id="liveDriftBox" style="margin-top:10px; display:none">
            <div class="muted">Drift compare (scan vs live sample)</div>
            <div id="liveDriftContent" class="kv" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>


<script>

// --- Demo Mode Sample Texts ---
const DEMO_SAMPLES = {
  "news": `Breaking: A new AI-driven policing system has sparked debate...`,
  "story": `Once the lantern flickered out, Mara realized she wasn't alone...`,
  "essay": `The socioeconomic impact of automation continues to reshape...`,
  "code": `def analyze_text(t):\n    return {"len": len(t)}`,
};

// --- Demo presets ---
const DEMO_PRESET_LABELS = {
  random: "(random curated sample)",
  news:   "News / op-ed",
  story:  "Story / narrative",
  essay:  "Student-style essay",
  code:   "Short code snippet",
};

let currentDemoPreset = "random";

function initDemoPresetSelect() {
  const sel = document.getElementById("demoPreset");
  if (!sel) return;

  // Build options from the label map
  sel.innerHTML = Object.entries(DEMO_PRESET_LABELS)
    .map(([value, label]) => `<option value="${value}">${label}</option>`)
    .join("");

  sel.value = currentDemoPreset;

  sel.addEventListener("change", (e) => {
    const v = String(e.target.value || "").trim();
    currentDemoPreset = DEMO_PRESET_LABELS[v] ? v : "random";
  });
}


/* -------- v0.3.5 -------- */
window.__pdCentroids = 0;
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const api = (p,opts={}) => fetch(p,opts).then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); });
const setMsg = (id,txt)=>{ const el=$( '#'+id ); if(el) el.textContent = txt; };
function setFinalizeEnabled(on){ $("#btnFinalize").disabled = !on; }
function setExportEnabled(on){
  const c=$("#btnExport"), d=$("#btnDownload");
  if(c) c.disabled = !on;
  if(d) d.disabled = !on;
}

/* Drift Diagnostics */
async function driftAnalyze(text){
  const r = await fetch("/drift/analyze", {
    method:"POST", headers:{ "content-type":"application/json" },
    body: JSON.stringify({ text })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function driftCompare(a, b){
  const r = await fetch("/drift/compare", {
    method:"POST", headers:{ "content-type":"application/json" },
    body: JSON.stringify({ a, b })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

// Example render (stick this where you show scan extras)
async function showDriftForCurrent(){
  const text = document.querySelector("#text")?.value || "";
  if(!text.trim()){ alert("Paste text first."); return; }
  const j = await driftAnalyze(text);
  const el = document.getElementById("liveResult") || document.body;
  el.innerHTML =
    `<div class="kv" style="margin-top:8px">
       <div>Paragraphs</div><div class="mono">${j.paragraphs}</div>
       <div>Avg adj. sim</div><div class="mono">${j.avg_adjacent_sim}</div>
       <div>Std adj. sim</div><div class="mono">${j.std_adjacent_sim}</div>
       <div>Risk</div><div class="mono">${j.risk}</div>
       <div>Score (human-like)</div><div class="mono">${j.score}</div>
     </div>`;
}


/* Toggle help on click (outside click / Esc closes) */
document.addEventListener("click", (e)=>{
  const dot = e.target.closest(".help-dot");
  document.querySelectorAll(".help-dot[data-open='1']").forEach(el=>{ if(el!==dot) el.removeAttribute("data-open"); });
  if (dot){ dot.setAttribute("data-open", dot.getAttribute("data-open")==="1" ? "0" : "1"); }
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){ document.querySelectorAll(".help-dot[data-open='1']").forEach(el=>el.removeAttribute("data-open")); closeLive(); }
  if((e.metaKey||e.ctrlKey) && e.key==="Enter"){ finalizeCompute(); }
});

/* UI scale */
$("#uiScale").addEventListener("input", (e)=>{
  const v = Math.max(120, Math.min(220, parseInt(e.target.value||"150",10)));
  document.documentElement.style.setProperty("--scale", (v/100).toString());
});

/* Drawer */
const drawer = $("#liveDrawer");
const openLive = ()=>{ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); };
const closeLive = ()=>{ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); };
$("#btnLive").addEventListener("click", openLive);
$("#btnCloseLive").addEventListener("click", closeLive);

/* ---- Live drawer resize ---- */
(function initLiveResize(){
  const handle = $("#liveResizeHandle");
  if (!handle) return;

  let dragging = false;

  // clamp + apply height (in px)
  function setLiveHeight(px){
    const min = 160;
    const max = Math.max(260, window.innerHeight * 0.85);
    const clamped = Math.min(max, Math.max(min, px));
    document.documentElement.style.setProperty("--live-h", clamped + "px");
  }

  function onMove(e){
    if (!dragging) return;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    const h = window.innerHeight - clientY;   // distance from cursor to bottom
    setLiveHeight(h);
  }

  function stopDrag(){
    if (!dragging) return;
    dragging = false;
    document.removeEventListener("mousemove", onMove);
    document.removeEventListener("mouseup", stopDrag);
    document.removeEventListener("touchmove", onMove);
    document.removeEventListener("touchend", stopDrag);
    document.removeEventListener("touchcancel", stopDrag);
  }

  function startDrag(e){
    dragging = true;
    e.preventDefault();
    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", stopDrag);
    document.addEventListener("touchmove", onMove, { passive:false });
    document.addEventListener("touchend", stopDrag);
    document.addEventListener("touchcancel", stopDrag);
  }

  handle.addEventListener("mousedown", startDrag);
  handle.addEventListener("touchstart", startDrag, { passive:false });

  // keep height sensible when the window resizes
  window.addEventListener("resize", ()=>{
    const h = parseFloat(getComputedStyle(document.documentElement)
      .getPropertyValue("--live-h")) || (window.innerHeight * 0.4);
    setLiveHeight(h);
  });
})();


/* UI writers */
function setProbFill(p){
  const pct = Math.round((p||0)*100);
  $("#probPct").textContent = pct + "%";
  const f = $("#probFill"); f.style.width = pct + "%";
  f.classList.remove("good","warn","bad");
  f.classList.add(p>=0.65?"bad":(p>=0.35?"warn":"good"));
}
function setVerdict(v){
  const pill = $("#verdictPill");
  pill.textContent = v || "—";
  const L = (v||"").toLowerCase();
  const c = L.includes("human") ? "#163626" :
            L.includes("inconclusive") ? "#2f2a12" : "#3a1b1b";
  pill.style.background = c; pill.style.borderColor = "var(--border)";
}
function setModeBadge(m){ $("#activeModeBadge").textContent = "Mode: " + (m||"—"); }
function shortExplain(r){
  if (r?.explanation) return r.explanation;
  const top10 = r?.bins ? Math.round((r.bins[10]/Math.max(1,r.total))*100) : 0;
  return `${r?.verdict||""} — PPL≈${(r?.ppl||0).toFixed(1)}, Top10≈${top10}%`.trim();
}

/* numeric helpers */
const pickNum = (...c)=>{ for(const v of c){ const n=Number(v); if(Number.isFinite(n)) return n; } return null; };
const setTxt = (sel,val,d=3)=>{ const el=$(sel); if(!el) return; if(val==null){ el.textContent="—"; return; } const n=Number(val); el.textContent=Number.isFinite(n)?n.toFixed(d):String(val); };

/* Token table */
function cleanTok(t){
  if (t === "Ċ") return "↵";
  if (t === "Ġ") return "␠";
  return t.replace(/^Ġ/," ")
          .replace(/âĢĿ/g,"“").replace(/âĢĺ/g,"”")
          .replace(/âĢĶ/g,"‘").replace(/âĢĺ/g,"’");
}

function safeSetHTML(el, html){ if(el) el.innerHTML = html; }
function safeSetText(el, txt){ if(el) el.textContent = txt; }

function fillTokenTable(tokens){
  const tbWrap = document.querySelector("#tokTable tbody");
  if (!tbWrap) return;                 // v0.3.4 fallback (no table or id changed)
  tbWrap.innerHTML = "";
  (tokens||[]).forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td class="mono">${i+1}</td>`+
      `<td class="mono">${cleanTok(t.t)}</td>`+
      `<td class="mono">${t.rank}</td>`+
      `<td class="mono">${(t.p||0).toFixed(6)}</td>`;
    tbWrap.appendChild(tr);
  });
}

function setBandBadge(band, pctText){
  const badge = document.getElementById('bandBadge');
  if (!badge) return;
  const dot  = badge.querySelector('.badge-dot');
  const text = document.getElementById('bandText');
  const pct  = document.getElementById('bandPct');

  badge.classList.remove('band-human','band-mixed','band-ai');

  let cls='band-mixed', dotCls='dot-mixed', label = band || 'Inconclusive';
  const b = (band||'').toLowerCase();
  if (b.includes('human')) { cls='band-human'; dotCls='dot-human'; }
  else if (b.includes('ai')) { cls='band-ai'; dotCls='dot-ai'; }

  badge.classList.add(cls);
  if (dot)  dot.className = 'badge-dot ' + dotCls;
  if (text) text.textContent = label;
  if (pct)  pct.textContent  = pctText ? `• ${pctText}` : '';
  badge.style.display = 'inline-flex';
}


function renderExplain(explain, fullJson){
  const wrap  = document.getElementById('explainWrap');
  const head  = document.getElementById('explainHeadline');
  const why   = document.getElementById('explainWhy');
  const fix   = document.getElementById('explainFix');
  const notes = document.getElementById('explainNotes');
  const mini  = document.getElementById('teacherMini');
  const title = document.getElementById('explainTitle');

  // If the whole Explain block isn't on this page version, just bail safely.
  if (!wrap){ return; }

  if (!explain){
    wrap.style.display = 'none';
    return;
  }
  wrap.style.display = 'block';

  // Badge (if present)
  if (document.getElementById('bandBadge')) {
    setBandBadge(explain.band, explain.ai_likelihood_pct);
  }

  // Header + sections (all guarded)
  safeSetText(title, 'What this means');
  safeSetHTML(head, `<b>${explain.headline || ''}</b>`);

  const asList = a => Array.isArray(a) ? a.filter(Boolean) : [];

  const whyList = asList(explain.why).map(s=>`<li>${s}</li>`).join('');
  safeSetHTML(why,  whyList ? `<b>Why we think this:</b><ul class="explain-list">${whyList}</ul>` : '');

  const fixList = asList(explain.what_to_fix).map(s=>`<li>${s}</li>`).join('');
  safeSetHTML(fix,  fixList ? `<b>How to strengthen it:</b><ul class="explain-list">${fixList}</ul>` : '');

  const notesText = asList(explain.notes).join(' ');
  safeSetHTML(notes, notesText ? `<b>Notes:</b> ${notesText}` : '');

  // Compact teacher row (only if mini exists)
  if (mini){
    const t = explain.teacher_report || {};
    const parts = [];
    if (t.nearest_style) parts.push(`Closest style: ${t.nearest_style}`);
    if (t.drift_score != null) parts.push(`Drift score: ${Number(t.drift_score).toFixed(3)}`);
    if (t.pd_overlap_j != null) parts.push(`PD overlap J: ${t.pd_overlap_j}`);
    mini.textContent = parts.join(' • ');
  }

  // PD note (only if notes exists)
  if (notes && !Number(window.__pdCentroids || 0)){
    const msg = "Public-domain fingerprinting is off on this server (no centroids loaded). PD overlap shows ‘—’. Add JSON centroids to ./pd_fingerprints/ and restart.";
    const prefix = notes.innerHTML ? "<br/>" : "";
    notes.innerHTML += prefix + `<b>PD note:</b> ${msg}`;
  }

  // Collapse toggle (only if controls exist)
  const btn  = document.getElementById('explainToggleBtn');
  const body = document.getElementById('explainBody');
  if (btn && body){
    btn.onclick = () => {
      const hidden = body.classList.toggle('hidden');
      btn.textContent = hidden ? 'Show' : 'Hide';
      btn.setAttribute('aria-expanded', String(!hidden));
    };
  }
}

function renderFingerprint(result) {
  const box      = document.getElementById("fpBox");
  const labelEl  = document.getElementById("fpLabel");
  const bandEl   = document.getElementById("fpBand");
  const topEl    = document.getElementById("fpTop");
  const bandCard = document.getElementById("fpBandCard");
  const spreadEl = document.getElementById("fpSpread");
  const notesEl  = document.getElementById("fpNotes");

  if (!box) return;

  // Try a few common shapes for the payload
  const fp = result?.llm_fingerprint
          || result?.fingerprint
          || result?.fp
          || null;

  // Nothing to show → hide the card and clear fields
  if (!fp) {
    box.style.display = "none";
    if (labelEl)  labelEl.textContent  = "—";
    if (bandEl)   bandEl.textContent   = "—";
    if (topEl)    topEl.textContent    = "—";
    if (bandCard) bandCard.textContent = "—";
    if (spreadEl) spreadEl.textContent = "—";
    if (notesEl)  notesEl.textContent  = "—";
    return;
  }

  const top   = fp.nearest ?? fp.top ?? fp.family ?? "—";
  const band  = fp.band ?? fp.bucket ?? "—";
  const spread = fp.spread ?? fp.drift ?? fp.pd_spread ?? "—";
  const notes  = fp.notes || fp.note || "";

  if (labelEl)  labelEl.textContent  = top;
  if (bandEl)   bandEl.textContent   = band;
  if (topEl)    topEl.textContent    = top;
  if (bandCard) bandCard.textContent = band;
  if (spreadEl) spreadEl.textContent = String(spread);
  if (notesEl)  notesEl.textContent  = notes || "—";

  box.style.display = "block";
}


function renderDrift(raw) {
  const box = document.getElementById("driftBox");
  const content = document.getElementById("driftContent");
  if (!box || !content) return;

  const safeNum = (v, d = 3) => {
  if (typeof v !== "number" || !Number.isFinite(v)) return "—";
  return v.toFixed(d);
  };


  // No payload → hide card
  if (!raw) {
    box.style.display = "none";
    content.innerHTML = "";
    return;
  }

  // New: backend nests the drift info under `semantic_drift`
  const j = raw.semantic_drift || raw;

  // Handle the “not available” case if backend ever sends it
  if (j.available === false) {
    box.style.display = "block";
    content.innerHTML = `
      <div>Paragraphs</div><div class="mono">${j.paragraphs ?? "—"}</div>
      <div>Status</div><div class="mono">
        ${j.reason === "single_paragraph"
          ? "Need at least two paragraphs to measure semantic drift."
          : (j.reason || "Drift diagnostics not available.")}
      </div>
    `;
    return;
  }

  // Normal case: we have real stats
  box.style.display = "block";
  content.innerHTML = `
    <div>Paragraphs</div><div class="mono">${j.paragraphs ?? raw.paragraphs ?? "—"}</div>
    <div>Avg adjacent similarity</div><div class="mono">${safeNum(j.avg_adjacent_sim)}</div>
    <div>Std adjacent similarity</div><div class="mono">${safeNum(j.std_adjacent_sim)}</div>
    <div>Risk</div><div class="mono">${safeNum(j.risk)}</div>
    <div>Score (human-like)</div><div class="mono">${safeNum(j.score)}</div>
  `;
}


function renderLiveDrift(raw) {
  const box = document.getElementById("liveDriftBox");
  const content = document.getElementById("liveDriftContent");
  if (!box || !content) return;

  const safeNum = (v, d = 3) => {
    if (typeof v !== "number" || !Number.isFinite(v)) return "—";
    return v.toFixed(d);
  };

  // No payload → show a friendly message but let tabs handle visibility
  if (!raw) {
    content.innerHTML =
      `<div class="mono">Drift compare not available for this sample.</div>`;
    return;
  }

  // Unwrap common shapes
  const driftA = raw.a || raw.A || raw.scan || null;
  const driftB = raw.b || raw.B || raw.live || null;
  const cmp    = raw.compare || raw.c || null;

  let similarity;
  let score;
  let risk;
  let overlap;
  let note = "";

  const isRealNumber = v =>
    typeof v === "number" && Number.isFinite(v);

  // 1) Preferred: explicit compare block
  if (cmp && typeof cmp === "object") {
    if (isRealNumber(cmp.similarity ?? cmp.sim))
      similarity = cmp.similarity ?? cmp.sim;
    if (isRealNumber(cmp.score))
      score = cmp.score;
    if (isRealNumber(cmp.risk))
      risk = cmp.risk;
    if (isRealNumber(cmp.overlap ?? cmp.jaccard))
      overlap = cmp.overlap ?? cmp.jaccard;
  }

  // 2) Fallback: flat fields
  if (!isRealNumber(similarity) && isRealNumber(raw.similarity ?? raw.sim)) {
    similarity = raw.similarity ?? raw.sim;
  }
  if (!isRealNumber(score) && isRealNumber(raw.score)) {
    score = raw.score;
  }
  if (!isRealNumber(risk) && isRealNumber(raw.risk)) {
    risk = raw.risk;
  }
  if (!isRealNumber(overlap) && isRealNumber(raw.overlap ?? raw.jaccard)) {
    overlap = raw.overlap ?? raw.jaccard;
  }

  // 3) Last-resort: derive something from a/b
  if ((!isRealNumber(similarity) || !isRealNumber(score) ||
       !isRealNumber(risk)      || !isRealNumber(overlap)) &&
      driftA && driftB) {

    const sA = driftA.score;
    const sB = driftB.score;
    const rA = driftA.risk;
    const rB = driftB.risk;
    const saA = driftA.avg_adjacent_sim;
    const saB = driftB.avg_adjacent_sim;

    if (!isRealNumber(similarity) && isRealNumber(sA) && isRealNumber(sB)) {
      const diff = Math.min(1, Math.abs(sA - sB));
      similarity = 1 - diff;
      note = "Derived from drift scores (no explicit similarity field).";
    }

    if (!isRealNumber(score) && isRealNumber(sA) && isRealNumber(sB)) {
      score = (sA + sB) / 2;
    }

    if (!isRealNumber(risk) && isRealNumber(rA) && isRealNumber(rB)) {
      risk = Math.max(rA, rB);
    }

    if (!isRealNumber(overlap) && isRealNumber(saA) && isRealNumber(saB)) {
      overlap = (saA + saB) / 2;
    }
  }

  const hasNumeric =
    isRealNumber(similarity) ||
    isRealNumber(score)      ||
    isRealNumber(risk)       ||
    isRealNumber(overlap);

  if (!hasNumeric) {
    content.innerHTML =
      `<div>Drift compare payload not recognized by UI. Raw JSON:</div>` +
      `<pre style="margin-top:6px; max-height:200px; overflow:auto; font-size:11px;">` +
      `${JSON.stringify(raw, null, 2)}</pre>`;
    return;
  }

  let html = `
    <div>Similarity</div><div class="mono">${safeNum(similarity)}</div>
    <div>Score (human-like)</div><div class="mono">${safeNum(score)}</div>
    <div>Risk</div><div class="mono">${safeNum(risk)}</div>
    <div>Overlap</div><div class="mono">${safeNum(overlap)}</div>
  `;
  if (note) {
    html += `<div>Notes</div><div class="mono">${note}</div>`;
  }

  content.innerHTML = html;
}

function initLiveTabs(){
  const tabs = document.querySelectorAll(".live-tab");
  if (!tabs.length) return;

  const liveResult = document.getElementById("liveResult");
  const driftBox   = document.getElementById("liveDriftBox");

  function activate(name){
    tabs.forEach(t => {
      const isActive = (t.dataset.tab === name);
      t.classList.toggle("active", isActive);
      t.setAttribute("aria-selected", isActive ? "true" : "false");
    });

    if (liveResult) liveResult.style.display = (name === "summary") ? "block" : "none";
    if (driftBox)   driftBox.style.display   = (name === "drift")    ? "block" : "none";
  }

  tabs.forEach(t => {
    t.addEventListener("click", () => {
      const tabName = t.dataset.tab || "summary";
      activate(tabName);
    });
  });

  // default view
  activate("summary");
}



function renderLlmFingerprint(result) {
  const box      = document.getElementById("llmBox");
  const famEl    = document.getElementById("llmFamily");
  const confEl   = document.getElementById("llmConf");
  const humanEl  = document.getElementById("llmHuman");
  const bandEl   = document.getElementById("llmBand");
  const legendEl = document.getElementById("llmLegend");
  const canvas   = document.getElementById("llmCanvas");

  if (!box || !canvas) return;

  // Try to find the fingerprint payload in a few common shapes
  const fp = result?.llm_fingerprint || result?.llm_fp || result?.llmFingerprint || null;

  if (!fp) {
    box.style.display = "none";
    if (legendEl) legendEl.textContent = "";
    if (famEl) famEl.textContent = "—";
    if (confEl) confEl.textContent = "—";
    if (humanEl) humanEl.textContent = "—";
    if (bandEl) bandEl.textContent = "—";
    return;
  }

  const family = fp.nearest_family || fp.nearest || fp.family || "—";
  const conf   = fp.confidence ?? fp.score ?? null;
  const human  = fp.human_score ?? fp.human ?? null;
  const dist   = fp.distribution || {};

  const labels = Object.keys(dist);
  const values = labels.map(k => Number(dist[k]) || 0);

  // Header line
  if (famEl)   famEl.textContent  = family;
  if (confEl)  confEl.textContent = conf != null ? (conf * 100).toFixed(1) + "%" : "—";
  if (humanEl) humanEl.textContent = human != null ? (human * 100).toFixed(1) + "%" : "—";

  // Band pill: whichever bucket is largest
  if (bandEl) {
    if (labels.length) {
      let topIdx = 0;
      for (let i = 1; i < labels.length; i++) {
        if (values[i] > values[topIdx]) topIdx = i;
      }
      bandEl.textContent = labels[topIdx];
    } else {
      bandEl.textContent = "—";
    }
  }

  // Draw simple bar chart
  const ctx = canvas.getContext("2d");
  const w   = canvas.width  = canvas.clientWidth || 480;
  const h   = canvas.height = 120;

  ctx.clearRect(0, 0, w, h);

  if (!labels.length) {
    if (legendEl) legendEl.textContent = "Fingerprint available, but no distribution payload from server.";
    box.style.display = "block";
    return;
  }

  const max = Math.max(...values, 0.001);
  const barW = w / (labels.length * 1.8);
  const baseY = h - 22;

  labels.forEach((lab, i) => {
    const v = values[i];
    const x = (i + 0.5) * (w / labels.length) - barW / 2;
    const bh = (v / max) * (h - 40);

    // bar
    ctx.fillStyle = "#3b82f6";
    ctx.fillRect(x, baseY - bh, barW, bh);

    // label
    ctx.fillStyle = "#c4cbe3";
    ctx.font = "10px system-ui, -apple-system, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(lab.replace(/-.*/, ""), x + barW / 2, h - 6);
  });

  if (legendEl) {
    legendEl.textContent =
      "Relative style fingerprint scores across families: " +
      labels.join(", ");
  }

  box.style.display = "block";
}


// also make the /scan raw-dump close safe (if your code has this line elsewhere):
const rawBoxEl = document.getElementById("rawJsonBox");
if (rawBoxEl && typeof rawBoxEl.removeAttribute === "function"){
  // no-op here; left for parity with your try block
}

/* ---------- Live verification ---------- */
let lastScanMetrics = null;
let lastScanResult  = null;
let lastExportText  = "";
let didScan = false;
let lastScanText = "";

function tokenizeWords(text){ return (text.toLowerCase().match(/[a-z’']+|\d+|[^\s\w]/g) || []); }
const FN_WORDS = new Set(("a,an,the,of,to,in,for,with,on,at,by,from,as,that,this,which,who,whom,whose,and,or,but,if,then,so,because,while,where,about,into,over,after,before,between,through,during,without,within,against,under,above,across,around,per,via,is,am,are,was,were,be,been,being").split(","));
function punctEntropy(text){
  const punct = text.match(/[.,;:!?()-]/g) || []; if(!punct.length) return 0;
  const counts={}; punct.forEach(p=>counts[p]=(counts[p]||0)+1);
  const N=punct.length; let H=0; for(const k in counts){ const p=counts[k]/N; H-=p*Math.log2(p); } return H;
}
function simpleMetrics(text){
  const tokens = tokenizeWords(text);
  const words = tokens.filter(t=>/^[a-z’']+$/.test(t));
  const n = words.length || 1;
  const uniq = new Set(words).size;
  const fnCount = words.reduce((a,w)=>a+(FN_WORDS.has(w)?1:0),0);
  const func_ratio = fnCount/n;
  const hapax_ratio = uniq/n;
  const sentences = text.split(/(?<=[.!?])\s+/).filter(s=>s.trim().length>0);
  const lens = sentences.map(s => (s.match(/\b\w+\b/g)||[]).length);
  const sent_mean = lens.length ? lens.reduce((a,b)=>a+b,0)/lens.length : 0;
  const sent_var  = lens.length ? lens.reduce((a,b)=>a+(b-sent_mean)**2,0)/lens.length : 0;
  const pent = punctEntropy(text);
  return { func_ratio, hapax_ratio, sent_mean, sent_var, punct_entropy: pent };
}
function cosineSimilarity(a,b){
  const keys=["func_ratio","hapax_ratio","sent_mean","sent_var","punct_entropy"];
  let dot=0,na=0,nb=0; for(const k of keys){ const x=Number(a[k])||0, y=Number(b[k])||0; dot+=x*y; na+=x*x; nb+=y*y; }
  return (na&&nb)?(dot/(Math.sqrt(na)*Math.sqrt(nb))):0;
}
function renderLiveCompare(userM, refM){
  const sim = Math.max(0,Math.min(1,cosineSimilarity(userM,refM)));
  const pct = Math.round(sim*100);
  const fields=[["Function word ratio","func_ratio",3],["Hapax ratio","hapax_ratio",3],["Sent. mean","sent_mean",2],["Sent. var","sent_var",2],["Punct entropy","punct_entropy",3]];
  let html = `<div class="row" style="gap:12px"><strong>Match (quick):</strong> <span class="pill">${pct}%</span></div>`;
  html += `<div class="kv" style="margin-top:8px">`;
  for(const [label,key,d] of fields){
    const u=Number(userM[key])||0, r=Number(refM[key])||0, diff=u-r;
    html += `<div>${label}</div><div class="mono">you ${u.toFixed(d)} • ref ${r.toFixed(d)} • Δ ${(diff>=0?"+":"")}${diff.toFixed(d)}</div>`;
  }
  html += `</div>`;
  return { html, pct };
}

/* ---------- Scan ---------- */
async function runScan(){
  const demoOn = $("#demoToggle").checked;

  // Whatever is in the textarea right now
  let text = $("#text").value.trim();
  const hadUserText = text.length > 0;

  // If demo is on AND user hasn’t typed anything,
  // pull from the selected preset instead of random.
  if (demoOn && !hadUserText) {
    const presetSel  = $("#demoPreset");
    const presetKey  = presetSel ? presetSel.value : "random";

    if (presetKey === "random") {
      // Old behavior: random curated sample
      const keys = Object.keys(DEMO_SAMPLES);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    } else if (DEMO_SAMPLES[presetKey]) {
      // Use the requested preset
      text = DEMO_SAMPLES[presetKey];
    } else {
      // Safety fallback: still pick something valid
      const keys = Object.keys(DEMO_SAMPLES);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    }

    // Reflect the chosen text in the textarea so it’s obvious
    $("#text").value = text;
  }

  // If *still* no text, bail with error message
  if (!text) {
    $("#err").style.display = "block";
    $("#err").textContent   = "Please enter some text.";
    return;
  }

  lastScanText = text;
  $("#err").style.display = "none";
  $("#btnScan").disabled  = true;

  // Status text: distinguish demo vs normal
  $("#scanStatus").textContent =
    (demoOn && !hadUserText) ? "Scanning demo sample…" : "Scanning…";

  try {
    const body = {
      text,
      tag:  $("#tag").value.trim() || null,
      mode: $("#mode").value || null,
      demo_mode: demoOn || false   // nice to have for backend / logs
    };

    const r = await api("/scan", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body)
    });

    didScan       = true;
    lastScanResult = r;

    renderExplain(r.explain, r);
    renderFingerprint(r);

    // Drift diagnostics
    try {
      const drift = await driftAnalyze(text);
      renderDrift(drift);
    } catch (e) {
      console.warn("Drift diagnostics failed:", e);
      renderDrift(null);
    }

    // LLM fingerprint card
    try {
      renderLlmFingerprint(r);
    } catch (e) {
      console.warn("LLM fingerprint render failed:", e);
      renderLlmFingerprint(null);
    }

    const rawBox = document.getElementById("rawDump");
    if (rawBox) rawBox.textContent = JSON.stringify(r, null, 2);
    document.getElementById("rawJsonBox")?.removeAttribute("open");

    $("#result").style.display = "block";
    setProbFill(r.calibrated_prob || 0);
    setVerdict(r.verdict || "—");

    const NS = r.nonsense_signals || {};
    const top10Pct  = Number.isFinite(NS.top10)
      ? Math.round(NS.top10*100)
      : (r.bins ? Math.round((r.bins[10]  / Math.max(1,r.total))*100) : null);
    const top100Pct = Number.isFinite(NS.top100)
      ? Math.round(NS.top100*100)
      : (r.bins ? Math.round((r.bins[100] / Math.max(1,r.total))*100) : null);

    $("#top10").textContent   = top10Pct  ?? "—";
    $("#top100").textContent  = top100Pct ?? "—";
    $("#ppl").textContent     = (NS.ppl ?? r.ppl ?? 0).toFixed(2);
    $("#burst").textContent   = (NS.burst ?? r.burstiness ?? 0).toFixed(3);
    $("#category").textContent = r.category
      ? `${r.category} (${Math.round((r.category_conf||0)*100)}%)`
      : "—";
    $("#modelName").textContent = r.model_name || "—";
    $("#modeEcho").textContent  = r.mode || "—";
    $("#pdj").textContent       = (r.pd_overlap_j ?? 0).toFixed(3);
    $("#tagEcho").textContent   = body.tag || "—";
    $("#explainShort").textContent = shortExplain(r);

    fillTokenTable(r.per_token || []);

    const S = r.stylometry || r.style || r.metrics?.stylometry || r.stats?.stylometry || {};
    const N2 = r.nonsense_signals || r.nonsense || r.metrics?.nonsense || r.stats?.nonsense || {};

    setTxt("#sty_func",  pickNum(S.func_ratio, S.function_word_ratio, S.funcWordsRatio), 3);
    setTxt("#sty_hapax", pickNum(S.hapax_ratio, S.hapax, S.hapaxRatio), 3);
    setTxt("#sty_smean", pickNum(S.sent_mean, S.sentence_mean, S.sentMean), 2);
    setTxt("#sty_svar",  pickNum(S.sent_var, S.sentence_var, S.sentVar), 2);
    setTxt("#sty_mlps",  pickNum(S.mlps, S.delta_logp_mean, S.dlogp_mean, S.deltaLogpMean), 4);
    setTxt("#sty_mlpsv", pickNum(S.mlps_var, S.delta_logp_var, S.dlogp_var, S.deltaLogpVar), 4);
    setTxt("#sty_pent",  pickNum(S.punct_entropy, S.punctuation_entropy, S.punctEntropy), 3);

    setTxt("#ns_rhyme", pickNum(N2.rhyme_density, N2.rhyme, N2.rhymeDensity), 3);
    setTxt("#ns_meter", pickNum(N2.meter_cv, N2.meter, N2.meterCV), 3);
    setTxt("#ns_inv",   pickNum(N2.invented_ratio, N2.invented, N2.inventedRatio), 3);
    setTxt("#ns_lex",   pickNum(N2.lex_hits, N2.lexHits), 0);
    setTxt("#ns_sem",   pickNum(N2.semantic_disc, N2.semantic_discontinuity, N2.semanticDisc), 3);

    lastScanMetrics = {
      func_ratio:    Number(S.func_ratio ?? S.function_word_ratio ?? 0),
      hapax_ratio:   Number(S.hapax_ratio ?? S.hapax ?? 0),
      sent_mean:     Number(S.sent_mean ?? S.sentence_mean ?? 0),
      sent_var:      Number(S.sent_var  ?? S.sentence_var  ?? 0),
      punct_entropy: Number(S.punct_entropy ?? S.punctuation_entropy ?? 0),
    };

    $("#btnStartLive").disabled = false;
    $("#liveInput").disabled    = false;
    setFinalizeEnabled(true);
    setExportEnabled(false);
    setMsg("exportStatus","");
  } catch (e) {
    $("#err").style.display = "block";
    $("#err").textContent   = "Scan failed: " + e.message;
  } finally {
    $("#btnScan").disabled = false;
    $("#scanStatus").textContent = "";
  }
}

/* Demos */
async function loadDemos(){
  $("#btnDemo").disabled = true;
  try {
    const preset = currentDemoPreset;
    let text = "";

    if (preset === "random") {
      const keys = Object.keys(DEMO_SAMPLES);
      if (!keys.length) {
        $("#text").value = "No demo samples configured.";
        return;
      }
      const pick = keys[Math.floor(Math.random() * keys.length)];
      text = DEMO_SAMPLES[pick];
    } else {
      text = DEMO_SAMPLES[preset] || "";
      if (!text) {
        $("#text").value = `Demo preset "${preset}" not available.`;
        return;
      }
    }

    $("#text").value = text;
  } catch (e) {
    $("#text").value = "Failed to load demo sample: " + e.message;
  } finally {
    $("#btnDemo").disabled = false;
  }
}


/* Live typing */
let liveStartTs = null, liveTimerId = null, liveComputingTimer = null;

async function finalizeCompute(){
  const typed = $("#liveInput").value.trim();

  if (!didScan){
    setMsg("liveResult","Run a scan first to have a reference.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  if (!typed) {
    setMsg("liveResult","No sample typed.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  const wordCount = tokenizeWords(typed).filter(t=>/^[a-z’']+$/i.test(t)).length;
  if (wordCount < 60) {
    setMsg("liveResult","Type at least ~60 words for a stable compare.");
    setExportEnabled(false);
    renderLiveDrift(null);
    return;
  }

  const userM = simpleMetrics(typed);
  const { html, pct } = renderLiveCompare(userM, lastScanMetrics);
  $("#liveResult").innerHTML = html;

  lastExportText = buildExportText(lastScanResult, userM, lastScanMetrics, pct);
  setExportEnabled(true);
  setMsg("exportStatus","Summary ready.");

  // NEW: call /drift/compare for scan vs live sample
  try {
    if (lastScanText) {
      const drift = await driftCompare(lastScanText, typed);
      renderLiveDrift(drift);
    } else {
      renderLiveDrift(null);
    }
  } catch (e) {
    console.warn("Live drift compare failed:", e);
    renderLiveDrift({ note: "Drift compare unavailable: " + e.message });
  }
}

function tickTimer(){
  if(!liveStartTs) return;
  const s = Math.max(0, Math.floor((Date.now()-liveStartTs)/1000));
  $("#liveTimer").textContent = s + "s";
  if (s >= 90) { $("#liveRough").textContent = "Computing…"; stopLive(true); }
}

function updateLiveHUD(){
  const typed = $("#liveInput").value;
  const tokens = tokenizeWords(typed);
  const words  = tokens.filter(t=>/^[a-z’']+$/i.test(t));
  const count  = words.length;

  $("#liveTokens").textContent = String(count);

  const pct = Math.min(100, Math.round((count/120)*100));
  $("#liveProgress").style.width = pct + "%";
  const lenEl = $("#liveLen"); if (lenEl) lenEl.textContent = pct + "%";

  if (lastScanMetrics && count >= 20){
    const sim = Math.round(100 * Math.max(0, Math.min(1, cosineSimilarity(simpleMetrics(typed), lastScanMetrics))));
    $("#liveRough").textContent = `~${sim}%`;
  } else {
    $("#liveRough").textContent = "—";
  }
}

function startLive(){
  $("#liveResult").textContent = "";
  $("#btnStartLive").disabled = true;
  setFinalizeEnabled(true);
  $("#liveProgress").style.width = "0%";
  const lenEl = $("#liveLen"); if (lenEl) lenEl.textContent = "0%";
  $("#liveRough").textContent = "—";
  liveStartTs = Date.now();
  liveTimerId = setInterval(() => { tickTimer(); updateLiveHUD(); }, 500);
}
function stopLive(autoFinalize=false){
  clearInterval(liveTimerId); liveTimerId = null; liveStartTs = null;
  $("#btnStartLive").disabled = false;
  setFinalizeEnabled(true);
  if (autoFinalize){
    clearTimeout(liveComputingTimer);
    liveComputingTimer = setTimeout(() => finalizeCompute(), 600);
  }
}

/* ----- Export (plain text summary) ----- */
function buildExportText(scan, userM, refM, simPct){
  const ts = new Date().toISOString();
  const sampleWords = tokenizeWords($("#liveInput").value).filter(t=>/^[a-z’']+$/i.test(t)).length;
  const runtime = $("#activeModeBadge")?.textContent.replace("Mode: ","") || (scan?.mode ?? "—");
  const ensemOn = (($("#ensemBadge")?.textContent)||"").toLowerCase().includes("on") ? "on" : "off";
  const pdn = Number(window.__pdCentroids || 0);

  const lines = [];
  if (scan){
    const prob = Number(scan.calibrated_prob ?? 0);
    const probPct = Math.round(prob*100);
    lines.push("CopyCat — Scan Summary");
    lines.push(`Timestamp: ${ts}`);
    lines.push(`Verdict: ${scan.verdict ?? "—"} (${probPct}%)`);
    if (scan.category) lines.push(`Category: ${scan.category} (${Math.round((scan.category_conf||0)*100)}%)`);
    lines.push(`Model: ${scan.model_name ?? "—"} | Runtime: ${runtime} | Ensemble: ${ensemOn}`);
    if (typeof scan.pd_overlap_j === "number") lines.push(`PD overlap J: ${scan.pd_overlap_j.toFixed(3)}`);
    lines.push(`PD fingerprints loaded: ${pdn > 0 ? pdn : "none"}`);
    lines.push("");
    lines.push("Quick style match (Live Verification):");
    lines.push(`Match: ${simPct}%`);
    lines.push(`Live words: ${sampleWords}`);
  }
  const fields = [
    ["Function word ratio","func_ratio",3],
    ["Hapax ratio","hapax_ratio",3],
    ["Sent. mean","sent_mean",2],
    ["Sent. var","sent_var",2],
    ["Punct entropy","punct_entropy",3],
  ];
  lines.push("");
  for(const [label,key,d] of fields){
    const u = Number(userM?.[key] ?? 0);
    const r = Number(refM?.[key] ?? 0);
    const diff = u - r;
    lines.push(`${label}: you ${u.toFixed(d)} | ref ${r.toFixed(d)} | Δ ${(diff>=0?"+":"")}${diff.toFixed(d)}`);
  }
  return lines.join("\n");
}

async function copyExport(){
  if (!lastExportText){ setMsg("exportStatus","Nothing to copy yet."); return; }
  try{
    await navigator.clipboard.writeText(lastExportText);
    setMsg("exportStatus","Copied to clipboard.");
  }catch{
    // Fallback for Safari/iOS/permission blocks
    const ta = document.createElement("textarea");
    ta.value = lastExportText;
    ta.style.position="fixed"; ta.style.opacity="0";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand("copy"); setMsg("exportStatus","Copied (fallback)."); }
    catch(e){ setMsg("exportStatus","Copy failed: " + e.message); }
    finally{ document.body.removeChild(ta); }
  }
}
function downloadExportTxt(){
  if (!lastExportText){ setMsg("exportStatus","Nothing to download yet."); return; }
  const blob = new Blob([lastExportText], {type: "text/plain"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = `copycat_summary_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  setMsg("exportStatus","Downloaded .txt.");
}

/* ----- Config I/O (unchanged API surface, but shows version bump) ----- */
async function loadVersion(){
  try{
    const v = await api("/version");
    $("#version").textContent = `v${v.version || "0.3.8"} • ${v.model} • ${v.device} ${v.dtype} • ensemble=${v.ensemble?"on":"off"}`;
    $("#ensemBadge").textContent = v.ensemble ? "Ensemble: on" : "Ensemble: off";
    const pdn = Number(v.fingerprint_centroids ?? 0);
    const pd  = $("#pdBadge");
    if (pd) {
      const has = pdn > 0;
      pd.textContent = has ? `PD: ${pdn}` : "PD: none";
      pd.style.background = has ? "#163626" : "#2f2a12";
      pd.style.borderColor = "var(--border)";
      pd.setAttribute("aria-label", has ? `${pdn} PD fingerprint centroids loaded` : "No PD fingerprint centroids loaded");
      window.__pdCentroids = pdn;
    }
  }catch{
    $("#version").textContent = "v0.3.5";
  }
}
async function loadConfig(){
  try{
    const j = await api("/config"); const s = j.settings || {};
    $("#cfg_mode").value = s.mode || "Balanced";
    $("#use_ensemble").checked = !!s.use_ensemble;
    $("#cfg_min_tokens").value = s.min_tokens_strong ?? 180;
    $("#cfg_short_cap").checked = !!s.short_cap;
    $("#cfg_max_conf_short").value = (s.max_conf_short ?? 0.35);
    $("#cfg_non_en_cap").value = (s.non_en_cap ?? 0.15);
    $("#cfg_en_thresh").value = (s.en_thresh ?? 0.70);
    $("#cfg_max_unstable").value = (s.max_conf_unstable ?? 0.35);
    $("#cfg_abstain_low").value = (s.abstain_low ?? 0.35);
    $("#cfg_abstain_high").value = (s.abstain_high ?? 0.65);
    setModeBadge(s.mode || "Balanced");
    $("#mode").value = s.mode || "Balanced";
  }catch(e){ $("#saveStatus").textContent = "Failed to load settings: "+e.message; }
}
async function saveConfig(){
  const body = {
    mode: $("#cfg_mode").value,
    short_cap: $("#cfg_short_cap").checked,
    min_tokens_strong: parseInt($("#cfg_min_tokens").value || "180",10),
    use_ensemble: $("#use_ensemble").checked,
    non_en_cap: parseFloat($("#cfg_non_en_cap").value || "0.15"),
    en_thresh: parseFloat($("#cfg_en_thresh").value || "0.70"),
    max_conf_unstable: parseFloat($("#cfg_max_unstable").value || "0.35"),
    max_conf_short: parseFloat($("#cfg_max_conf_short").value || "0.35"),
    abstain_low: parseFloat($("#cfg_abstain_low")?.value || "0.35"),
    abstain_high: parseFloat($("#cfg_abstain_high")?.value || "0.65"),
  };
  try{
    $("#btnSave").disabled = true; $("#saveStatus").textContent = "Saving…";
    const j = await api("/config",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    $("#saveStatus").textContent = "Saved.";
    setModeBadge(j.settings.mode);
    $("#mode").value = j.settings.mode;
    await loadVersion();
  }catch(e){ $("#saveStatus").textContent = "Save failed: "+e.message; }
  finally{ $("#btnSave").disabled = false; }
}

/* Wire */
$("#btnScan").addEventListener("click", runScan);
$("#btnDemo").addEventListener("click", loadDemos);
$("#btnClear").addEventListener("click", ()=>{
  $("#text").value="";
  $("#result").style.display="none";
  $("#err").style.display="none";
  $("#btnStartLive").disabled = true;
  $("#liveInput").disabled = true;
  didScan = false;
  setFinalizeEnabled(false);
  setExportEnabled(false);
  lastExportText = "";
  setMsg("exportStatus","");

  // v0.3.7 — reset drift UI
  const driftBox = document.getElementById("driftBox");
  const driftContent = document.getElementById("driftContent");
  if (driftBox) driftBox.style.display = "none";
  if (driftContent) driftContent.innerHTML = "";
    const liveDriftContent = document.getElementById("liveDriftContent");
  if (liveDriftContent) liveDriftContent.innerHTML = "";

  // reset tabs back to Summary
  initLiveTabs();


});

$("#btnSave").addEventListener("click", saveConfig);
$("#btnReset").addEventListener("click", ()=>location.reload());
$("#btnStartLive").addEventListener("click", startLive);
$("#btnFinalize").addEventListener("click", finalizeCompute);
$("#btnExport").addEventListener("click", copyExport);
$("#btnDownload").addEventListener("click", downloadExportTxt);

(async function init(){
  await loadVersion();
  await loadConfig();
  initDemoPresetSelect();
  initLiveTabs();
  setFinalizeEnabled(false);
  setExportEnabled(false);
})();

</script>
</body>
</html>

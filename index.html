<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Text Scanner — CopyCat</title>
<style>
  :root{
    --bg:#0f1220; --panel:#181c2f; --muted:#c4cbe3; --text:#f1f4ff; --accent:#7eb4ff;
    --good:#45c176; --warn:#f2c94c; --bad:#ef6a6a; --border:#2a3250; --panel-2:#13182b;
    --scale:1.50;                /* default ~150% for readability */
    --wrap-max:1800px;           /* allow to stretch wide */
  }
  html,body{
    margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    font-size:calc(16px * var(--scale)); line-height:1.55;
  }
  .wrap{max-width:var(--wrap-max); width:98vw; margin:22px auto;}
  .grid{display:grid;gap:18px}
  .cols{grid-template-columns: 1.25fr 1fr} /* original feel, just roomier */
  @media (max-width: 1100px){ .cols{grid-template-columns: 1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  label{color:var(--muted)}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;background:#101426;color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px 14px;min-height:42px;font-size:1em;
  }
  textarea{min-height:360px;resize:vertical}
  .btn{background:var(--accent);border:none;color:#091120;padding:11px 16px;border-radius:10px;font-weight:700;cursor:pointer;min-height:42px}
  .btn.secondary{background:#253055;color:var(--text)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .pill{padding:4px 10px;border-radius:999px;background:#1a2346;color:#cfe0ff;border:1px solid var(--border)}
  .bar{height:22px;border:1px solid var(--border);border-radius:12px;background:#0c1122;position:relative}
  .bar>.fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:12px}
  .fill.good{background:var(--good)} .fill.warn{background:var(--warn)} .fill.bad{background:var(--bad)}
  .kv{display:grid;grid-template-columns: 1fr auto;gap:8px 16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
  th{color:var(--muted)}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .footer{margin-top:14px;color:var(--muted);font-size:.95em}

  /* Live Verification drawer (unchanged behavior) */
  .drawer{position:fixed;left:0;right:0;bottom:0;background:var(--panel-2);
    border-top:1px solid var(--border);transform:translateY(100%);transition:transform .25s ease;z-index:50}
  .drawer.open{transform:translateY(0)}
  .drawer-inner{max-width:var(--wrap-max); width:98vw; margin:0 auto; padding:14px 0}
  .split{display:grid;grid-template-columns: 1fr 400px; gap:18px}
  @media (max-width: 1024px){ .split{grid-template-columns: 1fr} }
  .progress{height:10px;border-radius:6px;background:#2a3240;overflow:hidden}
  .progress>span{display:block;height:100%;width:0;background:#3b82f6;transition:width .25s}

  /* Make “Open Live Verification” noticeable, but keep layout */
  #btnLive{position:relative}
  #btnLive::after{
    content:'opens drawer at bottom'; position:absolute; left:100%; top:50%;
    transform:translate(10px,-50%); font-size:.9em; color:var(--muted); white-space:nowrap;
  }

  /* UI scale slider */
  .scale-wrap{display:flex;align-items:center;gap:10px}
  input[type="range"]{accent-color:#7eb4ff}

  /* ===== Accessibility / Action Button Size Boost ===== */

/* Make *all* buttons readable (even ones without .btn) */
button,
.btn,
.drawer button {
  font-size: 1.05em;           /* bigger text */
  padding: 12px 18px;          /* bigger hit area */
  min-height: 46px;            /* consistent height */
  border-radius: 12px;
}

/* Ensure the tiny inline utility buttons match size */
.card .row button,
.card > button {
  font-size: 1.05em;
  padding: 12px 18px;
  min-height: 46px;
}

/* Keep ghost buttons visible at larger size */
.btn.ghost {
  border-width: 1.5px;
}

/* Inputs/selects next to those buttons should match height */
input[type="text"],
input[type="number"],
select {
  min-height: 46px;
  font-size: 1.05em;
  padding: 12px 14px;
}

/* Make the UI scale slider and checkboxes easier to use */
input[type="range"] {
  height: 12px;
}
input[type="checkbox"] {
  transform: scale(1.35);
  transform-origin: left center;
}

/* Per-token table readability */
table th, table td {
  padding: 10px 12px;
  font-size: 1.02em;
}

/* Details summary (toggle) should be easy to click */
details > summary {
  font-size: 1.05em;
  padding: 6px 0;
  cursor: pointer;
}


</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <strong>CopyCat — AI Text Scanner</strong>
      <span id="version" class="muted"></span>
    </div>
    <div class="scale-wrap">
      <label class="muted" for="uiScale">UI scale</label>
      <input id="uiScale" type="range" min="120" max="220" value="150" />
    </div>
  </div>

  <div class="grid cols">
    <!-- Left: Scanner -->
    <section class="card" aria-label="AI Text Scanner">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">AI Text Scanner</h2>
        <span class="muted" id="ensemBadge"></span>
      </div>
      <div class="row">
        <button id="btnDemo" class="btn secondary">Load Demo Samples</button>
        <button id="btnClear" class="btn ghost">Clear</button>
        <button id="btnLive" class="btn ghost" aria-controls="liveDrawer">Open Live Verification</button>
      </div>

      <label for="text">Text to scan</label>
      <textarea id="text" placeholder="Paste or type text to analyze…"></textarea>

      <div class="grid" style="grid-template-columns: 1fr 1fr auto; gap:12px; margin-top:12px">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option>Balanced</option><option>Strict</option><option>Academic</option>
          </select>
          <div class="muted" style="font-size:.95em">Overrides current runtime mode for this scan only.</div>
        </div>
        <div>
          <label for="tag">Optional tag</label>
          <input id="tag" type="text" placeholder="e.g., classic, pre-1920, …" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button id="btnScan" class="btn">Scan</button>
          <span id="scanStatus" class="muted"></span>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="result" style="margin-top:16px; display:none">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Result</h3>
          <span id="verdictPill" class="pill">—</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <div>Calibrated probability (AI likelihood)</div><div id="probPct" class="right mono">—</div>
          <div style="grid-column:1 / -1"><div class="bar"><div class="fill" id="probFill"></div></div></div>

          <div>Explanation</div><div id="explainShort" class="right muted">—</div>
          <div>Top-10 tokens</div><div id="top10" class="right mono">—</div>
          <div>Top-100 tokens</div><div id="top100" class="right mono">—</div>
          <div>Perplexity</div><div id="ppl" class="right mono">—</div>
          <div>Burstiness</div><div id="burst" class="right mono">—</div>
          <div>Category</div><div id="category" class="right mono">—</div>
          <div>Model</div><div id="modelName" class="right mono">—</div>
          <div>Mode</div><div id="modeEcho" class="right mono">—</div>
          <div>PD overlap J</div><div id="pdj" class="right mono">—</div>
          <div>Tag</div><div id="tagEcho" class="right mono">—</div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:18px; margin-top:14px">
          <div class="card" style="padding:12px">
            <div class="muted">Stylometry</div>
            <div class="kv">
              <div>Function word ratio</div><div id="sty_func" class="right mono">—</div>
              <div>Hapax ratio</div><div id="sty_hapax" class="right mono">—</div>
              <div>Sent. mean</div><div id="sty_smean" class="right mono">—</div>
              <div>Sent. var</div><div id="sty_svar" class="right mono">—</div>
              <div>Δlogp mean</div><div id="sty_mlps" class="right mono">—</div>
              <div>Δlogp var</div><div id="sty_mlpsv" class="right mono">—</div>
              <div>Punct entropy</div><div id="sty_pent" class="right mono">—</div>
            </div>
          </div>
          <div class="card" style="padding:12px">
            <div class="muted">Nonsense guard</div>
            <div class="kv">
              <div>Rhyme density</div><div id="ns_rhyme" class="right mono">—</div>
              <div>Meter CV</div><div id="ns_meter" class="right mono">—</div>
              <div>Invented word ratio</div><div id="ns_inv" class="right mono">—</div>
              <div>Lex hits</div><div id="ns_lex" class="right mono">—</div>
              <div>Semantic discontinuity</div><div id="ns_sem" class="right mono">—</div>
            </div>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>Per-token ranks & probs</summary>
          <div style="max-height:420px;overflow:auto;margin-top:8px;border:1px solid var(--border);border-radius:10px">
            <table id="tokTable">
              <thead><tr><th>#</th><th>token</th><th>rank</th><th>p</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>

        <div class="footer">CSV log and a PDF report are generated server-side per scan.</div>
      </div>

      <div id="err" class="footer" style="color:#ff9f9f;display:none"></div>
    </section>

    <!-- Right: Settings (same column as before, just bigger) -->
    <section class="card" aria-label="Runtime Settings">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Runtime Settings</h2>
        <span class="pill" id="activeModeBadge">Mode: —</span>
      </div>

      <div class="grid" style="gap:16px">
        <div class="row"><input id="use_ensemble" type="checkbox" /> <label for="use_ensemble">Use ensemble (if secondary model loaded)</label></div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <label for="cfg_mode">Default mode</label>
            <select id="cfg_mode"><option>Balanced</option><option>Strict</option><option>Academic</option></select>
          </div>
          <div>
            <label for="cfg_min_tokens">Min tokens strong</label>
            <input id="cfg_min_tokens" type="number" min="1" step="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div class="row"><input id="cfg_short_cap" type="checkbox" /> <label for="cfg_short_cap">Cap short excerpts</label></div>
          <div>
            <label for="cfg_max_conf_short">Max conf (short)</label>
            <input id="cfg_max_conf_short" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:14px">
          <div>
            <label for="cfg_non_en_cap">Non-EN cap</label>
            <input id="cfg_non_en_cap" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <label for="cfg_en_thresh">EN threshold</label>
            <input id="cfg_en_thresh" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:14px">
          <div>
            <label for="cfg_max_unstable">Max conf (unstable)</label>
            <input id="cfg_max_unstable" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <label for="cfg_abstain_low">Abstain low</label>
            <input id="cfg_abstain_low" type="number" step="0.01" min="0" max="1" />
          </div>
          <div>
            <label for="cfg_abstain_high">Abstain high</label>
            <input id="cfg_abstain_high" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;gap:12px">
          <button id="btnReset" class="btn ghost">Reset (reload)</button>
          <button id="btnSave" class="btn">Save Settings</button>
        </div>
        <div id="saveStatus" class="muted"></div>
      </div>

      <div class="footer">PD fingerprints: place JSONs in <span class="mono">./pd_fingerprints/</span> on the server.</div>
    </section>
  </div>
</div>

<!-- Live Verification Drawer -->
<div id="liveDrawer" class="drawer" aria-hidden="true">
  <div class="drawer-inner">
    <div class="row" style="justify-content:space-between;align-items:center;padding:0 6px 8px">
      <h3 style="margin:0">Live Verification (CopyCat)</h3>
      <button id="btnCloseLive" class="btn ghost">Close</button>
    </div>

    <div id="liveHint" class="muted" style="padding:0 6px 10px">
      Paste text above and run a scan first. Then start a live sample to compare your typing style.
    </div>

    <div class="split" style="padding:0 6px 14px">
      <div>
        <textarea id="liveInput" placeholder="Type here for 60–120 words…" rows="7"
                  style="width:100%; resize:vertical; font-family:system-ui, sans-serif;" disabled></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnStartLive" class="btn" disabled>Start Live Sample (90s)</button>
          <button id="btnFinalize" class="btn ghost" disabled>Finalize</button>
        </div>
      </div>

      <div>
        <div class="row" style="gap:18px; margin-bottom:8px;">
          <div>Time: <span id="liveTimer">—</span></div>
          <div>Tokens: <span id="liveTokens">0</span></div>
          <div>Match: <span id="liveRough">0%</span></div>
        </div>
        <div class="progress"><span id="liveProgress" style="width:0%"></span></div>
        <div id="liveResult" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const api = (p,opts={}) => fetch(p,opts).then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); });

/* UI scale */
$("#uiScale").addEventListener("input", (e)=>{
  const v = Math.max(120, Math.min(220, parseInt(e.target.value||"150",10)));
  document.documentElement.style.setProperty("--scale", (v/100).toString());
});

/* Drawer */
const drawer = $("#liveDrawer");
const openLive = ()=>{ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); };
const closeLive = ()=>{ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); };
$("#btnLive").addEventListener("click", openLive);
$("#btnCloseLive").addEventListener("click", closeLive);

/* Result helpers */
function setProbFill(p){
  const pct = Math.round((p||0)*100);
  $("#probPct").textContent = pct + "%";
  const f = $("#probFill"); f.style.width = pct + "%";
  f.classList.remove("good","warn","bad");
  f.classList.add(p>=0.65?"bad":(p>=0.35?"warn":"good"));
}
function setVerdict(v){
  const pill = $("#verdictPill");
  pill.textContent = v || "—";
  const c = (v||"").toLowerCase().includes("human") ? "#163626" :
            (v||"").includes("Inconclusive") ? "#2f2a12" : "#3a1b1b";
  pill.style.background = c; pill.style.borderColor = "var(--border)";
}
function setModeBadge(m){ $("#activeModeBadge").textContent = "Mode: " + (m||"—"); }
function fillTokenTable(tokens){
  const tb = $("#tokTable tbody"); tb.innerHTML = "";
  (tokens||[]).forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${i+1}</td><td class="mono">${t.t}</td><td class="mono">${t.rank}</td><td class="mono">${(t.p||0).toFixed(6)}</td>`;
    tb.appendChild(tr);
  });
}
function shortExplain(r){
  if (r?.explanation) return r.explanation;
  const top10 = r?.bins ? Math.round((r.bins[10]/Math.max(1,r.total))*100) : 0;
  return `${r?.verdict||""} — PPL≈${(r?.ppl||0).toFixed(1)}, Top10≈${top10}%`.trim();
}

/* Load version/config */
async function loadVersion(){
  try{
    const v = await api("/version");
    $("#version").textContent = `v${v.version} • ${v.model} • ${v.device} ${v.dtype} • ensemble=${v.ensemble?"on":"off"}`;
    $("#ensemBadge").textContent = v.ensemble ? "Ensemble: on" : "Ensemble: off";
  }catch{ $("#version").textContent = "version error"; }
}
async function loadConfig(){
  try{
    const j = await api("/config"); const s = j.settings || {};
    $("#cfg_mode").value = s.mode || "Balanced";
    $("#use_ensemble").checked = !!s.use_ensemble;
    $("#cfg_min_tokens").value = s.min_tokens_strong ?? 180;
    $("#cfg_short_cap").checked = !!s.short_cap;
    $("#cfg_max_conf_short").value = (s.max_conf_short ?? 0.35);
    $("#cfg_non_en_cap").value = (s.non_en_cap ?? 0.15);
    $("#cfg_en_thresh").value = (s.en_thresh ?? 0.70);
    $("#cfg_max_unstable").value = (s.max_conf_unstable ?? 0.35);
    $("#cfg_abstain_low").value = (s.abstain_low ?? 0.35);
    $("#cfg_abstain_high").value = (s.abstain_high ?? 0.65);
    setModeBadge(s.mode || "Balanced");
    $("#mode").value = s.mode || "Balanced";
  }catch(e){ $("#saveStatus").textContent = "Failed to load settings: "+e.message; }
}
async function saveConfig(){
  const body = {
    mode: $("#cfg_mode").value, short_cap: $("#cfg_short_cap").checked,
    min_tokens_strong: parseInt($("#cfg_min_tokens").value || "180",10),
    use_ensemble: $("#use_ensemble").checked,
    non_en_cap: parseFloat($("#cfg_non_en_cap").value || "0.15"),
    en_thresh: parseFloat($("#cfg_en_thresh").value || "0.70"),
    max_conf_unstable: parseFloat($("#cfg_max_unstable").value || "0.35"),
    max_conf_short: parseFloat($("#cfg_max_conf_short").value || "0.35"),
    abstain_low: parseFloat($("#cfg_abstain_low").value || "0.35"),
    abstain_high: parseFloat($("#cfg_abstain_high").value || "0.65"),
  };
  try{
    $("#btnSave").disabled = true; $("#saveStatus").textContent = "Saving…";
    const j = await api("/config",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    $("#saveStatus").textContent = "Saved."; setModeBadge(j.settings.mode); $("#mode").value = j.settings.mode;
    await loadVersion();
  }catch(e){ $("#saveStatus").textContent = "Save failed: "+e.message; }
  finally{ $("#btnSave").disabled = false; }
}

/* Scan */
async function runScan(){
  const text = $("#text").value.trim();
  if(!text){ $("#err").style.display="block"; $("#err").textContent="Please enter some text."; return; }
  $("#err").style.display="none"; $("#btnScan").disabled = true; $("#scanStatus").textContent = "Scanning…";
  try{
    const body = { text, tag: $("#tag").value.trim() || null, mode: $("#mode").value || null };
    const r = await api("/scan",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    $("#result").style.display = "block";
    setProbFill(r.calibrated_prob || 0);
    setVerdict(r.verdict || "—");
    $("#top10").textContent  = r.bins ? Math.round((r.bins[10]/Math.max(1,r.total))*100) + "%" : "—";
    $("#top100").textContent = r.bins ? Math.round((r.bins[100]/Math.max(1,r.total))*100) + "%" : "—";
    $("#ppl").textContent    = (r.ppl ?? 0).toFixed(2);
    $("#burst").textContent  = (r.burstiness ?? 0).toFixed(3);
    $("#category").textContent  = r.category ? `${r.category} (${Math.round((r.category_conf||0)*100)}%)` : "—";
    $("#modelName").textContent = r.model_name || "—";
    $("#modeEcho").textContent  = r.mode || "—";
    $("#pdj").textContent       = (r.pd_overlap_j ?? 0).toFixed(3);
    $("#tagEcho").textContent   = (body.tag || "—");
    $("#explainShort").textContent = shortExplain(r);

    fillTokenTable(r.per_token || []);

    // Enable live verification after first scan
    $("#btnStartLive").disabled = false;
    $("#liveInput").disabled = false;
  }catch(e){
    $("#err").style.display="block"; $("#err").textContent = "Scan failed: " + e.message;
  }finally{
    $("#btnScan").disabled = false; $("#scanStatus").textContent = "";
  }
}

/* Demos */
async function loadDemos(){
  $("#btnDemo").disabled = true;
  try{
    const list = await api("/demo");
    if(!Array.isArray(list) || list.length === 0){ $("#text").value = "Demo unavailable."; return; }
    const lines = [];
    list.forEach((d,i)=>{ lines.push(`// ${d.label} — expect: ${d.expect}`); lines.push(d.text); if(i<list.length-1) lines.push(""); });
    $("#text").value = lines.join("\n");
  }catch(e){ $("#text").value = "Failed to load demo samples: "+e.message; }
  finally{ $("#btnDemo").disabled = false; }
}

/* Live typing stub */
let liveStartTs=null, liveTimerId=null;
function tickTimer(){ if(!liveStartTs) return; const s=Math.max(0,Math.floor((Date.now()-liveStartTs)/1000)); $("#liveTimer").textContent=s+"s"; if(s>=90) stopLive(); }
function startLive(){
  $("#liveInput").value=""; $("#liveResult").textContent="";
  $("#btnStartLive").disabled=true; $("#btnFinalize").disabled=false; $("#liveProgress").style.width="0%";
  liveStartTs=Date.now();
  liveTimerId=setInterval(()=>{
    tickTimer();
    const words=$("#liveInput").value.trim().split(/\s+/).filter(Boolean);
    $("#liveTokens").textContent=words.length.toString();
    const pct=Math.min(100,Math.round((words.length/120)*100));
    $("#liveProgress").style.width=pct+"%";
    $("#liveRough").textContent=pct+"%";
  },500);
}
function stopLive(){ clearInterval(liveTimerId); liveTimerId=null; liveStartTs=null;
  $("#btnStartLive").disabled=false; $("#btnFinalize").disabled=true;
  $("#liveResult").textContent="Sample captured. Use server-side tools if you want a formal style comparison.";
}
$("#btnStartLive").addEventListener("click", startLive);
$("#btnFinalize").addEventListener("click", stopLive);

/* Wire up */
$("#btnScan").addEventListener("click", runScan);
$("#btnDemo").addEventListener("click", loadDemos);
$("#btnClear").addEventListener("click", ()=>{ $("#text").value=""; $("#result").style.display="none"; $("#err").style.display="none"; });
$("#btnSave").addEventListener("click", saveConfig);
$("#btnReset").addEventListener("click", ()=>location.reload());
(async function init(){ await loadVersion(); await loadConfig(); })();
</script>
</body>
</html>

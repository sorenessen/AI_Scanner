<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Text Scanner (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1116; --panel:#161a22; --muted:#9aa4b2; --text:#e6edf3;
      --green:#20a464; --yellow:#e3b341; --orange:#f66a0a; --red:#d73a49;
      --blue:#347dff; --gray:#30363d;
      --t10:#b7f5c8; --t100:#d6fbdc; --t1000:#f2e9b0; --rest:#f2c6c6;
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
    .container { max-width:1100px; margin:24px auto 60px; padding:0 16px; }
    h1 { font-size:34px; margin:8px 0 18px; }
    textarea {
      width:100%; min-height:260px; resize:vertical; box-sizing:border-box;
      background:#0b0e14; color:var(--text); border:1px solid var(--gray); border-radius:8px; padding:12px 14px;
      font:14px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      white-space:pre; overflow:auto;
    }
    .controls { display:flex; gap:10px; align-items:center; margin:12px 0 8px; }
    button { background:var(--blue); border:none; color:#fff; padding:9px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    select, .pill { background:var(--panel); color:var(--text); border:1px solid var(--gray); border-radius:8px; padding:8px 10px; }
    .pill { display:inline-block; font-weight:700; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; color:#fff; margin-right:10px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { background:var(--panel); border:1px solid var(--gray); border-radius:12px; padding:14px; }
    .metrics { display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap:10px; }
    .metric { background:#0b0e14; border:1px solid var(--gray); border-radius:10px; padding:10px; text-align:center; }
    .metric .k { font-size:12px; color:var(--muted); }
    .metric .v { font-size:18px; font-weight:800; margin-top:4px; }
    .legend { display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); }
    .key { display:inline-flex; align-items:center; gap:6px; }
    .sw { width:16px; height:12px; border-radius:3px; display:inline-block; border:1px solid var(--gray); }
    .heat { background:#0b0e14; border:1px solid var(--gray); border-radius:10px; padding:10px; font:14px/1.65 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .tok { padding:1px 2px; border-radius:4px; margin:0 1px; }
    .t10   { background:var(--t10); color:#053b1a; }
    .t100  { background:var(--t100); color:#0b3d23; }
    .t1000 { background:var(--t1000); color:#3a2d00; }
    .trest { background:var(--rest); color:#5b1111; }
    .muted { color:var(--muted); }
    a { color:#7aa2ff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI Text Scanner (MVP)</h1>

    <textarea id="input" spellcheck="false" placeholder="Paste text to scan..."></textarea>

    <div class="controls">
      <button id="scanBtn">Scan</button>
      <select id="labelSel" title="Optional label for your CSV logs">
        <option value="">(no label)</option>
        <option value="ai">ai</option>
        <option value="human">human</option>
      </select>
      <span id="status" class="muted"></span>
    </div>

    <div class="row" style="align-items:flex-start; margin-top:8px;">
      <div class="card" style="flex:1; min-width:280px;">
        <div id="badge" class="badge" style="background:#555;">—</div>
        <span id="summary" class="pill"></span>
        <div id="catline" class="muted" style="margin-top:8px;"></div>
        <div id="note" class="muted" style="margin-top:6px;"></div>
      </div>
      <div class="card" style="flex:2; min-width:320px;">
        <div class="metrics">
          <div class="metric"><div class="k">Predictability</div><div id="m-score" class="v">—</div></div>
          <div class="metric"><div class="k">Top-10 %</div><div id="m-t10" class="v">—</div></div>
          <div class="metric"><div class="k">Top-100 %</div><div id="m-t100" class="v">—</div></div>
          <div class="metric"><div class="k">Perplexity</div><div id="m-ppl" class="v">—</div></div>
          <div class="metric"><div class="k">Burstiness</div><div id="m-burst" class="v">—</div></div>
          <div class="metric"><div class="k">Model</div><div id="m-model" class="v" style="font-size:12px;">—</div></div>
          <div class="metric"><div class="k">Device</div><div id="m-dev" class="v">—</div></div>
          <div class="metric"><div class="k">Tokens</div><div id="m-tok" class="v">—</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div id="explanation" class="muted"></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="legend" style="margin-bottom:8px;">
        <span>Legend:</span>
        <span class="key"><span class="sw" style="background:var(--t10)"></span> Top-10</span>
        <span class="key"><span class="sw" style="background:var(--t100)"></span> Top-100</span>
        <span class="key"><span class="sw" style="background:var(--t1000)"></span> Top-1000</span>
        <span class="key"><span class="sw" style="background:var(--rest)"></span> Unpredictable</span>
      </div>
      <div id="heat" class="heat">Run a scan to see per-token highlights…</div>
    </div>
  </div>

  <script>
    // ===== Configure your API base (works from file:// or any static server) =====
    const API_BASE = 'http://127.0.0.1:8080'; // change if your backend runs elsewhere

    const els = {
      input: document.getElementById('input'),
      scan: document.getElementById('scanBtn'),
      labelSel: document.getElementById('labelSel'),
      status: document.getElementById('status'),
      badge: document.getElementById('badge'),
      summary: document.getElementById('summary'),
      catline: document.getElementById('catline'),
      note: document.getElementById('note'),
      mScore: document.getElementById('m-score'),
      mT10: document.getElementById('m-t10'),
      mT100: document.getElementById('m-t100'),
      mPpl: document.getElementById('m-ppl'),
      mBurst: document.getElementById('m-burst'),
      mModel: document.getElementById('m-model'),
      mDev: document.getElementById('m-dev'),
      mTok: document.getElementById('m-tok'),
      explanation: document.getElementById('explanation'),
      heat: document.getElementById('heat'),
    };

    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

    function setBadge(prob){
      let label = "Low AI-likelihood";
      let color = getCss('--green');
      if (prob >= 0.85){ label = "Almost certainly AI"; color = getCss('--red'); }
      else if (prob >= 0.70){ label = "High AI-likelihood"; color = getCss('--orange'); }
      else if (prob >= 0.50){ label = "Medium AI-likelihood"; color = getCss('--yellow'); }
      els.badge.textContent = label;
      els.badge.style.backgroundColor = color; els.badge.style.color = '#fff';
    }

    function renderHeat(tokens){
      if (!tokens || !tokens.length){ els.heat.textContent = 'No tokens (empty or too short).'; return; }
      const frag = document.createDocumentFragment();
      for (const tok of tokens){
        const span = document.createElement('span');
        span.className = 'tok ' + (tok.rank<=10?'t10':tok.rank<=100?'t100':tok.rank<=1000?'t1000':'trest');
        let t = tok.t.replace(/^Ġ/g,''); // nicer spacing for BPE
        span.textContent = t;
        frag.appendChild(span);
        frag.appendChild(document.createTextNode(' '));
      }
      els.heat.innerHTML = ''; els.heat.appendChild(frag);
    }

    function formatPct(x){ return Number.isFinite(x) ? (Math.round(x*1000)/10).toFixed(1)+'%' : '—'; }
    function formatNum(x, d=2){ return Number.isFinite(x) ? x.toFixed(d) : '—'; }

    async function doScan(){
      const text = els.input.value || '';
      const tag = els.labelSel.value || '';
      if (!text.trim()) return;

      els.scan.disabled = true;
      els.status.textContent = 'Scanning…';

      try{
        const resp = await fetch(`${API_BASE}/scan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, tag })
        });
        if (!resp.ok){
          const msg = await resp.text();
          throw new Error(`Server ${resp.status}: ${msg}`);
        }
        const data = await resp.json();
        renderResult(data);
        els.status.textContent = 'Done.';
      }catch(err){
        console.error(err);
        els.status.textContent = 'Error: ' + (err?.message ?? err);
      }finally{
        els.scan.disabled = false;
      }
    }

    function renderResult(data){
      const prob = (typeof data.calibrated_prob === 'number')
        ? data.calibrated_prob
        : (typeof data.overall_score === 'number' ? data.overall_score : 0);
      const pct = Math.round(prob * 100);
      setBadge(prob);

      els.summary.textContent =
        `Likelihood this was AI-generated: ${pct}% — ` +
        (prob >= 0.85 ? 'almost certain.' :
         prob >= 0.70 ? 'high likelihood.' :
         prob >= 0.50 ? 'moderate likelihood.' : 'low likelihood.');

      const cat = (data.category || 'other').replaceAll('_',' ');
      const cconf = data.category_conf ? Math.round(data.category_conf*100) : null;
      els.catline.textContent = `Detected style: ${cat}` + (cconf!=null ? ` (conf≈${cconf}%)` : '');
      els.note.textContent = data.category_note || '';

      els.mScore.textContent = formatNum(data.overall_score);
      const bins = data.bins || {}; const total = data.total || 1;
      const frac10 = bins[10] ? bins[10]/total : 0;
      const frac100 = bins[100] ? bins[100]/total : 0;
      els.mT10.textContent = formatPct(frac10);
      els.mT100.textContent = formatPct(frac100);
      els.mPpl.textContent = formatNum(data.ppl, 1);
      els.mBurst.textContent = formatNum(data.burstiness, 3);
      els.mModel.textContent = data.model_name || '—';
      els.mDev.textContent = data.device || '—';
      els.mTok.textContent = String(data.total ?? '—');

      els.explanation.textContent = data.explanation || '';
      renderHeat(data.per_token);
    }

    // UI bindings
    document.getElementById('scanBtn').addEventListener('click', doScan);
    document.getElementById('input').addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') doScan();
    });
  </script>
</body>
</html>
